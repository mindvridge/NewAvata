# ============================================================================
# Docker Compose for Realtime Interview Avatar System
# MuseTalk V1.5 + CosyVoice 2.0 TTS
# ============================================================================
#
# 사용법:
#   1. .env 파일 생성: cp .env.example .env
#   2. .env 파일에 OPENAI_API_KEY 설정
#   3. 빌드: docker-compose build
#   4. 실행: docker-compose up -d
#   5. 로그: docker-compose logs -f
#   6. 중지: docker-compose down
#
# ============================================================================

version: '3.8'

services:
  avatar-server:
    build:
      context: ..
      dockerfile: realtime-interview-avatar/Dockerfile
    image: realtime-avatar:latest
    container_name: avatar-server
    restart: unless-stopped

    # GPU 지원 (RTX 50 시리즈 - CUDA 12.4, PyTorch 2.5.1)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    ports:
      - "5000:5000"

    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - CUDA_VISIBLE_DEVICES=0
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - COSYVOICE_MODEL_PATH=/app/CosyVoice/pretrained_models/CosyVoice2-0.5B
      - MUSETALK_PATH=/app/MuseTalk
      - COSYVOICE_PATH=/app/CosyVoice

    volumes:
      # MuseTalk 모델 (필수)
      - ./models:/app/realtime-interview-avatar/models:ro
      - ../MuseTalk/models:/app/MuseTalk/models:ro

      # CosyVoice 모델 (필수)
      - ../CosyVoice/pretrained_models:/app/CosyVoice/pretrained_models:ro

      # 사전계산 아바타 (필수)
      - ./precomputed:/app/realtime-interview-avatar/precomputed:ro

      # 결과 및 에셋 (쓰기 가능)
      - ./results:/app/realtime-interview-avatar/results
      - ./assets:/app/realtime-interview-avatar/assets

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/v2/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 180s

    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

networks:
  default:
    driver: bridge
