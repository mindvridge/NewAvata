# ============================================================================
# Docker Compose for Realtime Interview Avatar System
# MuseTalk V1.5 + CosyVoice 2.0 TTS
# ============================================================================

version: '3.8'

services:
  # --------------------------------------------------------------------------
  # 립싱크 아바타 서버 (Flask + SocketIO)
  # --------------------------------------------------------------------------
  avatar-server:
    build:
      context: ..
      dockerfile: realtime-interview-avatar/Dockerfile
    image: realtime-avatar:latest
    container_name: avatar-server
    restart: unless-stopped

    # GPU 지원
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

    ports:
      - "5000:5000"

    environment:
      # NVIDIA GPU 설정
      - NVIDIA_VISIBLE_DEVICES=all
      - CUDA_VISIBLE_DEVICES=0

      # API 키 (.env 파일에서 로드)
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY:-}

      # 모델 경로
      - COSYVOICE_MODEL_PATH=/app/CosyVoice/pretrained_models/CosyVoice2-0.5B

    volumes:
      # 모델 파일 (호스트에서 마운트 - 읽기 전용)
      - ./models:/app/realtime-interview-avatar/models:ro
      - ./precomputed:/app/realtime-interview-avatar/precomputed:ro
      - ../CosyVoice/pretrained_models:/app/CosyVoice/pretrained_models:ro
      - ../MuseTalk/models:/app/MuseTalk/models:ro

      # 결과 및 에셋 (쓰기 가능)
      - ./results:/app/realtime-interview-avatar/results
      - ./assets:/app/realtime-interview-avatar/assets

      # 환경 설정
      - ./.env:/app/realtime-interview-avatar/.env:ro

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/v2/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 180s  # 모델 로딩 시간 고려

    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

    networks:
      - avatar-network

  # --------------------------------------------------------------------------
  # Redis (선택적) - 세션 캐싱
  # --------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: avatar-redis
    restart: unless-stopped
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - avatar-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - with-redis

  # --------------------------------------------------------------------------
  # Nginx (선택적) - 리버스 프록시
  # --------------------------------------------------------------------------
  nginx:
    image: nginx:alpine
    container_name: avatar-nginx
    restart: unless-stopped
    depends_on:
      - avatar-server
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/ssl:/etc/nginx/ssl:ro
    networks:
      - avatar-network
    profiles:
      - production

# ============================================================================
# Networks
# ============================================================================
networks:
  avatar-network:
    driver: bridge

# ============================================================================
# Volumes
# ============================================================================
volumes:
  redis_data:
    driver: local

# ============================================================================
# 사용 방법
# ============================================================================
#
# 1. 환경 변수 설정:
#    cp .env.example .env
#    # .env 파일에 API 키 추가
#
# 2. 빌드:
#    docker-compose build
#
# 3. 시작:
#    docker-compose up -d
#
# 4. 로그 확인:
#    docker-compose logs -f avatar-server
#
# 5. 중지:
#    docker-compose down
#
# 6. Redis 포함:
#    docker-compose --profile with-redis up -d
#
# 7. Nginx 포함 (프로덕션):
#    docker-compose --profile production up -d
#
# 8. API 테스트:
#    curl http://localhost:5000/api/v2/status
#
# 9. 립싱크 생성:
#    curl -X POST http://localhost:5000/api/v2/lipsync \
#      -H "Content-Type: application/json" \
#      -d '{"text": "안녕하세요", "avatar": "your_avatar_name"}'
#
# ============================================================================
