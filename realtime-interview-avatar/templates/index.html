<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë©´ì ‘ê´€</title>
    <link rel="icon" href="data:,">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            width: 1600px;  /* ê³ ì • ë„ˆë¹„ */
            max-width: 100vw;
            margin: 0 auto;
            padding: 40px;
            box-sizing: border-box;
        }

        header {
            text-align: center;
            padding: 20px 0;
        }

        header h1 {
            font-size: 3em;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        header p {
            color: #888;
            font-size: 1.4em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 420px 1fr;  /* ì™¼ìª½ íŒ¨ë„ ê³ ì • ë„ˆë¹„ */
            gap: 40px;
            margin-top: 30px;
            width: 100%;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 24px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;  /* ë‚´ë¶€ ì½˜í…ì¸ ê°€ íŒ¨ë„ì„ ë„˜ì§€ ì•Šë„ë¡ */
        }

        /* ì™¼ìª½ íŒ¨ë„ (ì„¤ì •) - ê³ ì • ë„ˆë¹„ */
        .panel:first-child {
            width: 420px;
            min-width: 420px;
            max-width: 420px;
            box-sizing: border-box;
        }

        .panel h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #00d2ff;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #aaa;
            font-size: 1.2em;
        }

        select, button:not(.send-btn) {
            width: 100%;
            padding: 16px 24px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s;
        }

        /* send-btn ê¸°ë³¸ ìŠ¤íƒ€ì¼ (width ì œì™¸) */
        button.send-btn {
            padding: 16px 24px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s;
        }

        select:hover, select:focus {
            border-color: #00d2ff;
            outline: none;
        }

        select option {
            background: #1a1a2e;
            color: #fff;
        }

        button.primary {
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            border: none;
            font-weight: bold;
        }

        button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 210, 255, 0.4);
        }

        button.primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        button.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tts-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 20px;
            background: rgba(0, 210, 255, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(0, 210, 255, 0.3);
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .tts-options .form-group {
            margin-bottom: 0;
        }

        .tts-options label {
            font-size: 1em;
            color: #00d2ff;
        }

        .tts-options select {
            padding: 12px 16px;
            font-size: 1em;
        }

        /* ëŒ€í™” ì˜ì—­ */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 300px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            margin-bottom: 20px;
            overflow: hidden;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 12px;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.user {
            background: linear-gradient(90deg, #3a7bd5, #00d2ff);
            margin-left: auto;
            text-align: right;
        }

        .chat-message.assistant {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chat-message.system {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.3);
            text-align: center;
            max-width: 100%;
            font-size: 0.9em;
            color: #ffc107;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            box-sizing: border-box;
            flex-wrap: nowrap;  /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }

        .chat-input {
            flex: 1 1 auto;
            min-width: 0;  /* flex itemì´ ì¶•ì†Œë  ìˆ˜ ìˆë„ë¡ */
            width: auto;  /* inputì€ select/button ê·œì¹™ ì ìš© ì•ˆë¨ */
            padding: 14px 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1.1em;
            font-family: inherit;
            box-sizing: border-box;
        }

        .chat-input:focus {
            border-color: #00d2ff;
            outline: none;
        }

        .chat-input::placeholder {
            color: #666;
        }

        .send-btn {
            width: 120px;  /* ê³ ì • ë„ˆë¹„ - "ì „ì†¡"ê³¼ "ìƒì„± ì¤‘..." ëª¨ë‘ ìˆ˜ìš© */
            min-width: 120px;
            max-width: 120px;
            padding: 14px 20px;
            white-space: nowrap;
            text-align: center;
            flex-shrink: 0;  /* ì¶•ì†Œ ë°©ì§€ */
            flex-grow: 0;    /* í™•ëŒ€ ë°©ì§€ */
            box-sizing: border-box;
        }

        /* ë¹„ë””ì˜¤ ì˜ì—­ - ë°˜ì‘í˜• (ë¹„ìœ¨ 1.75:1 ìœ ì§€) */
        .video-container {
            position: relative;
            background: #000;
            border-radius: 24px;
            overflow: hidden;
            /* ë°˜ì‘í˜•: íŒ¨ë„ ë„ˆë¹„ì— ë§ì¶¤, ë¹„ìœ¨ ìœ ì§€ */
            width: 100%;
            aspect-ratio: 1268 / 724;  /* 1.75:1 ë¹„ìœ¨ ìœ ì§€ */
            margin: 0 auto;
        }

        /* í•´ìƒë„ í´ë˜ìŠ¤ëŠ” ì„œë²„ ì¶œë ¥ìš©ìœ¼ë¡œë§Œ ì‚¬ìš© */

        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: fill;  /* ì»¨í…Œì´ë„ˆì— ë§ì¶¤ */
        }

        #idleVideo, #resultVideo, #streamCanvas {
            animation: none !important;
        }

        #idleVideo {
            z-index: 2;
            opacity: 1 !important;
            /* idleì€ í•­ìƒ ë³´ì´ê³  ì¬ìƒ - ì ˆëŒ€ ìˆ¨ê¸°ì§€ ì•ŠìŒ */
        }

        #resultVideo {
            z-index: 3;
            opacity: 0;
            transition: opacity 0.25s ease-in-out;
            /* resultVideoê°€ ìœ„ì— ì˜¤ë²„ë ˆì´ë˜ì–´ idleì„ ê°€ë¦¼ - ë¶€ë“œëŸ¬ìš´ ì „í™˜ */
            /* í¬ë¡­ ëª¨ë“œ: ì¤‘ì•™ ì •ë ¬ (left ê°’ì€ JSì—ì„œ ë™ì  ì„¤ì •) */
        }

        /* í¬ë¡­ ëª¨ë“œì¼ ë•Œ resultVideo ìœ„ì¹˜ (ì¤‘ì•™ ë©´ì ‘ê´€ ì˜ì—­) */
        /* ìœ„ì¹˜ì™€ í¬ê¸°ëŠ” JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ê³„ì‚°í•˜ì—¬ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ì„¤ì • */
        #resultVideo.center-crop {
            max-width: none !important;
            object-fit: fill !important;  /* ì§€ì •ëœ width/heightì— ì •í™•íˆ ë§ì¶¤ */
        }

        #streamCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 4;
            visibility: hidden;
            background: transparent;
        }

        .video-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
            font-size: 1.8em;
        }

        .progress-container {
            margin-top: 20px;
        }

        .progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            width: 0%;
            transition: width 0.3s;
        }

        .status-text {
            margin-top: 15px;
            font-size: 1.2em;
            color: #888;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .elapsed-time {
            color: #00d2ff;
            font-weight: bold;
            font-size: 1.3em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: bold;
            color: #00d2ff;
        }

        .stat-label {
            font-size: 1em;
            color: #888;
            margin-top: 5px;
        }

        .clear-btn {
            margin-top: 15px;
            padding: 12px 20px;
            font-size: 1em;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            width: 100%;
            box-sizing: border-box;
        }

        .button-group button {
            flex: 1;
        }

        /* í”„ë¡¬í”„íŠ¸ ì„¤ì • ì˜ì—­ */
        .prompt-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .prompt-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 10px 0;
        }

        .prompt-toggle h3 {
            color: #00d2ff;
            font-size: 1.2em;
        }

        .prompt-toggle-icon {
            font-size: 1.5em;
            color: #888;
            transition: transform 0.3s;
        }

        .prompt-toggle-icon.open {
            transform: rotate(180deg);
        }

        .prompt-content {
            display: none;
            margin-top: 15px;
        }

        .prompt-content.open {
            display: block;
        }

        .prompt-textarea {
            width: 100%;
            min-height: 120px;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
        }

        .prompt-textarea:focus {
            border-color: #00d2ff;
            outline: none;
        }

        .prompt-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .prompt-actions button {
            flex: 1;
            padding: 10px 16px;
            font-size: 0.95em;
        }

        .prompt-status {
            margin-top: 10px;
            font-size: 0.9em;
            color: #4caf50;
            display: none;
        }

        /* LLM ìƒíƒœ í‘œì‹œ */
        .llm-status-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .llm-status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            font-size: 0.9em;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .llm-status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .llm-status-dot.online {
            background: #4caf50;
            box-shadow: 0 0 8px #4caf50;
        }

        .llm-status-dot.offline {
            background: #f44336;
            box-shadow: 0 0 8px #f44336;
            animation: none;
        }

        .llm-status-dot.checking {
            background: #ff9800;
            box-shadow: 0 0 8px #ff9800;
        }

        .llm-status-dot.not_configured {
            background: #9e9e9e;
            box-shadow: none;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .llm-status-name {
            color: #ccc;
        }

        .llm-status-latency {
            color: #888;
            font-size: 0.85em;
        }

        .llm-status-active {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
        }

        /* í ìƒíƒœ í‘œì‹œ */
        .queue-status {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background: rgba(255, 152, 0, 0.15);
            border: 1px solid rgba(255, 152, 0, 0.4);
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .queue-status.visible {
            display: flex;
        }

        .queue-position {
            font-size: 2.5em;
            font-weight: bold;
            color: #ff9800;
            min-width: 60px;
            text-align: center;
        }

        .queue-info {
            flex: 1;
        }

        .queue-message {
            font-size: 1.1em;
            color: #fff;
            margin-bottom: 5px;
        }

        .queue-wait-time {
            font-size: 0.9em;
            color: #aaa;
        }

        .queue-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 152, 0, 0.3);
            border-top-color: #ff9800;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AI Interview</h1>
            <p>AI ë©´ì ‘ê´€ê³¼ ì‹¤ì‹œê°„ ë©´ì ‘ ì—°ìŠµ</p>
            <div class="nav-links" style="margin: 15px 0;">
                <a href="/" style="color: #00d2ff; text-decoration: none; margin: 0 15px;">ë©´ì ‘ ì‹œë®¬ë ˆì´ì…˜</a>
                <a href="/record" style="color: #feca57; text-decoration: none; margin: 0 15px;">ğŸ¬ ì˜ìƒ ë…¹í™”</a>
            </div>
            <!-- LLM ìƒíƒœ í‘œì‹œ ì œê±°ë¨ -->
        </header>

        <div class="main-content">
            <div class="panel">
                <h2>ë©´ì ‘</h2>

                <div class="tts-options">
                    <div class="form-group">
                        <label>TTS ì—”ì§„</label>
                        <select id="ttsEngineSelect" onchange="updateVoiceOptions()">
                            <option value="">ë¡œë”© ì¤‘...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ìŒì„±</label>
                        <select id="ttsVoiceSelect">
                            <option value="">ì—”ì§„ ì„ íƒ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ì¶œë ¥ í•´ìƒë„</label>
                        <select id="resolutionSelect">
                            <option value="720p" selected>720p (ê³ í’ˆì§ˆ)</option>
                            <option value="480p">480p (ê· í˜•)</option>
                            <option value="360p">360p (ë¹ ë¥¸ ì‘ë‹µ)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ì‘ë‹µ ì†ë„</label>
                        <select id="speedModeSelect">
                            <option value="quality" selected>ê³ í’ˆì§ˆ (ëŠë¦¼)</option>
                            <option value="balanced">ê· í˜•</option>
                            <option value="fast">ë¹ ë¥¸ ì‘ë‹µ (ê¶Œì¥)</option>
                            <option value="realtime">ì‹¤ì‹œê°„ (ìµœì €í’ˆì§ˆ)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ì±„íŒ… ëª¨ë“œ</label>
                        <select id="chatModeSelect" onchange="updateChatModeUI()">
                            <option value="direct" selected>ì§ì ‘ ì…ë ¥ (í…ìŠ¤íŠ¸â†’ë¦½ì‹±í¬)</option>
                            <option value="chat">AI ëŒ€í™” (LLMâ†’ë¦½ì‹±í¬)</option>
                        </select>
                    </div>
                </div>

                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message system">
                            ì„œë²„ì— ì—°ê²° ì¤‘ì…ë‹ˆë‹¤...
                        </div>
                    </div>
                    <!-- ì˜ˆì‹œ í…ìŠ¤íŠ¸ ì„ íƒ -->
                    <div class="example-text-container" style="margin-bottom: 10px;">
                        <select id="exampleTextSelect" onchange="selectExampleText()" style="width: 100%; padding: 8px 12px; border-radius: 8px; border: 1px solid #333; background: #1e1e1e; color: #fff; font-size: 0.9rem;">
                            <option value="">í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ ì„ íƒ...</option>
                            <option value="ì•ˆë…•í•˜ì„¸ìš”">ì§§ì€ ì¸ì‚¬ (1ë¬¸ì¥)</option>
                            <option value="ì•ˆë…•í•˜ì„¸ìš”. ë§Œë‚˜ì„œ ë°˜ê°‘ìŠµë‹ˆë‹¤.">ê¸°ë³¸ ì¸ì‚¬ (2ë¬¸ì¥)</option>
                            <option value="ì•ˆë…•í•˜ì„¸ìš”. ì €ëŠ” AI ë©´ì ‘ê´€ì…ë‹ˆë‹¤. ì˜¤ëŠ˜ ë©´ì ‘ì— ì°¸ì„í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.">ê¸´ ì¸ì‚¬ (3ë¬¸ì¥)</option>
                            <option value="ìê¸°ì†Œê°œë¥¼ í•´ ì£¼ì‹œê² ì–´ìš”?">ë©´ì ‘ ì§ˆë¬¸ - ìê¸°ì†Œê°œ</option>
                            <option value="ì§€ì› ë™ê¸°ì— ëŒ€í•´ ë§ì”€í•´ ì£¼ì„¸ìš”.">ë©´ì ‘ ì§ˆë¬¸ - ì§€ì› ë™ê¸°</option>
                            <option value="ë³¸ì¸ì˜ ê°•ì ê³¼ ì•½ì ì— ëŒ€í•´ ë§ì”€í•´ ì£¼ì„¸ìš”.">ë©´ì ‘ ì§ˆë¬¸ - ê°•ì /ì•½ì </option>
                            <option value="5ë…„ í›„ ìì‹ ì˜ ëª¨ìŠµì„ ì–´ë–»ê²Œ ê·¸ë¦¬ê³  ê³„ì‹ ê°€ìš”?">ë©´ì ‘ ì§ˆë¬¸ - ë¯¸ë˜ ë¹„ì „</option>
                            <option value="ë§ˆì§€ë§‰ìœ¼ë¡œ í•˜ê³  ì‹¶ì€ ë§ì”€ì´ ìˆìœ¼ì‹ ê°€ìš”?">ë©´ì ‘ ì§ˆë¬¸ - ë§ˆë¬´ë¦¬</option>
                            <option value="ë„¤, ì¢‹ì€ ë‹µë³€ ê°ì‚¬í•©ë‹ˆë‹¤. ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ ë„˜ì–´ê°€ê² ìŠµë‹ˆë‹¤.">ë©´ì ‘ê´€ í”¼ë“œë°±</option>
                            <option value="ì˜¤ëŠ˜ ë©´ì ‘ì€ ì—¬ê¸°ê¹Œì§€ì…ë‹ˆë‹¤. ê²°ê³¼ëŠ” ì¶”í›„ ê°œë³„ ì—°ë½ ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.">ë©´ì ‘ ì¢…ë£Œ ë©˜íŠ¸</option>
                        </select>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="chatInput"
                               placeholder="ì„œë²„ ì—°ê²° ì¤‘..."
                               onkeypress="handleKeyPress(event)" disabled>
                        <button class="primary send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                            ì—°ê²° ì¤‘...
                        </button>
                    </div>
                </div>

                <div class="button-group">
                    <button class="primary" id="startInterviewBtn" onclick="startInterview()" disabled>
                        ì—°ê²° ì¤‘...
                    </button>
                    <button class="secondary" onclick="clearHistory()">
                        ì´ˆê¸°í™”
                    </button>
                </div>

                <!-- í”„ë¡¬í”„íŠ¸ ì„¤ì • ì„¹ì…˜ -->
                <div class="prompt-section">
                    <div class="prompt-toggle" onclick="togglePrompt()">
                        <h3>ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì„¤ì •</h3>
                        <span class="prompt-toggle-icon" id="promptToggleIcon">â–¼</span>
                    </div>
                    <div class="prompt-content" id="promptContent">
                        <textarea class="prompt-textarea" id="promptTextarea"
                                  placeholder="AI ë©´ì ‘ê´€ì˜ ì—­í• ê³¼ í–‰ë™ì„ ì •ì˜í•˜ì„¸ìš”..."></textarea>
                        <div class="prompt-actions">
                            <button class="primary" onclick="savePrompt()">ì €ì¥</button>
                            <button class="secondary" onclick="resetPrompt()">ê¸°ë³¸ê°’</button>
                        </div>
                        <div class="prompt-status" id="promptStatus">í”„ë¡¬í”„íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2>ë©´ì ‘ê´€</h2>

                <div class="video-container resolution-720p">
                    <video id="idleVideo" src="/assets/720p/idle_long.mp4" loop muted autoplay playsinline></video>
                    <canvas id="streamCanvas"></canvas>
                    <video id="resultVideo" playsinline></video>
                    <audio id="streamAudio" style="display: none;"></audio>
                </div>

                <!-- í ìƒíƒœ í‘œì‹œ -->
                <div class="queue-status" id="queueStatus">
                    <div class="queue-spinner"></div>
                    <div class="queue-position" id="queuePosition">-</div>
                    <div class="queue-info">
                        <div class="queue-message" id="queueMessage">ëŒ€ê¸° ì¤‘...</div>
                        <div class="queue-wait-time" id="queueWaitTime"></div>
                    </div>
                </div>

                <div class="progress-container" id="progressContainer" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="status-text">
                        <span id="statusText">ì¤€ë¹„ ì¤‘...</span>
                        <span id="elapsedTime" class="elapsed-time"></span>
                    </div>
                </div>

                <div class="stats" id="statsContainer" style="display: none;">
                    <div class="stat-item">
                        <div class="stat-value" id="statLLM">-</div>
                        <div class="stat-label">LLM (ì´ˆ)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statTTS">-</div>
                        <div class="stat-label">TTS (ì´ˆ)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statTotal">-</div>
                        <div class="stat-label">ì´ ì‹œê°„ (ì´ˆ)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let isGenerating = false;
        let ttsEngines = {};
        let llmStartTime = null;
        let isVideoPlaying = false;  // ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘ í”Œë˜ê·¸
        let isStreaming = false;  // ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ í”Œë˜ê·¸
        let streamingMode = true;  // true: ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ, false: ê¸°ì¡´ ëª¨ë“œ
        let streamCtx = null;  // Canvas context
        let streamFps = 25;  // ìŠ¤íŠ¸ë¦¬ë° FPS
        let clientSid = null;  // í´ë¼ì´ì–¸íŠ¸ ì„¸ì…˜ ID
        let chatMode = 'direct';  // 'direct' ë˜ëŠ” 'chat' (AI ëŒ€í™”)

        // ëŒ€ê¸° ì¤‘ ì˜ìƒ ê´€ë ¨ ë³€ìˆ˜ (idle_short ì‚¬ìš©)
        let isWaitingVideoPlaying = false;  // ëŒ€ê¸° ì˜ìƒ ì¬ìƒ ì¤‘ í”Œë˜ê·¸
        let shouldStopWaiting = false;  // ëŒ€ê¸° ì˜ìƒ ì¤‘ì§€ í”Œë˜ê·¸

        // í˜„ì¬ í•´ìƒë„ì— ë§ëŠ” ì˜ìƒ ê²½ë¡œ ë°˜í™˜
        function getResolutionVideoPath(filename) {
            const resolution = document.getElementById('resolutionSelect').value;
            return `/assets/${resolution}/${filename}`;
        }

        // ëŒ€ê¸° ì˜ìƒ ì‹œì‘ í•¨ìˆ˜ (idle_short ì‚¬ìš©)
        function startWaitingVideo() {
            if (isWaitingVideoPlaying || isVideoPlaying) return;

            const resultVideo = document.getElementById('resultVideo');
            const waitingVideo = getResolutionVideoPath('idle_short.mp4');
            console.log('Starting waiting video:', waitingVideo);

            isWaitingVideoPlaying = true;
            shouldStopWaiting = false;

            // í¬ë¡­ ëª¨ë“œ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
            resultVideo.classList.remove('center-crop');
            resultVideo.style.left = '';
            resultVideo.style.top = '';
            resultVideo.style.width = '';
            resultVideo.style.height = '';
            resultVideo.style.transform = '';

            // resultVideoë¥¼ ëŒ€ê¸° ì˜ìƒìœ¼ë¡œ ì‚¬ìš©
            resultVideo.src = waitingVideo + '?' + Date.now();
            resultVideo.muted = true;
            resultVideo.style.opacity = '0';

            resultVideo.oncanplaythrough = () => {
                resultVideo.oncanplaythrough = null;
                if (shouldStopWaiting) {
                    isWaitingVideoPlaying = false;
                    return;
                }
                resultVideo.style.opacity = '1';
                resultVideo.play().catch(err => {
                    console.error('Waiting video play failed:', err);
                    isWaitingVideoPlaying = false;
                });
            };

            resultVideo.onended = () => {
                if (shouldStopWaiting || !isGenerating) {
                    resultVideo.style.opacity = '0';
                    isWaitingVideoPlaying = false;
                    return;
                }

                // ê³„ì† ìƒì„± ì¤‘ì´ë©´ ëŒ€ê¸° ì˜ìƒ ë°˜ë³µ ì¬ìƒ
                console.log('Looping waiting video');
                resultVideo.currentTime = 0;
                resultVideo.play().catch(err => {
                    console.error('Waiting video loop failed:', err);
                    isWaitingVideoPlaying = false;
                });
            };

            resultVideo.load();
        }

        // ëŒ€ê¸° ì˜ìƒ ì¤‘ì§€ í•¨ìˆ˜
        function stopWaitingVideo() {
            shouldStopWaiting = true;
            const resultVideo = document.getElementById('resultVideo');

            if (isWaitingVideoPlaying) {
                console.log('Stopping waiting video');
                resultVideo.style.opacity = '0';

                setTimeout(() => {
                    isWaitingVideoPlaying = false;
                    resultVideo.pause();
                    resultVideo.onended = null;
                    resultVideo.oncanplaythrough = null;
                }, 250);
            }
        }

        // WebSocket ì´ë²¤íŠ¸
        socket.on('connect', () => {
            console.log('Connected to server');
        });

        // ì„œë²„ë¡œë¶€í„° SID ìˆ˜ì‹ 
        socket.on('connected', (data) => {
            clientSid = data.sid;
            console.log('Client SID:', clientSid);
            // ì—°ê²° ì™„ë£Œ ì‹œ UI í™œì„±í™”
            document.getElementById('chatInput').disabled = false;
            document.getElementById('chatInput').placeholder = 'ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”...';
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('sendBtn').textContent = 'ì „ì†¡';
            document.getElementById('startInterviewBtn').disabled = false;
            document.getElementById('startInterviewBtn').textContent = 'ë©´ì ‘ ì‹œì‘';
            // ì—°ê²° ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML = '<div class="chat-message system">ì„œë²„ ì—°ê²° ì™„ë£Œ! "ë©´ì ‘ ì‹œì‘" ë²„íŠ¼ì„ ëˆŒëŸ¬ ë©´ì ‘ì„ ì‹œì‘í•˜ì„¸ìš”</div>';
        });

        // ì—°ê²° ëŠê¹€ ì²˜ë¦¬
        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            clientSid = null;
            document.getElementById('chatInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('startInterviewBtn').disabled = true;
            addMessage('system', 'ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        });

        // í ìƒíƒœ ì—…ë°ì´íŠ¸
        socket.on('queue_update', (data) => {
            const queueStatus = document.getElementById('queueStatus');
            const queuePosition = document.getElementById('queuePosition');
            const queueMessage = document.getElementById('queueMessage');
            const queueWaitTime = document.getElementById('queueWaitTime');

            if (data.position === 0) {
                // ì²˜ë¦¬ ì¤‘ - í ìƒíƒœ ìˆ¨ê¸°ê³  ì§„í–‰ ìƒíƒœ í‘œì‹œ
                queueStatus.classList.remove('visible');
                document.getElementById('progressContainer').style.display = 'block';
            } else if (data.position > 0) {
                // ëŒ€ê¸° ì¤‘ - í ìƒíƒœ í‘œì‹œ
                queueStatus.classList.add('visible');
                queuePosition.textContent = data.position;
                queueMessage.textContent = data.message || `ëŒ€ê¸°ì—´ ${data.position}ë²ˆì§¸`;

                if (data.wait_time !== undefined) {
                    queueWaitTime.textContent = `ëŒ€ê¸° ì‹œê°„: ${data.wait_time.toFixed(0)}ì´ˆ`;
                } else {
                    queueWaitTime.textContent = '';
                }
            }

            console.log('Queue update:', data);
        });

        socket.on('status', (data) => {
            document.getElementById('statusText').textContent = data.message;
            document.getElementById('progressFill').style.width = data.progress + '%';

            if (data.elapsed !== undefined) {
                const elapsed = data.elapsed;
                const seconds = elapsed.toFixed(1);
                document.getElementById('elapsedTime').textContent = `${seconds}ì´ˆ`;
            }
        });

        socket.on('complete', (data) => {
            console.log('[complete ì´ë²¤íŠ¸ ìˆ˜ì‹ ]', data);
            isGenerating = false;
            updateUIState(false);

            // í ìƒíƒœ ìˆ¨ê¸°ê¸°
            document.getElementById('queueStatus').classList.remove('visible');

            if (data.total_time !== undefined) {
                document.getElementById('elapsedTime').textContent = `ì™„ë£Œ: ${data.total_time.toFixed(1)}ì´ˆ`;
            } else if (data.elapsed !== undefined) {
                document.getElementById('elapsedTime').textContent = `ì™„ë£Œ: ${data.elapsed.toFixed(1)}ì´ˆ`;
            }

            // ì´ë¯¸ ë¦½ì‹±í¬ ë¹„ë””ì˜¤ê°€ ì¬ìƒ ì¤‘ì´ë©´ ë¬´ì‹œ (ì¤‘ë³µ ë°©ì§€)
            if (isVideoPlaying && !isWaitingVideoPlaying) {
                console.log('Lipsync video already playing, ignoring duplicate complete event');
                return;
            }

            const idleVideo = document.getElementById('idleVideo');
            const resultVideo = document.getElementById('resultVideo');
            // video_urlì´ ì „ì²´ URLì´ë©´ ìƒëŒ€ ê²½ë¡œë¡œ ë³€í™˜ (ë¡œì»¬ ì„œë²„ ì ‘ê·¼ìš©)
            let videoUrl = data.video_url || '/video/output_with_audio.mp4';
            if (videoUrl.includes('://')) {
                try {
                    const urlObj = new URL(videoUrl);
                    videoUrl = urlObj.pathname;  // /video/xxx.mp4
                    console.log('[video_url ë³€í™˜] ì „ì²´ URL â†’ ìƒëŒ€ ê²½ë¡œ:', videoUrl);
                } catch (e) {
                    console.warn('[video_url ë³€í™˜ ì‹¤íŒ¨]', e);
                }
            }

            // ëŒ€ê¸° ì˜ìƒ ì¤‘ì§€ í”Œë˜ê·¸ ì„¤ì •
            shouldStopWaiting = true;

            // ëŒ€ê¸° ì˜ìƒì´ ì¬ìƒ ì¤‘ì´ë©´ í˜ì´ë“œ ì•„ì›ƒ í›„ ë¦½ì‹±í¬ ì „í™˜
            if (isWaitingVideoPlaying) {
                console.log('Stopping waiting video, transitioning to lipsync');
                resultVideo.style.opacity = '0';

                setTimeout(() => {
                    isWaitingVideoPlaying = false;
                    resultVideo.pause();
                    resultVideo.onended = null;
                    resultVideo.oncanplaythrough = null;

                    // ë¦½ì‹±í¬ ë¹„ë””ì˜¤ ë¡œë“œ ë° ì¬ìƒ
                    loadAndPlayLipsync(resultVideo, idleVideo, videoUrl, data);
                }, 250);
            } else {
                // ëŒ€ê¸° ì˜ìƒì´ ì—†ìœ¼ë©´ ë°”ë¡œ ë¦½ì‹±í¬ ì¬ìƒ
                loadAndPlayLipsync(resultVideo, idleVideo, videoUrl, data);
            }
        });

        // ë¦½ì‹±í¬ ë¹„ë””ì˜¤ ë¡œë“œ ë° ì¬ìƒ í•¨ìˆ˜
        function loadAndPlayLipsync(resultVideo, idleVideo, videoUrl, data) {
            console.log('[loadAndPlayLipsync] í˜¸ì¶œë¨, videoUrl:', videoUrl);
            isVideoPlaying = true;

            // ì´ì „ ì¬ìƒ ì¤‘ì¸ ë¹„ë””ì˜¤ ì •ë¦¬
            resultVideo.pause();
            resultVideo.currentTime = 0;
            resultVideo.oncanplaythrough = null;
            resultVideo.ontimeupdate = null;
            resultVideo.onended = null;

            // idle ë¹„ë””ì˜¤ëŠ” í•­ìƒ ìŒì†Œê±° ìƒíƒœ ìœ ì§€
            idleVideo.muted = true;

            // í¬ë¡­ ëª¨ë“œ ì²˜ë¦¬ (ì„œë²„ì—ì„œ ì¤‘ì•™ í¬ë¡­ëœ ì˜ìƒ)
            // ê³ ì • í•´ìƒë„ ëª¨ë“œ: ì»¨í…Œì´ë„ˆì™€ ì˜ìƒ ëª¨ë‘ 1268x724 ê³ ì •
            const cropCoords = data.crop_coords;
            if (cropCoords && cropCoords.center_crop) {
                resultVideo.classList.add('center-crop');

                // ì„œë²„ì—ì„œ ì „ë‹¬ëœ í¬ë¡­ ì¢Œí‘œ (720p ê¸°ì¤€: x=456, w=355, h=724)
                const cropX = cropCoords.x;        // í¬ë¡­ ì‹œì‘ X ì¢Œí‘œ
                const cropW = cropCoords.width;    // í¬ë¡­ ë„ˆë¹„
                const cropH = cropCoords.height;   // í¬ë¡­ ë†’ì´

                // ê³ ì • í•´ìƒë„: ì»¨í…Œì´ë„ˆ = ì˜ìƒ = 1268x724
                // ìŠ¤ì¼€ì¼ = 1.0, ì˜¤í”„ì…‹ = 0
                // í¬ë¡­ ìœ„ì¹˜ = ì„œë²„ ì¢Œí‘œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                const cropLeft = cropX;
                const cropTop = 0;
                const cropWidth = cropW;
                const cropHeight = cropH;

                // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë¡œ ì •í™•í•œ ìœ„ì¹˜ ì„¤ì • (importantë¡œ CSS ì˜¤ë²„ë¼ì´ë“œ)
                resultVideo.style.setProperty('left', cropLeft + 'px', 'important');
                resultVideo.style.setProperty('top', cropTop + 'px', 'important');
                resultVideo.style.setProperty('width', cropWidth + 'px', 'important');
                resultVideo.style.setProperty('height', cropHeight + 'px', 'important');
                resultVideo.style.setProperty('transform', 'none', 'important');

                console.log(`[ë¦½ì‹±í¬] ì¤‘ì•™ í¬ë¡­ ëª¨ë“œ (ê³ ì • í•´ìƒë„):`);
                console.log(`  ì„œë²„ í¬ë¡­: x=${cropX}, w=${cropW}, h=${cropH}`);
                console.log(`  í™”ë©´ í¬ë¡­: left=${cropLeft}px, top=${cropTop}px, ${cropWidth}x${cropHeight}`);
            } else {
                resultVideo.classList.remove('center-crop');
                // ê¸°ë³¸ ìŠ¤íƒ€ì¼ ë³µì›
                resultVideo.style.left = '';
                resultVideo.style.top = '';
                resultVideo.style.width = '';
                resultVideo.style.height = '';
                resultVideo.style.transform = '';
            }

            // resultVideo ì¤€ë¹„ (opacity ê¸°ë°˜ ì „í™˜)
            resultVideo.style.opacity = '0';
            resultVideo.muted = false;
            // idle ë¹„ë””ì˜¤ëŠ” ê³„ì† ì¬ìƒ (ë°±ê·¸ë¼ìš´ë“œ)
            resultVideo.src = videoUrl + '?' + Date.now();

            // ìŒì„± ê¸¸ì´ ë¡œê·¸ (ì•„ë°”íƒ€ ì„ íƒì€ ë°±ì—”ë“œì—ì„œ ì²˜ë¦¬)
            const audioDuration = data.audio_duration || 0;
            console.log(`[ë¦½ì‹±í¬] ìŒì„± ê¸¸ì´: ${audioDuration.toFixed(1)}ì´ˆ â†’ ì˜ìƒ ëê¹Œì§€ ì¬ìƒ í›„ ì „í™˜`);

            let videoStartTime = null;

            // ë¹„ë””ì˜¤ê°€ ì¶©ë¶„íˆ ë²„í¼ë§ë˜ë©´
            resultVideo.oncanplaythrough = () => {
                resultVideo.oncanplaythrough = null;
                // ë¦½ì‹±í¬ë¥¼ ë³´ì´ê²Œ í•˜ê³  ì¬ìƒ ì‹œì‘ (idleì€ ë’¤ì—ì„œ ê³„ì† ì¬ìƒ)
                resultVideo.style.opacity = '1';
                videoStartTime = Date.now();  // ì¬ìƒ ì‹œì‘ ì‹œê°„ ê¸°ë¡
                // idleì€ opacity 1 ìœ ì§€ - ë’¤ì—ì„œ ê³„ì† ì¬ìƒë¨
                resultVideo.play().catch(err => {
                    console.error('Video play failed:', err);
                    isVideoPlaying = false;
                });
            };

            // ë¹„ë””ì˜¤ ë¡œë“œ ì˜¤ë¥˜ í•¸ë“¤ëŸ¬
            resultVideo.onerror = (e) => {
                console.error('[ë¹„ë””ì˜¤ ë¡œë“œ ì˜¤ë¥˜]', e, resultVideo.error);
                isVideoPlaying = false;
                addMessage('system', 'ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨: ' + (resultVideo.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
            };

            // ë¹„ë””ì˜¤ ë¡œë“œ ì‹œì‘
            console.log('[ë¹„ë””ì˜¤ ë¡œë“œ ì‹œì‘]', videoUrl);
            resultVideo.load();

            // ë¦½ì‹±í¬ ë¹„ë””ì˜¤ ì¢…ë£Œ ì²˜ë¦¬ í•¨ìˆ˜
            const LAST_FRAME_HOLD_TIME = 500;  // ë§ˆì§€ë§‰ í”„ë ˆì„ ìœ ì§€ ì‹œê°„ (ms)

            const handleVideoEnd = () => {
                // ë§ˆì§€ë§‰ í”„ë ˆì„ì—ì„œ ì ì‹œ ëŒ€ê¸° í›„ í˜ì´ë“œ ì•„ì›ƒ
                // (ë¹„ë””ì˜¤ëŠ” ì´ë¯¸ ëë‚¬ìœ¼ë¯€ë¡œ ë§ˆì§€ë§‰ í”„ë ˆì„ì—ì„œ ì •ì§€ ìƒíƒœ)
                setTimeout(() => {
                    // idle ì˜ìƒì„ ì²˜ìŒìœ¼ë¡œ ë¦¬ì…‹ (ë¦½ì‹±í¬ ë í”„ë ˆì„ê³¼ idle ì²« í”„ë ˆì„ ì¼ì¹˜)
                    idleVideo.currentTime = 0;

                    // resultVideo í˜ì´ë“œ ì•„ì›ƒ (idleì€ ì´ë¯¸ ë’¤ì—ì„œ ì¬ìƒ ì¤‘)
                    resultVideo.style.opacity = '0';
                    isVideoPlaying = false;

                    // í˜ì´ë“œ ì™„ë£Œ í›„ ì •ë¦¬ (300ms í›„ - ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ë³´ë‹¤ ê¸¸ê²Œ)
                    setTimeout(() => {
                        resultVideo.pause();
                        resultVideo.muted = true;
                        resultVideo.currentTime = 0;
                        resultVideo.classList.remove('center-crop');  // í¬ë¡­ í´ë˜ìŠ¤ ì œê±°
                        // ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ ì œê±° (í¬ë¡­ ëª¨ë“œì—ì„œ ì„¤ì •í•œ ê²ƒ)
                        resultVideo.style.left = '';
                        resultVideo.style.top = '';
                        resultVideo.style.width = '';
                        resultVideo.style.height = '';
                        resultVideo.style.transform = '';
                        // src ì œê±°í•˜ì§€ ì•ŠìŒ - ê²€ì •ìƒ‰ ê¹œë°•ì„ ë°©ì§€
                    }, 300);
                }, LAST_FRAME_HOLD_TIME);
            };

            // ë¦½ì‹±í¬ ë¹„ë””ì˜¤ ì™„ì „ ì¢…ë£Œ í›„ ë¶€ë“œëŸ¬ìš´ ì „í™˜
            resultVideo.onended = () => {
                const elapsedTime = videoStartTime ? (Date.now() - videoStartTime) / 1000 : 0;
                console.log(`[ë¦½ì‹±í¬] ì˜ìƒ ì¢…ë£Œ - ì¬ìƒ ì‹œê°„: ${elapsedTime.toFixed(1)}ì´ˆ`);

                // ì˜ìƒ ëë‚˜ë©´ ë°”ë¡œ ì „í™˜
                handleVideoEnd();
            };

            // í†µê³„ í‘œì‹œ
            document.getElementById('statsContainer').style.display = 'grid';
            if (data.total_time !== undefined) {
                document.getElementById('statTotal').textContent = data.total_time.toFixed(1);
            }
        }

        socket.on('error', (data) => {
            // ëŒ€ê¸° ì˜ìƒ ì¤‘ì§€
            shouldStopWaiting = true;
            isWaitingVideoPlaying = false;
            isGenerating = false;
            updateUIState(false);
            document.getElementById('queueStatus').classList.remove('visible');
            document.getElementById('statusText').textContent = 'ì˜¤ë¥˜: ' + data.message;
            addMessage('system', 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.message);

            // ì—ëŸ¬ ë°œìƒ ì‹œ resultVideo/canvas ìˆ¨ê¸°ê¸° (idleì€ CSSë¡œ í•­ìƒ opacity 1)
            const idleVideo = document.getElementById('idleVideo');
            const resultVideo = document.getElementById('resultVideo');
            const canvas = document.getElementById('streamCanvas');
            resultVideo.style.opacity = '0';
            canvas.style.visibility = 'hidden';
            // idleì€ !importantë¡œ í•­ìƒ ë³´ì„ - opacity ë³€ê²½ ë¶ˆí•„ìš”
            if (idleVideo.paused) {
                idleVideo.play().catch(err => {
                    console.error('Idle video play failed:', err);
                });
            }
            isVideoPlaying = false;
        });

        socket.on('cancelled', (data) => {
            // ëŒ€ê¸° ì˜ìƒ ì¤‘ì§€
            shouldStopWaiting = true;
            isWaitingVideoPlaying = false;
            isGenerating = false;
            updateUIState(false);
            document.getElementById('queueStatus').classList.remove('visible');
            document.getElementById('statusText').textContent = data.message;

            // ì·¨ì†Œ ì‹œ resultVideo/canvas ìˆ¨ê¸°ê¸° (idleì€ CSSë¡œ í•­ìƒ opacity 1)
            const resultVideo = document.getElementById('resultVideo');
            const canvas = document.getElementById('streamCanvas');
            const idleVideo = document.getElementById('idleVideo');
            resultVideo.style.opacity = '0';
            canvas.style.visibility = 'hidden';
            // idleì€ !importantë¡œ í•­ìƒ ë³´ì„ - opacity ë³€ê²½ ë¶ˆí•„ìš”
            if (idleVideo.paused) {
                idleVideo.play().catch(err => {
                    console.error('Idle video play failed:', err);
                });
            }
            isVideoPlaying = false;
        });

        // ========== ìŠ¤íŠ¸ë¦¬ë° ì´ë²¤íŠ¸ ==========
        socket.on('stream_status', (data) => {
            document.getElementById('statusText').textContent = data.message;
            if (data.progress !== undefined) {
                document.getElementById('progressFill').style.width = data.progress + '%';
            }
            if (data.elapsed !== undefined) {
                document.getElementById('elapsedTime').textContent = `${data.elapsed.toFixed(1)}ì´ˆ`;
            }
        });

        // ========== ìŠ¤íŠ¸ë¦¬ë° ì´ë²¤íŠ¸ (TTS ìŠ¤íŠ¸ë¦¬ë° + ë¹„ë””ì˜¤ í”„ë ˆì„) ==========
        let streamFrameBuffer = [];  // í”„ë ˆì„ ë²„í¼
        let streamAudioContext = null;  // Web Audio API ì»¨í…ìŠ¤íŠ¸
        let streamAudioSource = null;   // ì˜¤ë””ì˜¤ ì†ŒìŠ¤
        let streamAudioBuffer = null;    // ì˜¤ë””ì˜¤ ë²„í¼
        let streamAudioChunks = [];     // TTS ì˜¤ë””ì˜¤ ì²­í¬ ë°°ì—´
        let isStreamPlaying = false;     // ìŠ¤íŠ¸ë¦¬ë° ì¬ìƒ ì¤‘
        let streamPlaybackStarted = false; // ì¬ìƒì´ í•œ ë²ˆì´ë¼ë„ ì‹œì‘ë˜ì—ˆëŠ”ì§€ (ì´ì¤‘ ì¬ìƒ ë°©ì§€)
        let streamTotalFrames = 0;      // ì „ì²´ í”„ë ˆì„ ìˆ˜ (ë¦½ì‹±í¬ + ë‚¨ì€ ì›ë³¸)
        let streamAudioFrames = 0;      // ì˜¤ë””ì˜¤ ê¸°ë°˜ ë¦½ì‹±í¬ í”„ë ˆì„ ìˆ˜
        let streamSampleRate = 16000;   // ìƒ˜í”Œë ˆì´íŠ¸
        let streamAudioEndTime = 0;     // ì˜¤ë””ì˜¤ ì¢…ë£Œ ì‹œì  (performance.now)
        let streamLastRenderedFrame = -1; // ë§ˆì§€ë§‰ìœ¼ë¡œ ë Œë”ë§ëœ í”„ë ˆì„ ì¸ë±ìŠ¤
        const BUFFER_THRESHOLD = 15;    // ë²„í¼ ì„ê³„ê°’ (ë‚®ì¶¤ - ë¹ ë¥¸ ì¬ìƒ ì‹œì‘)

        socket.on('stream_start', (data) => {
            console.log('Stream start:', data);
            // resetStreamState()ëŠ” sendMessage()/startInterview()ì—ì„œ ì´ë¯¸ í˜¸ì¶œë¨
            // ì—¬ê¸°ì„œ ë‹¤ì‹œ í˜¸ì¶œí•˜ë©´ playCompleteAudio()ê°€ ì„¤ì •í•œ streamAudioë¥¼ íŒŒê´´í•¨
            streamTotalFrames = data.total_frames;
            streamAudioFrames = data.audio_frames || data.total_frames;
            streamFps = data.fps || 25;
            isStreaming = true;  // ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœë§Œ í™•ì¸
            document.getElementById('statusText').textContent =
                `ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘ (${streamTotalFrames}í”„ë ˆì„, ì˜¤ë””ì˜¤:${streamAudioFrames}í”„ë ˆì„, ${streamFps}fps)`;
        });

        // TTS ì˜¤ë””ì˜¤ ì²­í¬ ìŠ¤íŠ¸ë¦¬ë° ìˆ˜ì‹ 
        let ttsAudioChunks = [];  // TTS ì˜¤ë””ì˜¤ ì²­í¬ (Base64 ë¬¸ìì—´ ë°°ì—´)
        let ttsAudioBlob = null;  // ìµœì¢… ì˜¤ë””ì˜¤ Blob
        
        socket.on('stream_audio_chunk', (data) => {
            console.log('TTS audio chunk received, elapsed:', data.elapsed, 'is_final:', data.is_final, 'length:', data.audio?.length || 0);

            // ìƒ˜í”Œë ˆì´íŠ¸ ì €ì¥
            if (data.sample_rate) {
                streamSampleRate = data.sample_rate;
            }

            // ë¹ˆ ì²­í¬ëŠ” ì €ì¥í•˜ì§€ ì•ŠìŒ (ì™„ë£Œ ì‹ í˜¸ì¼ ìˆ˜ ìˆìŒ)
            if (data.audio && data.audio.length > 0) {
                ttsAudioChunks.push(data.audio);
                // ì²« ì²­í¬ ì¦‰ì‹œ ì¬ìƒì€ ë¹„í™œì„±í™” (ì´ì¤‘ ìŒì„± + ë¦½ì‹±í¬ ë¶ˆì¼ì¹˜ ë°©ì§€)
                // ì „ì²´ ì˜¤ë””ì˜¤ë¥¼ í”„ë ˆì„ê³¼ ë™ê¸°í™”í•˜ì—¬ ì¬ìƒ
            }

            // ìµœì¢… ì²­í¬ì¸ ê²½ìš° ì „ì²´ ì˜¤ë””ì˜¤ ì¬ìƒ
            if (data.is_final) {
                console.log('Final audio chunk, total chunks:', ttsAudioChunks.length);
                playCompleteAudio();
            }
        });

        // TTS ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ
        socket.on('stream_audio_complete', (data) => {
            console.log('TTS streaming complete, total length:', data.total_length);
            // ì´ë¯¸ stream_audio_chunkì—ì„œ is_final=trueë¡œ ì²˜ë¦¬ë¨
        });

        // ì²« ì˜¤ë””ì˜¤ ì²­í¬ ì„ì‹œ ì¬ìƒ íŠ¸ë˜í‚¹
        let firstChunkAudio = null;

        // ì²« ì˜¤ë””ì˜¤ ì²­í¬ ì¬ìƒ (ìŠ¤íŠ¸ë¦¬ë° íš¨ê³¼)
        function playFirstAudioChunk(firstChunkBase64) {
            try {
                // ì²« ì²­í¬ë¥¼ ì¦‰ì‹œ ì¬ìƒ
                const audioUrl = 'data:audio/wav;base64,' + firstChunkBase64;
                firstChunkAudio = new Audio(audioUrl);
                firstChunkAudio.preload = 'auto';

                firstChunkAudio.oncanplaythrough = () => {
                    firstChunkAudio.play().catch(err => {
                        console.error('Failed to play first chunk:', err);
                    });
                };

                firstChunkAudio.load();
            } catch (err) {
                console.error('Failed to play first audio chunk:', err);
            }
        }

        // ì™„ì „í•œ ì˜¤ë””ì˜¤ ì¬ìƒ (Web Audio APIë¡œ WAV ì²­í¬ë“¤ í•©ì¹˜ê¸°)
        async function playCompleteAudio() {
            if (ttsAudioChunks.length === 0) return;

            try {
                // ë¹ˆ ì²­í¬ í•„í„°ë§
                const validChunks = ttsAudioChunks.filter(chunk => chunk && chunk.length > 0);
                if (validChunks.length === 0) {
                    console.warn('No valid audio chunks to play');
                    return;
                }

                // ë‹¨ì¼ ì²­í¬ì¸ ê²½ìš° ì§ì ‘ ì¬ìƒ
                if (validChunks.length === 1) {
                    const audioUrl = 'data:audio/wav;base64,' + validChunks[0];
                    streamAudio = new Audio(audioUrl);
                    streamAudio.preload = 'auto';
                } else {
                    // ì—¬ëŸ¬ ì²­í¬: Web Audio APIë¡œ í•©ì¹˜ê¸°
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const decodedBuffers = [];

                    // ê° WAV ì²­í¬ë¥¼ ë””ì½”ë”©
                    for (let i = 0; i < validChunks.length; i++) {
                        try {
                            const binaryStr = atob(validChunks[i]);
                            const bytes = new Uint8Array(binaryStr.length);
                            for (let j = 0; j < binaryStr.length; j++) {
                                bytes[j] = binaryStr.charCodeAt(j);
                            }
                            const audioBuffer = await audioContext.decodeAudioData(bytes.buffer.slice(0));
                            decodedBuffers.push(audioBuffer);
                        } catch (decodeErr) {
                            console.warn(`Failed to decode chunk ${i}:`, decodeErr);
                        }
                    }

                    if (decodedBuffers.length === 0) {
                        console.error('All chunks failed to decode, falling back to last chunk');
                        // ë””ì½”ë”© ì‹¤íŒ¨ ì‹œ ë§ˆì§€ë§‰ ì²­í¬ë¥¼ ì§ì ‘ ì‚¬ìš©
                        const lastChunk = validChunks[validChunks.length - 1];
                        const fallbackUrl = 'data:audio/wav;base64,' + lastChunk;
                        streamAudio = new Audio(fallbackUrl);
                        streamAudio.preload = 'auto';
                        audioContext.close();
                        // fallback í›„ì—ë„ ì¬ìƒ ì‹œë„
                        const fbCount = streamFrameBuffer.filter(f => f).length;
                        console.log('Fallback streamAudio ready, frames:', fbCount);
                        if (fbCount >= BUFFER_THRESHOLD && !isStreamPlaying) {
                            startStreamPlayback();
                        }
                        return;
                    }

                    // AudioBufferë“¤ì„ í•©ì¹˜ê¸°
                    const totalLength = decodedBuffers.reduce((sum, buf) => sum + buf.length, 0);
                    const sampleRate = decodedBuffers[0].sampleRate;
                    const combinedBuffer = audioContext.createBuffer(1, totalLength, sampleRate);
                    const channelData = combinedBuffer.getChannelData(0);

                    let offset = 0;
                    for (const buf of decodedBuffers) {
                        channelData.set(buf.getChannelData(0), offset);
                        offset += buf.length;
                    }

                    // AudioBufferë¥¼ WAV Blobìœ¼ë¡œ ë³€í™˜
                    const wavBlob = audioBufferToWav(combinedBuffer);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    streamAudio = new Audio(audioUrl);
                    streamAudio.preload = 'auto';

                    audioContext.close();
                }

                // streamAudioê°€ ì¤€ë¹„ë˜ì—ˆìŒì„ í‘œì‹œ (stream_frame í•¸ë“¤ëŸ¬ì—ì„œ ì²´í¬)
                console.log('streamAudio ready, frames buffered:', streamFrameBuffer.filter(f => f).length);

                // ë²„í¼ê°€ ì¶©ë¶„í•˜ë©´ ì¦‰ì‹œ ì¬ìƒ ì‹œì‘
                const currentBufferCount = streamFrameBuffer.filter(f => f).length;
                if (currentBufferCount >= BUFFER_THRESHOLD && !isStreamPlaying) {
                    startStreamPlayback();
                }
                // ë²„í¼ê°€ ë¶€ì¡±í•´ë„ stream_frame í•¸ë“¤ëŸ¬ì—ì„œ streamAudio ì²´í¬í•˜ì—¬ ì‹œì‘í•¨
            } catch (err) {
                console.error('Failed to create complete audio:', err);
            }
        }

        // AudioBufferë¥¼ WAV Blobìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        function audioBufferToWav(audioBuffer) {
            const numChannels = audioBuffer.numberOfChannels;
            const sampleRate = audioBuffer.sampleRate;
            const format = 1; // PCM
            const bitDepth = 16;

            const bytesPerSample = bitDepth / 8;
            const blockAlign = numChannels * bytesPerSample;

            const data = audioBuffer.getChannelData(0);
            const samples = data.length;
            const dataSize = samples * blockAlign;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            // WAV í—¤ë” ì‘ì„±
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };

            writeString(0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, format, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * blockAlign, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitDepth, true);
            writeString(36, 'data');
            view.setUint32(40, dataSize, true);

            // ì˜¤ë””ì˜¤ ë°ì´í„° ì‘ì„±
            let offset = 44;
            for (let i = 0; i < samples; i++) {
                const sample = Math.max(-1, Math.min(1, data[i]));
                view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
                offset += 2;
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }

        // ê¸°ì¡´ stream_audio ì´ë²¤íŠ¸ (í˜¸í™˜ì„± ìœ ì§€)
        socket.on('stream_audio', (data) => {
            console.log('Stream audio received (legacy), elapsed:', data.elapsed);
            // Base64 ì˜¤ë””ì˜¤ ë°ì´í„°ë¡œ Audio ê°ì²´ ìƒì„±
            const audio = new Audio('data:audio/wav;base64,' + data.audio);
            audio.preload = 'auto';
            
            // ë²„í¼ê°€ ì¶©ë¶„í•˜ë©´ ì¬ìƒ ì‹œì‘
            const bufferCount = streamFrameBuffer.filter(f => f).length;
            if (bufferCount >= BUFFER_THRESHOLD && !isStreamPlaying) {
                streamAudio = audio;
                startStreamPlayback();
            }
        });

        socket.on('stream_frame', (data) => {
            if (!isStreaming) return;

            const canvas = document.getElementById('streamCanvas');

            // FPS ì €ì¥
            if (data.fps) streamFps = data.fps;

            // í”„ë ˆì„ì„ ë²„í¼ì— ì¶”ê°€
            const img = new Image();
            img.onload = () => {
                streamFrameBuffer[data.index] = img;

                // ì²« í”„ë ˆì„ì—ì„œ Canvas í¬ê¸° ì„¤ì •
                if (data.index === 0) {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    streamCtx = canvas.getContext('2d');
                }

                // ë²„í¼ ìƒíƒœ í‘œì‹œ
                const bufferCount = streamFrameBuffer.filter(f => f).length;
                document.getElementById('statusText').textContent =
                    `ë²„í¼ë§ ${bufferCount}/${data.total} í”„ë ˆì„`;

                // ë²„í¼ê°€ ì¶©ë¶„í•˜ê³  ì˜¤ë””ì˜¤ ì¤€ë¹„ë˜ë©´ ì¬ìƒ ì‹œì‘
                if (bufferCount >= BUFFER_THRESHOLD && streamAudio && !isStreamPlaying) {
                    startStreamPlayback();
                }
            };
            img.src = 'data:image/jpeg;base64,' + data.frame;
        });

        // ìŠ¤íŠ¸ë¦¬ë° ì¬ìƒ ì‹œì‘
        function startStreamPlayback() {
            if (isStreamPlaying || streamPlaybackStarted) return;
            isStreamPlaying = true;
            streamPlaybackStarted = true;

            // ëŒ€ê¸° ì˜ìƒ ì¤‘ì§€
            shouldStopWaiting = true;
            stopWaitingVideo();

            const canvas = document.getElementById('streamCanvas');
            const resultVideo = document.getElementById('resultVideo');

            console.log('Starting stream playback, buffer:', streamFrameBuffer.filter(f => f).length);

            // ì²« ì²­í¬ ì˜¤ë””ì˜¤ ì¤‘ì§€ (ì¤‘ë³µ ì¬ìƒ ë°©ì§€)
            if (firstChunkAudio) {
                firstChunkAudio.pause();
                firstChunkAudio = null;
            }

            // resultVideo ìˆ¨ê¸°ê¸° (ëŒ€ê¸° ì˜ìƒì´ ì—¬ê¸°ì— ìˆì„ ìˆ˜ ìˆìŒ)
            resultVideo.style.opacity = '0';

            // Canvas context í™•ì¸
            if (!streamCtx) {
                streamCtx = canvas.getContext('2d');
            }

            // Canvas í‘œì‹œ (idleì€ CSSë¡œ í•­ìƒ opacity 1 ìœ ì§€)
            canvas.style.visibility = 'visible';
            console.log('Canvas visible, size:', canvas.width, 'x', canvas.height, 'ctx:', !!streamCtx);

            document.getElementById('statusText').textContent = 'ì¬ìƒ ì¤‘...';

            // ì˜¤ë””ì˜¤ ì¬ìƒ
            streamAudio.play().then(() => {
                console.log('Audio playing, duration:', streamAudio.duration, 'fps:', streamFps);
                // ì˜¤ë””ì˜¤ ì‹œê°„ ê¸°ë°˜ í”„ë ˆì„ ë Œë”ë§
                renderStreamFrame();
            }).catch(err => {
                console.error('Audio play failed:', err);
                isStreamPlaying = false;
            });

            // ì˜¤ë””ì˜¤ ì¢…ë£Œ ì‹œ: ë‚¨ì€ ì›ë³¸ í”„ë ˆì„ì´ ìˆìœ¼ë©´ ê³„ì† ë Œë”ë§
            streamAudio.onended = () => {
                console.log('Stream audio ended, audioFrames:', streamAudioFrames, 'totalFrames:', streamTotalFrames);

                // ì˜¤ë””ì˜¤ ì¢…ë£Œ ì‹œì  ê¸°ë¡
                streamAudioEndTime = performance.now();
                // ë§ˆì§€ë§‰ìœ¼ë¡œ ë Œë”ë§ëœ ì˜¤ë””ì˜¤ í”„ë ˆì„ ì¸ë±ìŠ¤ ê¸°ë¡
                const audioEndFrameIndex = Math.min(
                    Math.floor(streamAudio.duration * streamFps),
                    streamAudioFrames - 1
                );
                streamLastRenderedFrame = audioEndFrameIndex;

                // ë‚¨ì€ ì›ë³¸ í”„ë ˆì„ì´ ìˆìœ¼ë©´ ê³„ì† ë Œë”ë§
                if (streamTotalFrames > streamAudioFrames && streamLastRenderedFrame < streamTotalFrames - 1) {
                    console.log(`ì˜¤ë””ì˜¤ ì¢…ë£Œ, ë‚¨ì€ í”„ë ˆì„ ë Œë”ë§ ì‹œì‘: ${streamLastRenderedFrame + 1} ~ ${streamTotalFrames - 1}`);
                    renderRemainingFrames();
                } else {
                    // ë‚¨ì€ í”„ë ˆì„ ì—†ìŒ - ë°”ë¡œ í˜ì´ë“œ ì•„ì›ƒ
                    console.log('ë‚¨ì€ í”„ë ˆì„ ì—†ìŒ, í˜ì´ë“œ ì•„ì›ƒ');
                    fadeOutToIdle();
                }
            };
        }

        // í”„ë ˆì„ ë Œë”ë§ (ì˜¤ë””ì˜¤ ë™ê¸°í™”)
        // ì›ë³¸ MuseTalk: ì˜¤í”„ì…‹ ì—†ì´ ì˜¤ë””ì˜¤ ì‹œê°„ê³¼ ë¹„ë””ì˜¤ í”„ë ˆì„ ì§ì ‘ ë§¤í•‘
        function renderStreamFrame() {
            if (!streamAudio || streamAudio.paused || streamAudio.ended) return;

            const currentTime = streamAudio.currentTime;
            const targetFrameIndex = Math.floor(currentTime * streamFps);

            if (streamFrameBuffer[targetFrameIndex]) {
                streamCtx.drawImage(streamFrameBuffer[targetFrameIndex], 0, 0);
            }

            requestAnimationFrame(renderStreamFrame);
        }

        // ì˜¤ë””ì˜¤ ì¢…ë£Œ í›„ ë‚¨ì€ ì›ë³¸ í”„ë ˆì„ ë Œë”ë§ (FPS ê¸°ë°˜ ì‹œê°„ ì§„í–‰)
        function renderRemainingFrames() {
            if (!streamCtx || !isStreamPlaying) return;

            const elapsed = performance.now() - streamAudioEndTime;
            const frameSincAudioEnd = Math.floor(elapsed / (1000 / streamFps));
            const targetFrame = streamLastRenderedFrame + 1 + frameSincAudioEnd;

            if (targetFrame >= streamTotalFrames) {
                // ëª¨ë“  í”„ë ˆì„ ë Œë”ë§ ì™„ë£Œ - ë§ˆì§€ë§‰ í”„ë ˆì„ í‘œì‹œ í›„ í˜ì´ë“œ ì•„ì›ƒ
                const lastIdx = streamTotalFrames - 1;
                if (streamFrameBuffer[lastIdx]) {
                    streamCtx.drawImage(streamFrameBuffer[lastIdx], 0, 0);
                }
                console.log('ëª¨ë“  í”„ë ˆì„ ë Œë”ë§ ì™„ë£Œ, í˜ì´ë“œ ì•„ì›ƒ');
                fadeOutToIdle();
                return;
            }

            // í”„ë ˆì„ì´ ì•„ì§ ë„ì°©í•˜ì§€ ì•Šì€ ê²½ìš° ëŒ€ê¸°
            if (streamFrameBuffer[targetFrame]) {
                streamCtx.drawImage(streamFrameBuffer[targetFrame], 0, 0);
            }

            requestAnimationFrame(renderRemainingFrames);
        }

        // ìº”ë²„ìŠ¤ í˜ì´ë“œ ì•„ì›ƒ â†’ idle ë¹„ë””ì˜¤ ì „í™˜
        // ë§ˆì§€ë§‰ í”„ë ˆì„ = idle ì²« í”„ë ˆì„ì´ë¯€ë¡œ í˜ì´ë“œ ì—†ì´ ì¦‰ì‹œ ì „í™˜
        function fadeOutToIdle() {
            const canvas = document.getElementById('streamCanvas');
            const idleVideo = document.getElementById('idleVideo');

            // idle ë¹„ë””ì˜¤ë¥¼ ì²˜ìŒìœ¼ë¡œ ë¦¬ì…‹ í›„ ì¦‰ì‹œ ì „í™˜
            idleVideo.currentTime = 0;
            if (idleVideo.paused) {
                idleVideo.play().catch(err => console.error('Idle play failed:', err));
            }

            // canvas ì¦‰ì‹œ ìˆ¨ê¸°ê¸°
            isStreamPlaying = false;
            canvas.style.visibility = 'hidden';
        }

        // ìŠ¤íŠ¸ë¦¬ë° ì´ˆê¸°í™” (ìƒˆ ìš”ì²­ ì‹œ)
        function resetStreamState() {
            streamFrameBuffer = [];
            streamAudio = null;
            isStreamPlaying = false;
            streamPlaybackStarted = false;  // ì¬ìƒ ì‹œì‘ í”Œë˜ê·¸ ì´ˆê¸°í™”
            streamTotalFrames = 0;
            streamAudioFrames = 0;
            streamAudioEndTime = 0;
            streamLastRenderedFrame = -1;
            isStreaming = true;
            ttsAudioChunks = [];  // TTS ì²­í¬ ì´ˆê¸°í™”
            ttsAudioBlob = null;

            // ì²« ì²­í¬ ì˜¤ë””ì˜¤ ì •ë¦¬
            if (firstChunkAudio) {
                firstChunkAudio.pause();
                firstChunkAudio = null;
            }

            const canvas = document.getElementById('streamCanvas');
            streamCtx = canvas.getContext('2d');
            canvas.style.visibility = 'hidden';
        }

        socket.on('stream_complete', (data) => {
            console.log('Stream complete:', data);
            isStreaming = false;
            isGenerating = false;
            updateUIState(false);

            // ëŒ€ê¸° ì˜ìƒ ì¤‘ì§€
            shouldStopWaiting = true;
            stopWaitingVideo();

            const elapsed = data.elapsed || data.total_time || 0;
            document.getElementById('progressFill').style.width = '100%';
            document.getElementById('elapsedTime').textContent = `ì™„ë£Œ: ${elapsed.toFixed(1)}ì´ˆ`;
            document.getElementById('statsContainer').style.display = 'grid';
            document.getElementById('statTotal').textContent = elapsed.toFixed(1);
            document.getElementById('statusText').textContent =
                `ì™„ë£Œ (${data.total_frames}í”„ë ˆì„, ${elapsed.toFixed(1)}ì´ˆ)`;

            // ìŠ¤íŠ¸ë¦¬ë° ì¬ìƒì´ ì•„ì§ ì‹œì‘ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì‹œì‘
            if (!isStreamPlaying && streamAudio && streamFrameBuffer.filter(f => f).length > 0) {
                startStreamPlayback();
            } else if (!isStreamPlaying && !streamAudio) {
                // streamAudioê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ (async ë””ì½”ë”© ì¤‘) - ëŒ€ê¸° í›„ ì¬ì‹œë„
                console.log('stream_complete: streamAudio not ready yet, waiting...');
                const retryInterval = setInterval(() => {
                    if (streamAudio && !isStreamPlaying) {
                        clearInterval(retryInterval);
                        if (streamFrameBuffer.filter(f => f).length > 0) {
                            startStreamPlayback();
                        }
                    } else if (isStreamPlaying) {
                        clearInterval(retryInterval);
                    }
                }, 100);
                // ìµœëŒ€ 5ì´ˆ ëŒ€ê¸°
                setTimeout(() => clearInterval(retryInterval), 5000);
            }

            // ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ í›„ canvas ìˆ¨ê¸°ê¸°ëŠ” ì˜¤ë””ì˜¤ ì¢…ë£Œ ì‹œ(onended) ì²˜ë¦¬ë¨
            // ì¬ìƒì´ í•œ ë²ˆë„ ì‹œì‘ë˜ì§€ ì•Šì€ ê²½ìš°ì—ë§Œ fallbackìœ¼ë¡œ canvas ìˆ¨ê¸°ê¸°
            setTimeout(() => {
                if (!isStreamPlaying && !streamPlaybackStarted) {
                    const canvas = document.getElementById('streamCanvas');
                    const idleVideo = document.getElementById('idleVideo');
                    if (idleVideo.paused) {
                        idleVideo.play().catch(err => {
                            console.error('Idle video play failed:', err);
                        });
                    }
                    canvas.style.visibility = 'hidden';
                }
            }, 3000);
        });

        socket.on('stream_error', (data) => {
            console.error('Stream error:', data);
            isStreaming = false;
            isGenerating = false;
            isStreamPlaying = false;
            updateUIState(false);

            // ëŒ€ê¸° ì˜ìƒ ì¤‘ì§€
            shouldStopWaiting = true;
            stopWaitingVideo();

            // canvas ìˆ¨ê¸°ê¸° (idleì€ CSSë¡œ í•­ìƒ opacity 1)
            const canvas = document.getElementById('streamCanvas');
            const idleVideo = document.getElementById('idleVideo');
            // idle ë¹„ë””ì˜¤ê°€ ë©ˆì¶°ìˆìœ¼ë©´ ì¬ìƒ ì‹œì‘
            if (idleVideo.paused) {
                idleVideo.play().catch(err => {
                    console.error('Idle video play failed:', err);
                });
            }
            // idleì€ !importantë¡œ í•­ìƒ ë³´ì„ - opacity ë³€ê²½ ë¶ˆí•„ìš”
            setTimeout(() => {
                canvas.style.visibility = 'hidden';
            }, 100);

            document.getElementById('statusText').textContent = 'ì˜¤ë¥˜: ' + data.message;
            addMessage('system', 'ìŠ¤íŠ¸ë¦¬ë° ì˜¤ë¥˜: ' + data.message);
        });

        // UI ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateUIState(generating) {
            document.getElementById('sendBtn').disabled = generating;
            document.getElementById('sendBtn').textContent = generating ? 'ìƒì„± ì¤‘...' : 'ì „ì†¡';
            document.getElementById('chatInput').disabled = generating;
        }

        // CosyVoice ì—°ê²° í…ŒìŠ¤íŠ¸
        async function checkCosyVoiceConnection() {
            try {
                const response = await fetch('/api/check_cosyvoice', {
                    method: 'GET',
                    timeout: 5000
                });
                const result = await response.json();

                if (!result.connected) {
                    console.error('[CosyVoice] ì—°ê²° ì‹¤íŒ¨:', result.error || 'ì„œë²„ ì‘ë‹µ ì—†ìŒ');
                    console.warn('[CosyVoice] URL:', result.url || 'N/A');
                    return false;
                }
                console.log('[CosyVoice] ì—°ê²° ì„±ê³µ');
                return true;
            } catch (e) {
                console.error('[CosyVoice] ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', e.message);
                return false;
            }
        }

        // ì˜µì…˜ ë¡œë“œ
        async function loadOptions() {
            try {
                // TTS ì—”ì§„ ë¡œë“œ
                const enginesRes = await fetch('/api/tts_engines');
                const enginesArray = await enginesRes.json();
                // ë°°ì—´ì„ id ê¸°ë°˜ ê°ì²´ë¡œ ë³€í™˜
                ttsEngines = {};
                enginesArray.forEach(engine => {
                    ttsEngines[engine.id] = engine;
                });
                const engineSelect = document.getElementById('ttsEngineSelect');
                engineSelect.innerHTML = enginesArray
                    .map(engine => {
                        const disabled = !engine.available ? ' disabled' : '';
                        const suffix = !engine.available ? ' (API í‚¤ í•„ìš”)' : '';
                        return `<option value="${engine.id}"${disabled}>${engine.name}${suffix}</option>`;
                    }).join('');

                // CosyVoice ì—°ê²° í…ŒìŠ¤íŠ¸ (1íšŒ ì‹œë„)
                const cosyvoiceEngine = enginesArray.find(e => e.id === 'cosyvoice');
                const elevenlabsEngine = enginesArray.find(e => e.id === 'elevenlabs' && e.available);

                if (cosyvoiceEngine && cosyvoiceEngine.available) {
                    const isConnected = await checkCosyVoiceConnection();
                    if (!isConnected && elevenlabsEngine) {
                        console.warn('[TTS] CosyVoice ì—°ê²° ì‹¤íŒ¨ â†’ ElevenLabsë¡œ ìë™ ì „í™˜');
                        engineSelect.value = 'elevenlabs';
                    } else if (isConnected) {
                        engineSelect.value = 'cosyvoice';
                    } else {
                        // CosyVoice ì‹¤íŒ¨í•˜ê³  ElevenLabsë„ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ê°€ëŠ¥í•œ ì—”ì§„
                        const firstAvailable = enginesArray.find(e => e.available);
                        if (firstAvailable) {
                            engineSelect.value = firstAvailable.id;
                        }
                    }
                } else {
                    // CosyVoiceê°€ ì—†ê±°ë‚˜ ì‚¬ìš© ë¶ˆê°€ â†’ ì²« ë²ˆì§¸ ì‚¬ìš© ê°€ëŠ¥í•œ ì—”ì§„
                    const firstAvailable = enginesArray.find(e => e.available);
                    if (firstAvailable) {
                        engineSelect.value = firstAvailable.id;
                    }
                }

                updateVoiceOptions();

            } catch (e) {
                console.error('Failed to load options:', e);
            }
        }

        function updateVoiceOptions() {
            const engineId = document.getElementById('ttsEngineSelect').value;
            const voiceSelect = document.getElementById('ttsVoiceSelect');

            if (!engineId || !ttsEngines[engineId]) {
                voiceSelect.innerHTML = '<option value="">ì—”ì§„ ì„ íƒ</option>';
                return;
            }

            const voices = ttsEngines[engineId].voices;
            // voicesê°€ ë°°ì—´ì¸ ê²½ìš°ì™€ ê°ì²´ì¸ ê²½ìš° ëª¨ë‘ ì²˜ë¦¬
            if (Array.isArray(voices)) {
                voiceSelect.innerHTML = voices
                    .map(voice => `<option value="${voice}">${voice}</option>`)
                    .join('');
            } else {
                voiceSelect.innerHTML = Object.entries(voices)
                    .map(([id, name]) => `<option value="${id}">${name}</option>`)
                    .join('');
            }
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(role, content) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;
            messageDiv.textContent = content;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // ì˜ˆì‹œ í…ìŠ¤íŠ¸ ì„ íƒ
        function selectExampleText() {
            const select = document.getElementById('exampleTextSelect');
            const input = document.getElementById('chatInput');
            if (select.value) {
                input.value = select.value;
                input.focus();
                // ì„ íƒ í›„ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
                select.selectedIndex = 0;
            }
        }

        // ì±„íŒ… ëª¨ë“œ UI ì—…ë°ì´íŠ¸
        function updateChatModeUI() {
            chatMode = document.getElementById('chatModeSelect').value;
            const input = document.getElementById('chatInput');
            const sendBtn = document.getElementById('sendBtn');
            const startBtn = document.getElementById('startInterviewBtn');

            if (chatMode === 'chat') {
                input.placeholder = 'ë©´ì ‘ì ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš” (AIê°€ ì‘ë‹µí•©ë‹ˆë‹¤)...';
                sendBtn.textContent = 'ì „ì†¡';
                startBtn.textContent = 'ë©´ì ‘ ì‹œì‘';
            } else {
                input.placeholder = 'ì•„ë°”íƒ€ê°€ ë§í•  ëŒ€ì‚¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
                sendBtn.textContent = 'ë¦½ì‹±í¬';
                startBtn.textContent = 'ì¸ì‚¬ ì˜ìƒ';
            }
        }

        // LLM ì±„íŒ… API í˜¸ì¶œ
        async function callChatAPI(message, clearHistory = false) {
            const systemPrompt = document.getElementById('promptTextarea').value ||
                'ë‹¹ì‹ ì€ ì¹œì ˆí•˜ê³  ì „ë¬¸ì ì¸ AI ë©´ì ‘ê´€ì…ë‹ˆë‹¤. ë©´ì ‘ìì˜ ë‹µë³€ì— ëŒ€í•´ ì ì ˆí•œ í›„ì† ì§ˆë¬¸ì„ í•˜ê±°ë‚˜ í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤. ì‘ë‹µì€ 2-3ë¬¸ì¥ ì •ë„ë¡œ ê°„ê²°í•˜ê²Œ ìœ ì§€í•˜ì„¸ìš”.';

            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    sid: clientSid,
                    system_prompt: systemPrompt,
                    clear_history: clearHistory
                })
            });

            const result = await response.json();
            if (!response.ok || !result.success) {
                throw new Error(result.error || 'LLM ìš”ì²­ ì‹¤íŒ¨');
            }

            return result;
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            if (isGenerating) return;

            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            // ì†Œì¼“ ì—°ê²° í™•ì¸
            if (!clientSid) {
                addMessage('system', 'ì„œë²„ì™€ ì—°ê²° ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            const avatarPath = 'auto';  // ìë™ ì„ íƒ
            input.value = '';

            isGenerating = true;
            updateUIState(true);
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('elapsedTime').textContent = '';

            // ëŒ€ê¸° ì˜ìƒ ì‹œì‘
            startWaitingVideo();

            let lipsyncText = message;  // ë¦½ì‹±í¬ì— ì‚¬ìš©í•  í…ìŠ¤íŠ¸

            try {
                // ì±„íŒ… ëª¨ë“œì— ë”°ë¥¸ ì²˜ë¦¬
                if (chatMode === 'chat') {
                    // AI ëŒ€í™” ëª¨ë“œ: ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ í›„ LLM í˜¸ì¶œ
                    addMessage('user', message);
                    document.getElementById('statusText').textContent = 'AI ì‘ë‹µ ìƒì„± ì¤‘...';

                    const llmStart = performance.now();
                    const chatResult = await callChatAPI(message);
                    const llmElapsed = ((performance.now() - llmStart) / 1000).toFixed(1);

                    lipsyncText = chatResult.response;
                    if (!lipsyncText || !lipsyncText.trim()) {
                        throw new Error('LLM ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤');
                    }
                    addMessage('assistant', lipsyncText);
                    document.getElementById('statLLM').textContent = `${llmElapsed}ì´ˆ (${chatResult.provider})`;
                } else {
                    // ì§ì ‘ ì…ë ¥ ëª¨ë“œ: ì…ë ¥ í…ìŠ¤íŠ¸ë¥¼ ì•„ë°”íƒ€ ëŒ€ì‚¬ë¡œ ì‚¬ìš©
                    addMessage('assistant', message);
                    document.getElementById('statLLM').textContent = '-';
                }

                if (!lipsyncText || !lipsyncText.trim()) {
                    throw new Error('ë¦½ì‹±í¬ í…ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤');
                }

                document.getElementById('statusText').textContent = 'ë¦½ì‹±í¬ ìƒì„± ì¤‘...';

                // ë¦½ì‹±í¬ ìƒì„±
                const ttsEngine = document.getElementById('ttsEngineSelect').value;
                const ttsVoice = document.getElementById('ttsVoiceSelect').value;
                const resolution = document.getElementById('resolutionSelect').value;
                const speedMode = document.getElementById('speedModeSelect').value;

                // ì†ë„ ëª¨ë“œì— ë”°ë¥¸ frame_skip ê°’ ê²°ì •
                const frameSkipMap = {
                    'quality': 1,    // ê³ í’ˆì§ˆ: ëª¨ë“  í”„ë ˆì„
                    'balanced': 2,   // ê· í˜•: 2í”„ë ˆì„ë‹¹ 1ì¶”ë¡ 
                    'fast': 3,       // ë¹ ë¦„: 3í”„ë ˆì„ë‹¹ 1ì¶”ë¡ 
                    'realtime': 3    // ì‹¤ì‹œê°„: 3í”„ë ˆì„ë‹¹ 1ì¶”ë¡ 
                };
                const frameSkip = frameSkipMap[speedMode] || 2;

                let response;
                if (streamingMode) {
                    // ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœ ì´ˆê¸°í™”
                    resetStreamState();
                    document.getElementById('statusText').textContent = 'ìŠ¤íŠ¸ë¦¬ë° ìƒì„± ì‹œì‘...';
                    response = await fetch('/api/generate_streaming', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            avatar_path: avatarPath,
                            text: lipsyncText,
                            tts_engine: ttsEngine,
                            tts_voice: ttsVoice,
                            sid: clientSid,
                            frame_skip: frameSkip,
                            resolution: resolution
                        })
                    });
                } else {
                    // ê¸°ì¡´ API ì‚¬ìš© (ì¼ë°˜ ëª¨ë“œ)
                    document.getElementById('statusText').textContent = 'ì¼ë°˜ ëª¨ë“œ - ìƒì„± ì¤‘...';
                    response = await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            avatar_path: avatarPath,
                            text: lipsyncText,
                            tts_engine: ttsEngine,
                            tts_voice: ttsVoice,
                            sid: clientSid,
                            frame_skip: frameSkip,
                            resolution: resolution
                        })
                    });
                }

                // API ì‘ë‹µ í™•ì¸
                const result = await response.json();
                if (!response.ok || result.error) {
                    throw new Error(result.error || 'ìš”ì²­ ì‹¤íŒ¨');
                }
                console.log('API ìš”ì²­ ì„±ê³µ:', result);

            } catch (e) {
                console.error('Send failed:', e);
                addMessage('system', 'ì˜¤ë¥˜: ' + e.message);
                stopWaitingVideo();
                isGenerating = false;
                updateUIState(false);
                document.getElementById('progressContainer').style.display = 'none';
            }
        }

        // ì—”í„°í‚¤ ì²˜ë¦¬
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // ë©´ì ‘ ì‹œì‘
        async function startInterview() {
            if (isGenerating) return;

            // ì†Œì¼“ ì—°ê²° í™•ì¸
            if (!clientSid) {
                addMessage('system', 'ì„œë²„ì™€ ì—°ê²° ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            const avatarPath = 'auto';  // ìë™ ì„ íƒ

            // ëŒ€í™” ì´ˆê¸°í™”
            const messagesDiv = document.getElementById('chatMessages');
            if (chatMode === 'chat') {
                messagesDiv.innerHTML = '<div class="chat-message system">ë©´ì ‘ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. AI ë©´ì ‘ê´€ì´ ì§ˆë¬¸í•˜ê³  ì‘ë‹µí•©ë‹ˆë‹¤.</div>';
                // LLM ëŒ€í™” íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
                try {
                    await fetch('/api/chat/clear', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sid: clientSid })
                    });
                } catch (e) {
                    console.warn('ëŒ€í™” íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
                }
            } else {
                messagesDiv.innerHTML = '<div class="chat-message system">ë©´ì ‘ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. ì•„ë°”íƒ€ê°€ ë§í•  ëŒ€ì‚¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>';
            }

            isGenerating = true;
            updateUIState(true);
            document.getElementById('startInterviewBtn').disabled = true;
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('statusText').textContent = 'ë©´ì ‘ê´€ ì¸ì‚¬ ìƒì„± ì¤‘...';
            document.getElementById('elapsedTime').textContent = '';
            document.getElementById('statLLM').textContent = '-';

            try {
                // ë©´ì ‘ê´€ ì²« ì¸ì‚¬ (ê³ ì • ë©”ì‹œì§€)
                const greetingMessage = 'ì•ˆë…•í•˜ì„¸ìš”, ë©´ì ‘ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤. ì§€ì›ìë¶„ì˜ ì´ì•¼ê¸°ë¥¼ ë“¤ì–´ë³¼ê²Œìš”.';

                // ë©´ì ‘ê´€ ì¸ì‚¬ í‘œì‹œ
                addMessage('assistant', greetingMessage);

                // ë¦½ì‹±í¬ ìƒì„±
                const ttsEngine = document.getElementById('ttsEngineSelect').value;
                const ttsVoice = document.getElementById('ttsVoiceSelect').value;
                const resolution = document.getElementById('resolutionSelect').value;
                const speedMode = document.getElementById('speedModeSelect').value;

                // ì†ë„ ëª¨ë“œì— ë”°ë¥¸ frame_skip ê°’ ê²°ì •
                const frameSkipMap = {
                    'quality': 1,
                    'balanced': 2,
                    'fast': 3,
                    'realtime': 3
                };
                const frameSkip = frameSkipMap[speedMode] || 2;

                let response;
                if (streamingMode) {
                    // ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœ ì´ˆê¸°í™”
                    resetStreamState();
                    document.getElementById('statusText').textContent = 'ìŠ¤íŠ¸ë¦¬ë° ìƒì„± ì‹œì‘...';
                    response = await fetch('/api/generate_streaming', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            avatar_path: avatarPath,
                            text: greetingMessage,
                            tts_engine: ttsEngine,
                            tts_voice: ttsVoice,
                            sid: clientSid,
                            frame_skip: frameSkip,
                            resolution: resolution
                        })
                    });
                } else {
                    // ê¸°ì¡´ API ì‚¬ìš© (ì¼ë°˜ ëª¨ë“œ)
                    document.getElementById('statusText').textContent = 'ì¼ë°˜ ëª¨ë“œ - ìƒì„± ì¤‘...';
                    response = await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            avatar_path: avatarPath,
                            text: greetingMessage,
                            tts_engine: ttsEngine,
                            tts_voice: ttsVoice,
                            sid: clientSid,
                            frame_skip: frameSkip,
                            resolution: resolution
                        })
                    });
                }

                // API ì‘ë‹µ í™•ì¸
                const result = await response.json();
                if (!response.ok || result.error) {
                    throw new Error(result.error || 'ìš”ì²­ ì‹¤íŒ¨');
                }
                console.log('API ìš”ì²­ ì„±ê³µ:', result);

            } catch (e) {
                console.error('Start interview failed:', e);
                addMessage('system', 'ì˜¤ë¥˜: ' + e.message);
                isGenerating = false;
                updateUIState(false);
                document.getElementById('startInterviewBtn').disabled = false;
                document.getElementById('progressContainer').style.display = 'none';
            }
        }

        // ëŒ€í™” ì´ˆê¸°í™” (UI + LLM íˆìŠ¤í† ë¦¬)
        async function clearHistory() {
            const messagesDiv = document.getElementById('chatMessages');

            // LLM ëŒ€í™” íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
            if (clientSid && chatMode === 'chat') {
                try {
                    await fetch('/api/chat/clear', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ sid: clientSid })
                    });
                } catch (e) {
                    console.warn('ëŒ€í™” íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
                }
            }

            if (clientSid) {
                messagesDiv.innerHTML = '<div class="chat-message system">"ë©´ì ‘ ì‹œì‘" ë²„íŠ¼ì„ ëˆŒëŸ¬ ë©´ì ‘ì„ ì‹œì‘í•˜ì„¸ìš”</div>';
                document.getElementById('startInterviewBtn').disabled = false;
                updateChatModeUI();  // ì±„íŒ… ëª¨ë“œì— ë”°ë¼ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            } else {
                messagesDiv.innerHTML = '<div class="chat-message system">ì„œë²„ì— ì—°ê²° ì¤‘ì…ë‹ˆë‹¤...</div>';
            }
            isGenerating = false;
            updateUIState(false);
        }

        // ========== í”„ë¡¬í”„íŠ¸ ì„¤ì • ==========
        const DEFAULT_PROMPT = `ë‹¹ì‹ ì€ ì¹œì ˆí•˜ê³  ì „ë¬¸ì ì¸ AI ë©´ì ‘ê´€ì…ë‹ˆë‹¤.
ë©´ì ‘ìì˜ ë‹µë³€ì— ëŒ€í•´ ì ì ˆí•œ í›„ì† ì§ˆë¬¸ì„ í•˜ê±°ë‚˜ í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤.
ì‘ë‹µì€ 2-3ë¬¸ì¥ ì •ë„ë¡œ ê°„ê²°í•˜ê²Œ ìœ ì§€í•˜ì„¸ìš”.`;

        function togglePrompt() {
            const content = document.getElementById('promptContent');
            const icon = document.getElementById('promptToggleIcon');
            content.classList.toggle('open');
            icon.classList.toggle('open');
        }

        // í”„ë¡¬í”„íŠ¸ ê´€ë ¨ í•¨ìˆ˜ (LLM ì œê±°ë¡œ ë¹„í™œì„±í™”)
        async function loadPrompt() {}
        async function savePrompt() {}
        function resetPrompt() {}

        // ì´ˆê¸°í™”
        loadOptions();
        loadPrompt();
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ idle ë¹„ë””ì˜¤ ì¬ìƒ í™•ì¸
        window.addEventListener('load', () => {
            const idleVideo = document.getElementById('idleVideo');
            if (idleVideo && idleVideo.paused) {
                idleVideo.play().catch(err => {
                    console.log('Idle video autoplay blocked, will play on user interaction:', err);
                });
            }
        });
        
        // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ idle ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„
        document.addEventListener('click', () => {
            const idleVideo = document.getElementById('idleVideo');
            if (idleVideo && idleVideo.paused && idleVideo.style.opacity !== '0') {
                idleVideo.play().catch(err => {
                    console.error('Idle video play failed:', err);
                });
            }
        }, { once: true });

        // í•´ìƒë„ ë³€ê²½ ì‹œ idle ë¹„ë””ì˜¤ ë° ì»¨í…Œì´ë„ˆ í¬ê¸° ì—…ë°ì´íŠ¸
        document.getElementById('resolutionSelect').addEventListener('change', function() {
            const resolution = this.value;
            const idleVideo = document.getElementById('idleVideo');
            const videoContainer = document.querySelector('.video-container');
            const currentTime = idleVideo.currentTime;
            const wasPlaying = !idleVideo.paused;

            // ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ í¬ê¸° ë³€ê²½ (ë¹„ìœ¨ 1.75:1 ìœ ì§€)
            videoContainer.classList.remove('resolution-720p', 'resolution-480p', 'resolution-360p');
            videoContainer.classList.add(`resolution-${resolution}`);
            console.log(`[í•´ìƒë„ ë³€ê²½] ì»¨í…Œì´ë„ˆ í¬ê¸°: ${resolution}`);

            // í•´ìƒë„ë³„ idle ì˜ìƒ ê²½ë¡œ
            const newSrc = `/assets/${resolution}/idle_long.mp4`;
            console.log(`[í•´ìƒë„ ë³€ê²½] ${resolution} â†’ ${newSrc}`);

            // ì˜ìƒ ë³€ê²½ (í˜„ì¬ ì¬ìƒ ì‹œê°„ ìœ ì§€)
            idleVideo.src = newSrc;
            idleVideo.load();

            idleVideo.onloadeddata = () => {
                idleVideo.currentTime = currentTime;
                if (wasPlaying) {
                    idleVideo.play().catch(err => {
                        console.error('Idle video play failed after resolution change:', err);
                    });
                }
            };

            // í•´ìƒë„ë³„ ì˜ìƒì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ê²½ë¡œë¡œ í´ë°±
            idleVideo.onerror = () => {
                console.log(`[í•´ìƒë„ ë³€ê²½] ${resolution} ì˜ìƒ ì—†ìŒ, ê¸°ë³¸ ê²½ë¡œ ì‚¬ìš©`);
                idleVideo.src = '/assets/idle_long.mp4';
                idleVideo.load();
                idleVideo.onloadeddata = () => {
                    if (wasPlaying) idleVideo.play().catch(() => {});
                };
            };
        });

    </script>
</body>
</html>
