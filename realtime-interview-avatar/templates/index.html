<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë©´ì ‘ê´€</title>
    <link rel="icon" href="data:,">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 2400px;
            margin: 0 auto;
            padding: 40px;
        }

        header {
            text-align: center;
            padding: 20px 0;
        }

        header h1 {
            font-size: 3em;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        header p {
            color: #888;
            font-size: 1.4em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 40px;
            margin-top: 30px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 24px;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #00d2ff;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            color: #aaa;
            font-size: 1.2em;
        }

        select, button {
            width: 100%;
            padding: 16px 24px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s;
        }

        select:hover, select:focus {
            border-color: #00d2ff;
            outline: none;
        }

        select option {
            background: #1a1a2e;
            color: #fff;
        }

        button.primary {
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            border: none;
            font-weight: bold;
        }

        button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 210, 255, 0.4);
        }

        button.primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        button.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tts-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 20px;
            background: rgba(0, 210, 255, 0.1);
            border-radius: 12px;
            border: 1px solid rgba(0, 210, 255, 0.3);
            margin-bottom: 20px;
        }

        .tts-options .form-group {
            margin-bottom: 0;
        }

        .tts-options label {
            font-size: 1em;
            color: #00d2ff;
        }

        .tts-options select {
            padding: 12px 16px;
            font-size: 1em;
        }

        /* ëŒ€í™” ì˜ì—­ */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 300px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 16px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px 18px;
            border-radius: 12px;
            max-width: 85%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.user {
            background: linear-gradient(90deg, #3a7bd5, #00d2ff);
            margin-left: auto;
            text-align: right;
        }

        .chat-message.assistant {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .chat-message.system {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.3);
            text-align: center;
            max-width: 100%;
            font-size: 0.9em;
            color: #ffc107;
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chat-input {
            flex: 1;
            padding: 14px 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1.1em;
            font-family: inherit;
        }

        .chat-input:focus {
            border-color: #00d2ff;
            outline: none;
        }

        .chat-input::placeholder {
            color: #666;
        }

        .send-btn {
            width: auto;
            padding: 14px 30px;
            white-space: nowrap;
        }

        /* ë¹„ë””ì˜¤ ì˜ì—­ */
        .video-container {
            position: relative;
            background: #000;
            border-radius: 24px;
            overflow: hidden;
            width: 100%;
            height: 650px;
        }

        .video-container video {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            height: 100%;
            max-width: 100%;
            object-fit: contain;
        }

        #idleVideo, #resultVideo, #streamCanvas {
            transition: none !important;
            animation: none !important;
        }

        #idleVideo {
            z-index: 2;
            visibility: visible;
        }

        #resultVideo {
            z-index: 3;
            visibility: hidden;
        }

        #streamCanvas {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            height: 100%;
            max-width: 100%;
            object-fit: contain;
            z-index: 4;
            visibility: hidden;
            background: transparent;
        }

        .video-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
            font-size: 1.8em;
        }

        .progress-container {
            margin-top: 20px;
        }

        .progress-bar {
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            width: 0%;
            transition: width 0.3s;
        }

        .status-text {
            margin-top: 15px;
            font-size: 1.2em;
            color: #888;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .elapsed-time {
            color: #00d2ff;
            font-weight: bold;
            font-size: 1.3em;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.2em;
            font-weight: bold;
            color: #00d2ff;
        }

        .stat-label {
            font-size: 1em;
            color: #888;
            margin-top: 5px;
        }

        .clear-btn {
            margin-top: 15px;
            padding: 12px 20px;
            font-size: 1em;
        }

        /* í”„ë¡¬í”„íŠ¸ ì„¤ì • ì˜ì—­ */
        .prompt-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .prompt-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 10px 0;
        }

        .prompt-toggle h3 {
            color: #00d2ff;
            font-size: 1.2em;
        }

        .prompt-toggle-icon {
            font-size: 1.5em;
            color: #888;
            transition: transform 0.3s;
        }

        .prompt-toggle-icon.open {
            transform: rotate(180deg);
        }

        .prompt-content {
            display: none;
            margin-top: 15px;
        }

        .prompt-content.open {
            display: block;
        }

        .prompt-textarea {
            width: 100%;
            min-height: 120px;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
        }

        .prompt-textarea:focus {
            border-color: #00d2ff;
            outline: none;
        }

        .prompt-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .prompt-actions button {
            flex: 1;
            padding: 10px 16px;
            font-size: 0.95em;
        }

        .prompt-status {
            margin-top: 10px;
            font-size: 0.9em;
            color: #4caf50;
            display: none;
        }

        /* LLM ìƒíƒœ í‘œì‹œ */
        .llm-status-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .llm-status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            font-size: 0.9em;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .llm-status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .llm-status-dot.online {
            background: #4caf50;
            box-shadow: 0 0 8px #4caf50;
        }

        .llm-status-dot.offline {
            background: #f44336;
            box-shadow: 0 0 8px #f44336;
            animation: none;
        }

        .llm-status-dot.checking {
            background: #ff9800;
            box-shadow: 0 0 8px #ff9800;
        }

        .llm-status-dot.not_configured {
            background: #9e9e9e;
            box-shadow: none;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .llm-status-name {
            color: #ccc;
        }

        .llm-status-latency {
            color: #888;
            font-size: 0.85em;
        }

        .llm-status-active {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
        }

        /* í ìƒíƒœ í‘œì‹œ */
        .queue-status {
            display: none;
            align-items: center;
            justify-content: center;
            gap: 15px;
            padding: 20px;
            background: rgba(255, 152, 0, 0.15);
            border: 1px solid rgba(255, 152, 0, 0.4);
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .queue-status.visible {
            display: flex;
        }

        .queue-position {
            font-size: 2.5em;
            font-weight: bold;
            color: #ff9800;
            min-width: 60px;
            text-align: center;
        }

        .queue-info {
            flex: 1;
        }

        .queue-message {
            font-size: 1.1em;
            color: #fff;
            margin-bottom: 5px;
        }

        .queue-wait-time {
            font-size: 0.9em;
            color: #aaa;
        }

        .queue-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 152, 0, 0.3);
            border-top-color: #ff9800;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AI Interview</h1>
            <p>AI ë©´ì ‘ê´€ê³¼ ì‹¤ì‹œê°„ ë©´ì ‘ ì—°ìŠµ</p>
            <div class="nav-links" style="margin: 15px 0;">
                <a href="/" style="color: #00d2ff; text-decoration: none; margin: 0 15px;">ë©´ì ‘ ì‹œë®¬ë ˆì´ì…˜</a>
                <a href="/record" style="color: #feca57; text-decoration: none; margin: 0 15px;">ğŸ¬ ì˜ìƒ ë…¹í™”</a>
            </div>
            <div class="llm-status-container" id="llmStatusContainer">
                <div class="llm-status-item" id="llmPrimaryStatus">
                    <span class="llm-status-dot checking" id="llmPrimaryDot"></span>
                    <span class="llm-status-name" id="llmPrimaryName">LLM API</span>
                    <span class="llm-status-latency" id="llmPrimaryLatency">í™•ì¸ ì¤‘...</span>
                </div>
                <div class="llm-status-item" id="llmFallbackStatus">
                    <span class="llm-status-dot checking" id="llmFallbackDot"></span>
                    <span class="llm-status-name" id="llmFallbackName">OpenAI</span>
                    <span class="llm-status-latency" id="llmFallbackLatency">í™•ì¸ ì¤‘...</span>
                </div>
            </div>
        </header>

        <div class="main-content">
            <div class="panel">
                <h2>ë©´ì ‘</h2>

                <div class="form-group">
                    <label>ì•„ë°”íƒ€ ì„ íƒ</label>
                    <select id="avatarSelect">
                        <option value="">ë¡œë”© ì¤‘...</option>
                    </select>
                </div>

                <div class="tts-options">
                    <div class="form-group">
                        <label>TTS ì—”ì§„</label>
                        <select id="ttsEngineSelect" onchange="updateVoiceOptions()">
                            <option value="">ë¡œë”© ì¤‘...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ìŒì„±</label>
                        <select id="ttsVoiceSelect">
                            <option value="">ì—”ì§„ ì„ íƒ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ì¶œë ¥ í•´ìƒë„</label>
                        <select id="resolutionSelect">
                            <option value="720p">720p (ê³ í’ˆì§ˆ)</option>
                            <option value="480p">480p (ê· í˜•)</option>
                            <option value="360p" selected>360p (ë¹ ë¥¸ ì‘ë‹µ)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ì‘ë‹µ ì†ë„</label>
                        <select id="speedModeSelect">
                            <option value="quality">ê³ í’ˆì§ˆ (ëŠë¦¼)</option>
                            <option value="balanced">ê· í˜•</option>
                            <option value="fast" selected>ë¹ ë¥¸ ì‘ë‹µ (ê¶Œì¥)</option>
                            <option value="realtime">ì‹¤ì‹œê°„ (ìµœì €í’ˆì§ˆ)</option>
                        </select>
                    </div>
                </div>

                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message system">
                            "ë©´ì ‘ ì‹œì‘" ë²„íŠ¼ì„ ëˆŒëŸ¬ ë©´ì ‘ì„ ì‹œì‘í•˜ì„¸ìš”
                        </div>
                    </div>
                    <div class="chat-input-container">
                        <input type="text" class="chat-input" id="chatInput"
                               placeholder="ë‹µë³€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                               onkeypress="handleKeyPress(event)">
                        <button class="primary send-btn" id="sendBtn" onclick="sendMessage()">
                            ì „ì†¡
                        </button>
                    </div>
                </div>

                <div class="button-group" style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="primary" id="startInterviewBtn" onclick="startInterview()">
                        ë©´ì ‘ ì‹œì‘
                    </button>
                    <button class="secondary" onclick="clearHistory()">
                        ì´ˆê¸°í™”
                    </button>
                </div>

                <!-- í”„ë¡¬í”„íŠ¸ ì„¤ì • ì„¹ì…˜ -->
                <div class="prompt-section">
                    <div class="prompt-toggle" onclick="togglePrompt()">
                        <h3>ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì„¤ì •</h3>
                        <span class="prompt-toggle-icon" id="promptToggleIcon">â–¼</span>
                    </div>
                    <div class="prompt-content" id="promptContent">
                        <textarea class="prompt-textarea" id="promptTextarea"
                                  placeholder="AI ë©´ì ‘ê´€ì˜ ì—­í• ê³¼ í–‰ë™ì„ ì •ì˜í•˜ì„¸ìš”..."></textarea>
                        <div class="prompt-actions">
                            <button class="primary" onclick="savePrompt()">ì €ì¥</button>
                            <button class="secondary" onclick="resetPrompt()">ê¸°ë³¸ê°’</button>
                        </div>
                        <div class="prompt-status" id="promptStatus">í”„ë¡¬í”„íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2>ë©´ì ‘ê´€</h2>

                <div class="video-container">
                    <video id="idleVideo" src="/assets/images/a24ca21b-0d02-49f0-99a7-d737c5ca6058.mp4" loop muted autoplay playsinline></video>
                    <canvas id="streamCanvas"></canvas>
                    <video id="resultVideo" playsinline></video>
                    <audio id="streamAudio" style="display: none;"></audio>
                </div>

                <!-- í ìƒíƒœ í‘œì‹œ -->
                <div class="queue-status" id="queueStatus">
                    <div class="queue-spinner"></div>
                    <div class="queue-position" id="queuePosition">-</div>
                    <div class="queue-info">
                        <div class="queue-message" id="queueMessage">ëŒ€ê¸° ì¤‘...</div>
                        <div class="queue-wait-time" id="queueWaitTime"></div>
                    </div>
                </div>

                <div class="progress-container" id="progressContainer" style="display: none;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="status-text">
                        <span id="statusText">ì¤€ë¹„ ì¤‘...</span>
                        <span id="elapsedTime" class="elapsed-time"></span>
                    </div>
                </div>

                <div class="stats" id="statsContainer" style="display: none;">
                    <div class="stat-item">
                        <div class="stat-value" id="statLLM">-</div>
                        <div class="stat-label">LLM (ì´ˆ)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statTTS">-</div>
                        <div class="stat-label">TTS (ì´ˆ)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statTotal">-</div>
                        <div class="stat-label">ì´ ì‹œê°„ (ì´ˆ)</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let isGenerating = false;
        let ttsEngines = {};
        let llmStartTime = null;
        let isVideoPlaying = false;  // ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘ í”Œë˜ê·¸
        let isStreaming = false;  // ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ í”Œë˜ê·¸
        let streamingMode = false;  // true: ìŠ¤íŠ¸ë¦¬ë° ëª¨ë“œ, false: ê¸°ì¡´ ëª¨ë“œ (ìŠ¤íŠ¸ë¦¬ë° ë¹„í™œì„±í™”)
        let streamCtx = null;  // Canvas context
        let streamFps = 25;  // ìŠ¤íŠ¸ë¦¬ë° FPS
        let clientSid = null;  // í´ë¼ì´ì–¸íŠ¸ ì„¸ì…˜ ID

        // LLM ìƒíƒœ í™•ì¸ í•¨ìˆ˜
        async function checkLLMStatus() {
            try {
                const response = await fetch('/api/llm_status');
                const status = await response.json();

                // Primary (LLM API Server) ìƒíƒœ í‘œì‹œ
                const primaryDot = document.getElementById('llmPrimaryDot');
                const primaryName = document.getElementById('llmPrimaryName');
                const primaryLatency = document.getElementById('llmPrimaryLatency');
                const primaryItem = document.getElementById('llmPrimaryStatus');

                primaryDot.className = 'llm-status-dot ' + status.primary.status;
                primaryName.textContent = status.primary.name;

                if (status.primary.status === 'online') {
                    primaryLatency.textContent = status.primary.latency + 'ms';
                } else if (status.primary.status === 'offline') {
                    primaryLatency.textContent = 'ì˜¤í”„ë¼ì¸';
                } else if (status.primary.status === 'timeout') {
                    primaryLatency.textContent = 'íƒ€ì„ì•„ì›ƒ';
                } else if (status.primary.status === 'error') {
                    primaryLatency.textContent = status.primary.error || 'ì˜¤ë¥˜';
                }

                // Fallback (OpenAI) ìƒíƒœ í‘œì‹œ
                const fallbackDot = document.getElementById('llmFallbackDot');
                const fallbackName = document.getElementById('llmFallbackName');
                const fallbackLatency = document.getElementById('llmFallbackLatency');
                const fallbackItem = document.getElementById('llmFallbackStatus');

                fallbackDot.className = 'llm-status-dot ' + status.fallback.status;
                fallbackName.textContent = status.fallback.name;

                if (status.fallback.status === 'online') {
                    fallbackLatency.textContent = status.fallback.latency + 'ms';
                } else if (status.fallback.status === 'not_configured') {
                    fallbackLatency.textContent = 'ë¯¸ì„¤ì •';
                } else if (status.fallback.status === 'offline') {
                    fallbackLatency.textContent = 'ì˜¤í”„ë¼ì¸';
                } else if (status.fallback.status === 'timeout') {
                    fallbackLatency.textContent = 'íƒ€ì„ì•„ì›ƒ';
                } else if (status.fallback.status === 'error') {
                    fallbackLatency.textContent = status.fallback.error || 'ì˜¤ë¥˜';
                }

                // í™œì„± ì„œë²„ í‘œì‹œ
                primaryItem.classList.remove('llm-status-active');
                fallbackItem.classList.remove('llm-status-active');

                if (status.active === 'primary') {
                    primaryItem.classList.add('llm-status-active');
                } else if (status.active === 'fallback') {
                    fallbackItem.classList.add('llm-status-active');
                }

                console.log('LLM Status:', status);
            } catch (error) {
                console.error('LLM status check failed:', error);
                document.getElementById('llmPrimaryLatency').textContent = 'í™•ì¸ ì‹¤íŒ¨';
                document.getElementById('llmFallbackLatency').textContent = 'í™•ì¸ ì‹¤íŒ¨';
            }
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ LLM ìƒíƒœ í™•ì¸
        checkLLMStatus();
        // 30ì´ˆë§ˆë‹¤ ìƒíƒœ ê°±ì‹ 
        setInterval(checkLLMStatus, 30000);

        // WebSocket ì´ë²¤íŠ¸
        socket.on('connect', () => {
            console.log('Connected to server');
        });

        // ì„œë²„ë¡œë¶€í„° SID ìˆ˜ì‹ 
        socket.on('connected', (data) => {
            clientSid = data.sid;
            console.log('Client SID:', clientSid);
        });

        // í ìƒíƒœ ì—…ë°ì´íŠ¸
        socket.on('queue_update', (data) => {
            const queueStatus = document.getElementById('queueStatus');
            const queuePosition = document.getElementById('queuePosition');
            const queueMessage = document.getElementById('queueMessage');
            const queueWaitTime = document.getElementById('queueWaitTime');

            if (data.position === 0) {
                // ì²˜ë¦¬ ì¤‘ - í ìƒíƒœ ìˆ¨ê¸°ê³  ì§„í–‰ ìƒíƒœ í‘œì‹œ
                queueStatus.classList.remove('visible');
                document.getElementById('progressContainer').style.display = 'block';
            } else if (data.position > 0) {
                // ëŒ€ê¸° ì¤‘ - í ìƒíƒœ í‘œì‹œ
                queueStatus.classList.add('visible');
                queuePosition.textContent = data.position;
                queueMessage.textContent = data.message || `ëŒ€ê¸°ì—´ ${data.position}ë²ˆì§¸`;

                if (data.wait_time !== undefined) {
                    queueWaitTime.textContent = `ëŒ€ê¸° ì‹œê°„: ${data.wait_time.toFixed(0)}ì´ˆ`;
                } else {
                    queueWaitTime.textContent = '';
                }
            }

            console.log('Queue update:', data);
        });

        socket.on('status', (data) => {
            document.getElementById('statusText').textContent = data.message;
            document.getElementById('progressFill').style.width = data.progress + '%';

            if (data.elapsed !== undefined) {
                const elapsed = data.elapsed;
                const seconds = elapsed.toFixed(1);
                document.getElementById('elapsedTime').textContent = `${seconds}ì´ˆ`;
            }
        });

        socket.on('complete', (data) => {
            isGenerating = false;
            updateUIState(false);

            // í ìƒíƒœ ìˆ¨ê¸°ê¸°
            document.getElementById('queueStatus').classList.remove('visible');

            if (data.total_time !== undefined) {
                document.getElementById('elapsedTime').textContent = `ì™„ë£Œ: ${data.total_time.toFixed(1)}ì´ˆ`;
            }

            // ì´ë¯¸ ë¹„ë””ì˜¤ê°€ ì¬ìƒ ì¤‘ì´ë©´ ë¬´ì‹œ (ì¤‘ë³µ ë°©ì§€)
            if (isVideoPlaying) {
                console.log('Video already playing, ignoring duplicate complete event');
                return;
            }
            isVideoPlaying = true;

            const idleVideo = document.getElementById('idleVideo');
            const resultVideo = document.getElementById('resultVideo');

            // ì´ì „ ì¬ìƒ ì¤‘ì¸ ë¹„ë””ì˜¤ ì •ë¦¬
            resultVideo.pause();
            resultVideo.currentTime = 0;
            resultVideo.oncanplaythrough = null;
            resultVideo.ontimeupdate = null;
            resultVideo.onended = null;

            // idle ë¹„ë””ì˜¤ëŠ” í•­ìƒ ìŒì†Œê±° ìƒíƒœ ìœ ì§€
            idleVideo.muted = true;

            // resultVideo ì¤€ë¹„
            resultVideo.style.visibility = 'hidden';
            resultVideo.muted = false;
            // ì„œë²„ì—ì„œ ë°›ì€ video_url ì‚¬ìš© (ì—†ìœ¼ë©´ ê¸°ì¡´ ê²½ë¡œ ì‚¬ìš©)
            const videoUrl = data.video_url || '/video/output_with_audio.mp4';
            resultVideo.src = videoUrl + '?' + Date.now();

            // ë¹„ë””ì˜¤ê°€ ì¶©ë¶„íˆ ë²„í¼ë§ë˜ë©´
            resultVideo.oncanplaythrough = () => {
                resultVideo.oncanplaythrough = null;
                // ë¦½ì‹±í¬ë¥¼ ë³´ì´ê²Œ í•˜ê³  ì¬ìƒ ì‹œì‘ (z-indexê°€ ë†’ì•„ì„œ idle ìœ„ì— í‘œì‹œë¨)
                resultVideo.style.visibility = 'visible';
                resultVideo.play().catch(err => {
                    console.error('Video play failed:', err);
                    isVideoPlaying = false;
                });
            };

            // ë¹„ë””ì˜¤ ë¡œë“œ ì‹œì‘
            resultVideo.load();

            // ë¦½ì‹±í¬ ë¹„ë””ì˜¤ ì™„ì „ ì¢…ë£Œ í›„ ì •ë¦¬
            resultVideo.onended = () => {
                resultVideo.pause();
                resultVideo.muted = true;
                resultVideo.currentTime = 0;
                resultVideo.style.visibility = 'hidden';
                resultVideo.src = '';
                isVideoPlaying = false;
                
                // idle ë¹„ë””ì˜¤ ë‹¤ì‹œ í‘œì‹œ
                idleVideo.style.visibility = 'visible';
                // idle ë¹„ë””ì˜¤ê°€ ë©ˆì¶°ìˆìœ¼ë©´ ì¬ìƒ ì‹œì‘
                if (idleVideo.paused) {
                    idleVideo.play().catch(err => {
                        console.error('Idle video play failed:', err);
                    });
                }
            };

            // í†µê³„ í‘œì‹œ
            document.getElementById('statsContainer').style.display = 'grid';
            if (data.total_time !== undefined) {
                document.getElementById('statTotal').textContent = data.total_time.toFixed(1);
            }
        });

        socket.on('error', (data) => {
            isGenerating = false;
            updateUIState(false);
            document.getElementById('queueStatus').classList.remove('visible');
            document.getElementById('statusText').textContent = 'ì˜¤ë¥˜: ' + data.message;
            addMessage('system', 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + data.message);
            
            // ì—ëŸ¬ ë°œìƒ ì‹œ idle ë¹„ë””ì˜¤ ë‹¤ì‹œ í‘œì‹œ
            const idleVideo = document.getElementById('idleVideo');
            const resultVideo = document.getElementById('resultVideo');
            const canvas = document.getElementById('streamCanvas');
            resultVideo.style.visibility = 'hidden';
            canvas.style.visibility = 'hidden';
            idleVideo.style.visibility = 'visible';
            if (idleVideo.paused) {
                idleVideo.play().catch(err => {
                    console.error('Idle video play failed:', err);
                });
            }
        });

        socket.on('cancelled', (data) => {
            isGenerating = false;
            updateUIState(false);
            document.getElementById('queueStatus').classList.remove('visible');
            document.getElementById('statusText').textContent = data.message;
            
            // ì·¨ì†Œ ì‹œ idle ë¹„ë””ì˜¤ ë‹¤ì‹œ í‘œì‹œ
            const idleVideo = document.getElementById('idleVideo');
            const resultVideo = document.getElementById('resultVideo');
            const canvas = document.getElementById('streamCanvas');
            resultVideo.style.visibility = 'hidden';
            canvas.style.visibility = 'hidden';
            idleVideo.style.visibility = 'visible';
            if (idleVideo.paused) {
                idleVideo.play().catch(err => {
                    console.error('Idle video play failed:', err);
                });
            }
        });

        // ========== ìŠ¤íŠ¸ë¦¬ë° ì´ë²¤íŠ¸ ==========
        socket.on('stream_status', (data) => {
            document.getElementById('statusText').textContent = data.message;
            if (data.progress !== undefined) {
                document.getElementById('progressFill').style.width = data.progress + '%';
            }
            if (data.elapsed !== undefined) {
                document.getElementById('elapsedTime').textContent = `${data.elapsed.toFixed(1)}ì´ˆ`;
            }
        });

        // ========== ìŠ¤íŠ¸ë¦¬ë° ì´ë²¤íŠ¸ (TTS ìŠ¤íŠ¸ë¦¬ë° + ë¹„ë””ì˜¤ í”„ë ˆì„) ==========
        let streamFrameBuffer = [];  // í”„ë ˆì„ ë²„í¼
        let streamAudioContext = null;  // Web Audio API ì»¨í…ìŠ¤íŠ¸
        let streamAudioSource = null;   // ì˜¤ë””ì˜¤ ì†ŒìŠ¤
        let streamAudioBuffer = null;    // ì˜¤ë””ì˜¤ ë²„í¼
        let streamAudioChunks = [];     // TTS ì˜¤ë””ì˜¤ ì²­í¬ ë°°ì—´
        let isStreamPlaying = false;     // ìŠ¤íŠ¸ë¦¬ë° ì¬ìƒ ì¤‘
        let streamTotalFrames = 0;      // ì „ì²´ í”„ë ˆì„ ìˆ˜
        let streamSampleRate = 16000;   // ìƒ˜í”Œë ˆì´íŠ¸
        const BUFFER_THRESHOLD = 15;    // ë²„í¼ ì„ê³„ê°’ (ë‚®ì¶¤ - ë¹ ë¥¸ ì¬ìƒ ì‹œì‘)

        socket.on('stream_start', (data) => {
            console.log('Stream start:', data);
            resetStreamState();
            streamTotalFrames = data.total_frames;
            streamFps = data.fps || 25;
            document.getElementById('statusText').textContent =
                `ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘ (${streamTotalFrames}í”„ë ˆì„, ${streamFps}fps)`;
        });

        // TTS ì˜¤ë””ì˜¤ ì²­í¬ ìŠ¤íŠ¸ë¦¬ë° ìˆ˜ì‹ 
        let ttsAudioChunks = [];  // TTS ì˜¤ë””ì˜¤ ì²­í¬ (Base64 ë¬¸ìì—´ ë°°ì—´)
        let ttsAudioBlob = null;  // ìµœì¢… ì˜¤ë””ì˜¤ Blob
        
        socket.on('stream_audio_chunk', (data) => {
            console.log('TTS audio chunk received, elapsed:', data.elapsed, 'is_final:', data.is_final);
            
            // ìƒ˜í”Œë ˆì´íŠ¸ ì €ì¥
            if (data.sample_rate) {
                streamSampleRate = data.sample_rate;
            }
            
            // Base64 ë¬¸ìì—´ë¡œ ì €ì¥
            ttsAudioChunks.push(data.audio);
            
            // ì²« ì²­í¬ê°€ ë„ì°©í•˜ë©´ ì¦‰ì‹œ ì¬ìƒ ì‹œì‘ (ìŠ¤íŠ¸ë¦¬ë° íš¨ê³¼)
            if (ttsAudioChunks.length === 1 && !isStreamPlaying) {
                playFirstAudioChunk(data.audio);
            }
            
            // ìµœì¢… ì²­í¬ì¸ ê²½ìš° ì „ì²´ ì˜¤ë””ì˜¤ ì¬ìƒ
            if (data.is_final) {
                playCompleteAudio();
            }
        });

        // TTS ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ
        socket.on('stream_audio_complete', (data) => {
            console.log('TTS streaming complete, total length:', data.total_length);
            // ì´ë¯¸ stream_audio_chunkì—ì„œ is_final=trueë¡œ ì²˜ë¦¬ë¨
        });

        // ì²« ì˜¤ë””ì˜¤ ì²­í¬ ì¬ìƒ (ìŠ¤íŠ¸ë¦¬ë° íš¨ê³¼)
        function playFirstAudioChunk(firstChunkBase64) {
            try {
                // ì²« ì²­í¬ë¥¼ ì¦‰ì‹œ ì¬ìƒ
                const audioUrl = 'data:audio/wav;base64,' + firstChunkBase64;
                const tempAudio = new Audio(audioUrl);
                tempAudio.preload = 'auto';
                
                tempAudio.oncanplaythrough = () => {
                    tempAudio.play().catch(err => {
                        console.error('Failed to play first chunk:', err);
                    });
                };
                
                tempAudio.load();
            } catch (err) {
                console.error('Failed to play first audio chunk:', err);
            }
        }

        // ì™„ì „í•œ ì˜¤ë””ì˜¤ ì¬ìƒ
        function playCompleteAudio() {
            if (ttsAudioChunks.length === 0) return;
            
            try {
                // ëª¨ë“  ì²­í¬ë¥¼ í•©ì³ì„œ í•˜ë‚˜ì˜ Base64 ë¬¸ìì—´ ìƒì„±
                const combinedBase64 = ttsAudioChunks.join('');
                const audioUrl = 'data:audio/wav;base64,' + combinedBase64;
                
                streamAudio = new Audio(audioUrl);
                streamAudio.preload = 'auto';
                
                // ë²„í¼ê°€ ì¶©ë¶„í•˜ë©´ ì¬ìƒ ì‹œì‘
                const bufferCount = streamFrameBuffer.filter(f => f).length;
                if (bufferCount >= BUFFER_THRESHOLD && !isStreamPlaying) {
                    startStreamPlayback();
                } else {
                    // ë²„í¼ê°€ ë¶€ì¡±í•´ë„ ì˜¤ë””ì˜¤ëŠ” ì¤€ë¹„
                    streamAudio.oncanplaythrough = () => {
                        if (!isStreamPlaying && bufferCount >= BUFFER_THRESHOLD) {
                            startStreamPlayback();
                        }
                    };
                }
            } catch (err) {
                console.error('Failed to create complete audio:', err);
            }
        }

        // ê¸°ì¡´ stream_audio ì´ë²¤íŠ¸ (í˜¸í™˜ì„± ìœ ì§€)
        socket.on('stream_audio', (data) => {
            console.log('Stream audio received (legacy), elapsed:', data.elapsed);
            // Base64 ì˜¤ë””ì˜¤ ë°ì´í„°ë¡œ Audio ê°ì²´ ìƒì„±
            const audio = new Audio('data:audio/wav;base64,' + data.audio);
            audio.preload = 'auto';
            
            // ë²„í¼ê°€ ì¶©ë¶„í•˜ë©´ ì¬ìƒ ì‹œì‘
            const bufferCount = streamFrameBuffer.filter(f => f).length;
            if (bufferCount >= BUFFER_THRESHOLD && !isStreamPlaying) {
                streamAudio = audio;
                startStreamPlayback();
            }
        });

        socket.on('stream_frame', (data) => {
            if (!isStreaming) return;

            const canvas = document.getElementById('streamCanvas');

            // FPS ì €ì¥
            if (data.fps) streamFps = data.fps;

            // í”„ë ˆì„ì„ ë²„í¼ì— ì¶”ê°€
            const img = new Image();
            img.onload = () => {
                streamFrameBuffer[data.index] = img;

                // ì²« í”„ë ˆì„ì—ì„œ Canvas í¬ê¸° ì„¤ì •
                if (data.index === 0) {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    streamCtx = canvas.getContext('2d');
                }

                // ë²„í¼ ìƒíƒœ í‘œì‹œ
                const bufferCount = streamFrameBuffer.filter(f => f).length;
                document.getElementById('statusText').textContent =
                    `ë²„í¼ë§ ${bufferCount}/${data.total} í”„ë ˆì„`;

                // ë²„í¼ê°€ ì¶©ë¶„í•˜ê³  ì˜¤ë””ì˜¤ ì¤€ë¹„ë˜ë©´ ì¬ìƒ ì‹œì‘
                if (bufferCount >= BUFFER_THRESHOLD && streamAudio && !isStreamPlaying) {
                    startStreamPlayback();
                }
            };
            img.src = 'data:image/jpeg;base64,' + data.frame;
        });

        // ìŠ¤íŠ¸ë¦¬ë° ì¬ìƒ ì‹œì‘
        function startStreamPlayback() {
            if (isStreamPlaying) return;
            isStreamPlaying = true;

            const canvas = document.getElementById('streamCanvas');
            const idleVideo = document.getElementById('idleVideo');

            console.log('Starting stream playback, buffer:', streamFrameBuffer.length);

            // Canvas í‘œì‹œ
            canvas.style.visibility = 'visible';
            idleVideo.style.visibility = 'hidden';

            document.getElementById('statusText').textContent = 'ì¬ìƒ ì¤‘...';

            // ì˜¤ë””ì˜¤ ì¬ìƒ
            streamAudio.play().then(() => {
                // ì˜¤ë””ì˜¤ ì‹œê°„ ê¸°ë°˜ í”„ë ˆì„ ë Œë”ë§
                renderStreamFrame();
            }).catch(err => {
                console.error('Audio play failed:', err);
                isStreamPlaying = false;
            });

            // ì˜¤ë””ì˜¤ ì¢…ë£Œ ì‹œ idleë¡œ ë³µê·€
            streamAudio.onended = () => {
                console.log('Stream audio ended');
                isStreamPlaying = false;

                setTimeout(() => {
                    if (!isStreamPlaying) {
                        canvas.style.visibility = 'hidden';
                        idleVideo.style.visibility = 'visible';
                    }
                }, 100);
            };
        }

        // í”„ë ˆì„ ë Œë”ë§ (ì˜¤ë””ì˜¤ ë™ê¸°í™”)
        function renderStreamFrame() {
            if (!streamAudio || streamAudio.paused || streamAudio.ended) return;

            const currentTime = streamAudio.currentTime;
            const targetFrameIndex = Math.floor(currentTime * streamFps);

            if (streamFrameBuffer[targetFrameIndex]) {
                streamCtx.drawImage(streamFrameBuffer[targetFrameIndex], 0, 0);
            }

            requestAnimationFrame(renderStreamFrame);
        }

        // ìŠ¤íŠ¸ë¦¬ë° ì´ˆê¸°í™” (ìƒˆ ìš”ì²­ ì‹œ)
        function resetStreamState() {
            streamFrameBuffer = [];
            streamAudio = null;
            isStreamPlaying = false;
            isStreaming = true;
            ttsAudioChunks = [];  // TTS ì²­í¬ ì´ˆê¸°í™”
            ttsAudioBlob = null;

            const canvas = document.getElementById('streamCanvas');
            streamCtx = canvas.getContext('2d');
            canvas.style.visibility = 'hidden';
        }

        socket.on('stream_complete', (data) => {
            console.log('Stream complete:', data);
            isStreaming = false;
            isGenerating = false;
            updateUIState(false);

            const elapsed = data.elapsed || data.total_time || 0;
            document.getElementById('elapsedTime').textContent = `ì™„ë£Œ: ${elapsed.toFixed(1)}ì´ˆ`;
            document.getElementById('statsContainer').style.display = 'grid';
            document.getElementById('statTotal').textContent = elapsed.toFixed(1);
            document.getElementById('statusText').textContent =
                `ì™„ë£Œ (${data.total_frames}í”„ë ˆì„, ${elapsed.toFixed(1)}ì´ˆ)`;
            
            // ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ í›„ idle ë¹„ë””ì˜¤ ë‹¤ì‹œ í‘œì‹œ
            const canvas = document.getElementById('streamCanvas');
            const idleVideo = document.getElementById('idleVideo');
            canvas.style.visibility = 'hidden';
            idleVideo.style.visibility = 'visible';
            // idle ë¹„ë””ì˜¤ê°€ ë©ˆì¶°ìˆìœ¼ë©´ ì¬ìƒ ì‹œì‘
            if (idleVideo.paused) {
                idleVideo.play().catch(err => {
                    console.error('Idle video play failed:', err);
                });
            }
        });

        socket.on('stream_error', (data) => {
            console.error('Stream error:', data);
            isStreaming = false;
            isGenerating = false;
            isStreamPlaying = false;
            updateUIState(false);

            const canvas = document.getElementById('streamCanvas');
            const idleVideo = document.getElementById('idleVideo');
            canvas.style.visibility = 'hidden';
            idleVideo.style.visibility = 'visible';

            document.getElementById('statusText').textContent = 'ì˜¤ë¥˜: ' + data.message;
            addMessage('system', 'ìŠ¤íŠ¸ë¦¬ë° ì˜¤ë¥˜: ' + data.message);
        });

        // UI ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateUIState(generating) {
            document.getElementById('sendBtn').disabled = generating;
            document.getElementById('sendBtn').textContent = generating ? 'ìƒì„± ì¤‘...' : 'ì „ì†¡';
            document.getElementById('chatInput').disabled = generating;
        }

        // ì˜µì…˜ ë¡œë“œ
        async function loadOptions() {
            try {
                // ì•„ë°”íƒ€ ë¡œë“œ
                const avatarsRes = await fetch('/api/avatars');
                const avatars = await avatarsRes.json();
                const avatarSelect = document.getElementById('avatarSelect');
                avatarSelect.innerHTML = avatars.length > 0
                    ? avatars.map(a => `<option value="${a.path}">${a.name}</option>`).join('')
                    : '<option value="">ì‚¬ì „ ê³„ì‚°ëœ ì•„ë°”íƒ€ ì—†ìŒ</option>';

                // TTS ì—”ì§„ ë¡œë“œ
                const enginesRes = await fetch('/api/tts_engines');
                const enginesArray = await enginesRes.json();
                // ë°°ì—´ì„ id ê¸°ë°˜ ê°ì²´ë¡œ ë³€í™˜
                ttsEngines = {};
                enginesArray.forEach(engine => {
                    ttsEngines[engine.id] = engine;
                });
                const engineSelect = document.getElementById('ttsEngineSelect');
                engineSelect.innerHTML = enginesArray
                    .map(engine => {
                        const disabled = !engine.available ? ' disabled' : '';
                        const suffix = !engine.available ? ' (API í‚¤ í•„ìš”)' : '';
                        return `<option value="${engine.id}"${disabled}>${engine.name}${suffix}</option>`;
                    }).join('');

                updateVoiceOptions();

            } catch (e) {
                console.error('Failed to load options:', e);
            }
        }

        function updateVoiceOptions() {
            const engineId = document.getElementById('ttsEngineSelect').value;
            const voiceSelect = document.getElementById('ttsVoiceSelect');

            if (!engineId || !ttsEngines[engineId]) {
                voiceSelect.innerHTML = '<option value="">ì—”ì§„ ì„ íƒ</option>';
                return;
            }

            const voices = ttsEngines[engineId].voices;
            // voicesê°€ ë°°ì—´ì¸ ê²½ìš°ì™€ ê°ì²´ì¸ ê²½ìš° ëª¨ë‘ ì²˜ë¦¬
            if (Array.isArray(voices)) {
                voiceSelect.innerHTML = voices
                    .map(voice => `<option value="${voice}">${voice}</option>`)
                    .join('');
            } else {
                voiceSelect.innerHTML = Object.entries(voices)
                    .map(([id, name]) => `<option value="${id}">${name}</option>`)
                    .join('');
            }
        }

        // ë©”ì‹œì§€ ì¶”ê°€
        function addMessage(role, content) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;
            messageDiv.textContent = content;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage() {
            if (isGenerating) return;

            const input = document.getElementById('chatInput');
            const message = input.value.trim();

            if (!message) return;

            const avatarPath = document.getElementById('avatarSelect').value;
            if (!avatarPath) {
                alert('ì•„ë°”íƒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
            addMessage('user', message);
            input.value = '';

            isGenerating = true;
            updateUIState(true);
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('statusText').textContent = 'LLM ì‘ë‹µ ìƒì„± ì¤‘...';
            document.getElementById('elapsedTime').textContent = '';

            llmStartTime = Date.now();

            try {
                // 1. LLM ì‘ë‹µ ìƒì„±
                const chatRes = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message })
                });
                const chatData = await chatRes.json();

                if (chatData.error) {
                    addMessage('system', chatData.error);
                    isGenerating = false;
                    updateUIState(false);
                    return;
                }

                const llmTime = (Date.now() - llmStartTime) / 1000;
                document.getElementById('statLLM').textContent = llmTime.toFixed(1);

                // AI ì‘ë‹µ í‘œì‹œ
                addMessage('assistant', chatData.response);

                // 2. ë¦½ì‹±í¬ ìƒì„±
                const ttsEngine = document.getElementById('ttsEngineSelect').value;
                const ttsVoice = document.getElementById('ttsVoiceSelect').value;
                const resolution = document.getElementById('resolutionSelect').value;
                const speedMode = document.getElementById('speedModeSelect').value;

                // ì†ë„ ëª¨ë“œì— ë”°ë¥¸ frame_skip ê°’ ê²°ì •
                const frameSkipMap = {
                    'quality': 1,    // ê³ í’ˆì§ˆ: ëª¨ë“  í”„ë ˆì„
                    'balanced': 2,   // ê· í˜•: 2í”„ë ˆì„ë‹¹ 1ì¶”ë¡ 
                    'fast': 3,       // ë¹ ë¦„: 3í”„ë ˆì„ë‹¹ 1ì¶”ë¡ 
                    'realtime': 3    // ì‹¤ì‹œê°„: 3í”„ë ˆì„ë‹¹ 1ì¶”ë¡ 
                };
                const frameSkip = frameSkipMap[speedMode] || 2;

                if (streamingMode) {
                    // ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœ ì´ˆê¸°í™”
                    resetStreamState();
                    document.getElementById('statusText').textContent = 'ìŠ¤íŠ¸ë¦¬ë° ìƒì„± ì‹œì‘...';
                    await fetch('/api/generate_streaming', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            avatar_path: avatarPath,
                            text: chatData.response,
                            tts_engine: ttsEngine,
                            tts_voice: ttsVoice,
                            sid: clientSid,
                            frame_skip: frameSkip,
                            resolution: resolution
                        })
                    });
                } else {
                    // ê¸°ì¡´ API ì‚¬ìš© (ì¼ë°˜ ëª¨ë“œ)
                    document.getElementById('statusText').textContent = 'ì¼ë°˜ ëª¨ë“œ - ìƒì„± ì¤‘...';
                    await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            avatar_path: avatarPath,
                            text: chatData.response,
                            tts_engine: ttsEngine,
                            tts_voice: ttsVoice,
                            sid: clientSid,
                            frame_skip: frameSkip,
                            resolution: resolution
                        })
                    });
                }

            } catch (e) {
                console.error('Send failed:', e);
                addMessage('system', 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                isGenerating = false;
                updateUIState(false);
            }
        }

        // ì—”í„°í‚¤ ì²˜ë¦¬
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // ë©´ì ‘ ì‹œì‘
        async function startInterview() {
            if (isGenerating) return;

            const avatarPath = document.getElementById('avatarSelect').value;
            if (!avatarPath) {
                alert('ì•„ë°”íƒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ëŒ€í™” ì´ˆê¸°í™”
            await fetch('/api/clear_history', { method: 'POST' });
            const messagesDiv = document.getElementById('chatMessages');
            messagesDiv.innerHTML = '<div class="chat-message system">ë©´ì ‘ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.</div>';

            isGenerating = true;
            updateUIState(true);
            document.getElementById('startInterviewBtn').disabled = true;
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('statusText').textContent = 'ë©´ì ‘ê´€ ì¤€ë¹„ ì¤‘...';
            document.getElementById('elapsedTime').textContent = '';

            llmStartTime = Date.now();

            try {
                // ë©´ì ‘ê´€ ì²« ì¸ì‚¬ ìƒì„±
                const chatRes = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: 'ë©´ì ‘ì„ ì‹œì‘í•©ë‹ˆë‹¤.' })
                });
                const chatData = await chatRes.json();

                if (chatData.error) {
                    addMessage('system', chatData.error);
                    isGenerating = false;
                    updateUIState(false);
                    document.getElementById('startInterviewBtn').disabled = false;
                    return;
                }

                const llmTime = (Date.now() - llmStartTime) / 1000;
                document.getElementById('statLLM').textContent = llmTime.toFixed(1);

                // ë©´ì ‘ê´€ ì¸ì‚¬ í‘œì‹œ
                addMessage('assistant', chatData.response);

                // ë¦½ì‹±í¬ ìƒì„±
                const ttsEngine = document.getElementById('ttsEngineSelect').value;
                const ttsVoice = document.getElementById('ttsVoiceSelect').value;
                const resolution = document.getElementById('resolutionSelect').value;
                const speedMode = document.getElementById('speedModeSelect').value;

                // ì†ë„ ëª¨ë“œì— ë”°ë¥¸ frame_skip ê°’ ê²°ì •
                const frameSkipMap = {
                    'quality': 1,
                    'balanced': 2,
                    'fast': 3,
                    'realtime': 3
                };
                const frameSkip = frameSkipMap[speedMode] || 2;

                if (streamingMode) {
                    // ìŠ¤íŠ¸ë¦¬ë° ìƒíƒœ ì´ˆê¸°í™”
                    resetStreamState();
                    document.getElementById('statusText').textContent = 'ìŠ¤íŠ¸ë¦¬ë° ìƒì„± ì‹œì‘...';
                    await fetch('/api/generate_streaming', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            avatar_path: avatarPath,
                            text: chatData.response,
                            tts_engine: ttsEngine,
                            tts_voice: ttsVoice,
                            sid: clientSid,
                            frame_skip: frameSkip,
                            resolution: resolution
                        })
                    });
                } else {
                    // ê¸°ì¡´ API ì‚¬ìš© (ì¼ë°˜ ëª¨ë“œ)
                    document.getElementById('statusText').textContent = 'ì¼ë°˜ ëª¨ë“œ - ìƒì„± ì¤‘...';
                    await fetch('/api/generate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            avatar_path: avatarPath,
                            text: chatData.response,
                            tts_engine: ttsEngine,
                            tts_voice: ttsVoice,
                            sid: clientSid,
                            frame_skip: frameSkip,
                            resolution: resolution
                        })
                    });
                }

            } catch (e) {
                console.error('Start interview failed:', e);
                addMessage('system', 'ë©´ì ‘ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                isGenerating = false;
                updateUIState(false);
                document.getElementById('startInterviewBtn').disabled = false;
            }
        }

        // ëŒ€í™” ì´ˆê¸°í™”
        async function clearHistory() {
            try {
                await fetch('/api/clear_history', { method: 'POST' });
                const messagesDiv = document.getElementById('chatMessages');
                messagesDiv.innerHTML = '<div class="chat-message system">"ë©´ì ‘ ì‹œì‘" ë²„íŠ¼ì„ ëˆŒëŸ¬ ë©´ì ‘ì„ ì‹œì‘í•˜ì„¸ìš”</div>';
                document.getElementById('startInterviewBtn').disabled = false;
            } catch (e) {
                console.error('Clear failed:', e);
            }
        }

        // ========== í”„ë¡¬í”„íŠ¸ ì„¤ì • ==========
        const DEFAULT_PROMPT = `ë‹¹ì‹ ì€ ì¹œì ˆí•˜ê³  ì „ë¬¸ì ì¸ AI ë©´ì ‘ê´€ì…ë‹ˆë‹¤.
ë©´ì ‘ìì˜ ë‹µë³€ì— ëŒ€í•´ ì ì ˆí•œ í›„ì† ì§ˆë¬¸ì„ í•˜ê±°ë‚˜ í”¼ë“œë°±ì„ ì œê³µí•©ë‹ˆë‹¤.
ì‘ë‹µì€ 2-3ë¬¸ì¥ ì •ë„ë¡œ ê°„ê²°í•˜ê²Œ ìœ ì§€í•˜ì„¸ìš”.`;

        function togglePrompt() {
            const content = document.getElementById('promptContent');
            const icon = document.getElementById('promptToggleIcon');
            content.classList.toggle('open');
            icon.classList.toggle('open');
        }

        async function loadPrompt() {
            try {
                const res = await fetch('/api/prompt');
                const data = await res.json();
                document.getElementById('promptTextarea').value = data.prompt;
            } catch (e) {
                console.error('Failed to load prompt:', e);
                document.getElementById('promptTextarea').value = DEFAULT_PROMPT;
            }
        }

        async function savePrompt() {
            const prompt = document.getElementById('promptTextarea').value.trim();
            if (!prompt) {
                alert('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const res = await fetch('/api/prompt', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });
                const data = await res.json();

                if (data.success) {
                    const status = document.getElementById('promptStatus');
                    status.style.display = 'block';
                    status.textContent = 'í”„ë¡¬í”„íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    status.style.color = '#4caf50';
                    setTimeout(() => { status.style.display = 'none'; }, 3000);
                }
            } catch (e) {
                console.error('Failed to save prompt:', e);
                alert('í”„ë¡¬í”„íŠ¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function resetPrompt() {
            document.getElementById('promptTextarea').value = DEFAULT_PROMPT;
            savePrompt();
        }

        // ì´ˆê¸°í™”
        loadOptions();
        loadPrompt();
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ idle ë¹„ë””ì˜¤ ì¬ìƒ í™•ì¸
        window.addEventListener('load', () => {
            const idleVideo = document.getElementById('idleVideo');
            if (idleVideo && idleVideo.paused) {
                idleVideo.play().catch(err => {
                    console.log('Idle video autoplay blocked, will play on user interaction:', err);
                });
            }
        });
        
        // ì‚¬ìš©ì ìƒí˜¸ì‘ìš© í›„ idle ë¹„ë””ì˜¤ ì¬ìƒ ì‹œë„
        document.addEventListener('click', () => {
            const idleVideo = document.getElementById('idleVideo');
            if (idleVideo && idleVideo.paused && idleVideo.style.visibility !== 'hidden') {
                idleVideo.play().catch(err => {
                    console.error('Idle video play failed:', err);
                });
            }
        }, { once: true });
    </script>
</body>
</html>
