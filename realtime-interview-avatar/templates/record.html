<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì•„ë°”íƒ€ ì˜ìƒ ë…¹í™”</title>
    <link rel="icon" href="data:,">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 15px 0;
        }

        header h1 {
            font-size: 2.2em;
            background: linear-gradient(90deg, #ff6b6b, #feca57);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        header p {
            color: #888;
            font-size: 1.1em;
        }

        .nav-links {
            margin-top: 12px;
        }

        .nav-links a {
            color: #00d2ff;
            text-decoration: none;
            margin: 0 15px;
            font-size: 1em;
        }

        .nav-links a:hover {
            text-decoration: underline;
        }

        /* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */
        .tab-nav {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .tab-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.1);
            color: #aaa;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .tab-btn.active {
            background: linear-gradient(90deg, #ff6b6b, #feca57);
            color: #fff;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-top: 20px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .panel h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #feca57;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #aaa;
            font-size: 0.95em;
        }

        select, input, textarea, button {
            width: 100%;
            padding: 12px 16px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 1em;
            transition: all 0.3s;
        }

        textarea {
            min-height: 150px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.5;
        }

        textarea.batch-input {
            min-height: 300px;
            font-family: 'Consolas', monospace;
            font-size: 0.9em;
        }

        select:hover, select:focus,
        input:hover, input:focus,
        textarea:hover, textarea:focus {
            border-color: #feca57;
            outline: none;
        }

        select option {
            background: #1a1a2e;
            color: #fff;
        }

        button.primary {
            background: linear-gradient(90deg, #ff6b6b, #feca57);
            border: none;
            font-weight: bold;
            cursor: pointer;
            margin-top: 8px;
        }

        button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(254, 202, 87, 0.4);
        }

        button.primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
        }

        button.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        button.danger {
            background: linear-gradient(90deg, #e74c3c, #c0392b);
            border: none;
            cursor: pointer;
        }

        .video-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .progress-container {
            margin-top: 15px;
            display: none;
        }

        .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #feca57);
            width: 0%;
            transition: width 0.3s;
        }

        .status-text {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            color: #aaa;
            font-size: 0.9em;
        }

        .settings-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .settings-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
        }

        /* ë°°ì¹˜ ì‘ì—… ëª©ë¡ */
        .batch-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .batch-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            gap: 12px;
        }

        .batch-item.processing {
            border-color: #feca57;
            background: rgba(254, 202, 87, 0.1);
        }

        .batch-item.completed {
            border-color: #4caf50;
            background: rgba(76, 175, 80, 0.1);
        }

        .batch-item.error {
            border-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .batch-item .number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.85em;
            flex-shrink: 0;
        }

        .batch-item.completed .number {
            background: #4caf50;
        }

        .batch-item.processing .number {
            background: #feca57;
            color: #000;
        }

        .batch-item .info {
            flex: 1;
            min-width: 0;
        }

        .batch-item .text {
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: #fff;
        }

        .batch-item .meta {
            font-size: 0.8em;
            color: #888;
            margin-top: 3px;
        }

        .batch-item .actions {
            display: flex;
            gap: 6px;
            flex-shrink: 0;
        }

        .batch-item .actions button {
            width: auto;
            padding: 6px 12px;
            font-size: 0.8em;
        }

        .btn-play {
            background: linear-gradient(90deg, #00d2ff, #3a7bd5) !important;
            border: none !important;
        }

        .btn-download {
            background: linear-gradient(90deg, #11998e, #38ef7d) !important;
            border: none !important;
        }

        /* ë°°ì¹˜ ì§„í–‰ ìƒí™© */
        .batch-progress {
            background: rgba(254, 202, 87, 0.1);
            border: 1px solid rgba(254, 202, 87, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }

        .batch-progress.active {
            display: block;
        }

        .batch-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .batch-progress-title {
            font-weight: bold;
            color: #feca57;
        }

        .batch-progress-count {
            color: #aaa;
            font-size: 0.9em;
        }

        .batch-progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .batch-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b6b, #feca57);
            width: 0%;
            transition: width 0.5s;
        }

        .batch-progress-status {
            margin-top: 8px;
            font-size: 0.9em;
            color: #aaa;
        }

        /* ë¹„ë””ì˜¤ ëª©ë¡ */
        .video-list {
            max-height: 250px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .video-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .video-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .video-item .info {
            flex: 1;
        }

        .video-item .name {
            font-weight: bold;
            color: #fff;
            font-size: 0.95em;
        }

        .video-item .meta {
            font-size: 0.8em;
            color: #888;
            margin-top: 2px;
        }

        .video-item .actions {
            display: flex;
            gap: 6px;
        }

        .video-item .actions button {
            width: auto;
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .char-count {
            text-align: right;
            font-size: 0.85em;
            color: #888;
            margin-top: 4px;
        }

        .char-count.warning {
            color: #ff6b6b;
        }

        .tips {
            background: rgba(0, 210, 255, 0.1);
            border: 1px solid rgba(0, 210, 255, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
        }

        .tips h3 {
            color: #00d2ff;
            margin-bottom: 8px;
            font-size: 1em;
        }

        .tips ul {
            list-style: none;
            padding: 0;
        }

        .tips li {
            padding: 4px 0;
            color: #aaa;
            font-size: 0.9em;
        }

        .tips li::before {
            content: "â€¢";
            color: #00d2ff;
            margin-right: 8px;
        }

        .queue-status {
            display: none;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: rgba(254, 202, 87, 0.1);
            border-radius: 8px;
            margin-top: 12px;
            border: 1px solid rgba(254, 202, 87, 0.3);
        }

        .queue-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(254, 202, 87, 0.3);
            border-top-color: #feca57;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .queue-message {
            font-weight: bold;
            color: #feca57;
            font-size: 0.95em;
        }

        /* ì „ì²´ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ */
        .download-all-btn {
            background: linear-gradient(90deg, #11998e, #38ef7d) !important;
            margin-top: 10px;
        }

        /* íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­ */
        .file-drop-zone {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.02);
        }

        .file-drop-zone:hover {
            border-color: #feca57;
            background: rgba(254, 202, 87, 0.05);
        }

        .file-drop-zone.dragover {
            border-color: #feca57;
            background: rgba(254, 202, 87, 0.1);
        }

        .file-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .file-text {
            color: #fff;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .file-info {
            color: #888;
            font-size: 0.9em;
        }

        .selected-file {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            background: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.3);
            border-radius: 8px;
            margin-top: 10px;
        }

        .selected-file .file-name {
            flex: 1;
            color: #4caf50;
            font-weight: bold;
        }

        .selected-file .file-size {
            color: #888;
            font-size: 0.9em;
        }

        .selected-file .file-remove {
            width: 30px;
            height: 30px;
            padding: 0;
            border-radius: 50%;
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.5);
            color: #e74c3c;
            cursor: pointer;
            font-size: 1em;
        }

        .selected-file .file-remove:hover {
            background: rgba(231, 76, 60, 0.4);
        }

        /* ì—…ë¡œë“œ ê²°ê³¼ ì¹´ë“œ */
        .result-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            color: #888;
            font-size: 0.9em;
            flex-shrink: 0;
            width: 80px;
        }

        .result-value {
            color: #fff;
            font-size: 0.95em;
            text-align: right;
            flex: 1;
        }

        .result-link {
            color: #00d2ff;
            text-decoration: none;
        }

        .result-link:hover {
            text-decoration: underline;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AI ì•„ë°”íƒ€ ì˜ìƒ ë…¹í™”</h1>
            <p>í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ë©´ AI ì•„ë°”íƒ€ê°€ ë§í•˜ëŠ” ì˜ìƒì„ ìƒì„±í•©ë‹ˆë‹¤</p>
            <div class="nav-links">
                <a href="/">â† ë©´ì ‘ ì‹œë®¬ë ˆì´ì…˜</a>
                <a href="/record">ì˜ìƒ ë…¹í™”</a>
            </div>
        </header>

        <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('single')">ë…¹í™”</button>
            <button class="tab-btn" onclick="switchTab('uncached')">ë¯¸ìºì‹œ í•­ëª©</button>
            <button class="tab-btn" onclick="switchTab('audioUncached')">ìŒì„± ë¯¸ìºì‹œ</button>
        </div>

        <!-- ë‹¨ì¼ ë…¹í™” íƒ­ -->
        <div id="singleTab" class="tab-content active">
            <div class="main-content">
                <!-- ì™¼ìª½: ì…ë ¥ íŒ¨ë„ -->
                <div class="panel">
                    <h2>í…ìŠ¤íŠ¸ ì…ë ¥</h2>

                    <div class="settings-row">
                        <div class="form-group">
                            <label>TTS ì—”ì§„</label>
                            <select id="ttsEngineSelect" onchange="updateVoiceOptions()">
                                <option value="">ë¡œë”© ì¤‘...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ìŒì„±</label>
                            <select id="ttsVoiceSelect">
                                <option value="">ì—”ì§„ ì„ íƒ</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="form-group">
                            <label>ì¶œë ¥ í•´ìƒë„</label>
                            <select id="resolutionSelect">
                                <option value="720p" selected>720p (ê³ í’ˆì§ˆ)</option>
                                <option value="480p">480p (ê¶Œì¥)</option>
                                <option value="360p">360p (ë¹ ë¥¸ ì†ë„)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ì¶œë ¥ í¬ë§·</label>
                            <select id="formatSelect">
                                <option value="mp4" selected>MP4 (í˜¸í™˜ì„±)</option>
                                <option value="webm">WebM (ì›¹ ìµœì í™”)</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="form-group">
                            <label>ì†ë„/í’ˆì§ˆ</label>
                            <select id="frameSkipSelect">
                                <option value="1" selected>ê³ í’ˆì§ˆ (ê¸°ë³¸)</option>
                                <option value="2">ë¹ ë¦„ (2ë°°ì†)</option>
                                <option value="3">ìµœê³ ì† (3ë°°ì†)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>íŒŒì¼ëª… (ì„ íƒ)</label>
                            <input type="text" id="filenameInput" placeholder="ìë™ ìƒì„±">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ëŒ€ì‚¬ ì…ë ¥</label>
                        <select id="exampleTextSelect" onchange="selectExampleText()" style="width: 100%; padding: 10px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #333; background: #1e1e1e; color: #fff; font-size: 0.9rem;">
                            <option value="">í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ ì„ íƒ...</option>
                            <option value="ì•ˆë…•í•˜ì„¸ìš”">ì§§ì€ ì¸ì‚¬ (1ë¬¸ì¥)</option>
                            <option value="ì•ˆë…•í•˜ì„¸ìš”. ë§Œë‚˜ì„œ ë°˜ê°‘ìŠµë‹ˆë‹¤.">ê¸°ë³¸ ì¸ì‚¬ (2ë¬¸ì¥)</option>
                            <option value="ì•ˆë…•í•˜ì„¸ìš”. ì €ëŠ” AI ë©´ì ‘ê´€ì…ë‹ˆë‹¤. ì˜¤ëŠ˜ ë©´ì ‘ì— ì°¸ì„í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.">ê¸´ ì¸ì‚¬ (3ë¬¸ì¥)</option>
                            <option value="ìê¸°ì†Œê°œë¥¼ í•´ ì£¼ì‹œê² ì–´ìš”?">ë©´ì ‘ ì§ˆë¬¸ - ìê¸°ì†Œê°œ</option>
                            <option value="ì§€ì› ë™ê¸°ì— ëŒ€í•´ ë§ì”€í•´ ì£¼ì„¸ìš”.">ë©´ì ‘ ì§ˆë¬¸ - ì§€ì› ë™ê¸°</option>
                            <option value="ë³¸ì¸ì˜ ê°•ì ê³¼ ì•½ì ì— ëŒ€í•´ ë§ì”€í•´ ì£¼ì„¸ìš”.">ë©´ì ‘ ì§ˆë¬¸ - ê°•ì /ì•½ì </option>
                            <option value="5ë…„ í›„ ìì‹ ì˜ ëª¨ìŠµì„ ì–´ë–»ê²Œ ê·¸ë¦¬ê³  ê³„ì‹ ê°€ìš”?">ë©´ì ‘ ì§ˆë¬¸ - ë¯¸ë˜ ë¹„ì „</option>
                            <option value="ë§ˆì§€ë§‰ìœ¼ë¡œ í•˜ê³  ì‹¶ì€ ë§ì”€ì´ ìˆìœ¼ì‹ ê°€ìš”?">ë©´ì ‘ ì§ˆë¬¸ - ë§ˆë¬´ë¦¬</option>
                            <option value="ë„¤, ì¢‹ì€ ë‹µë³€ ê°ì‚¬í•©ë‹ˆë‹¤. ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ ë„˜ì–´ê°€ê² ìŠµë‹ˆë‹¤.">ë©´ì ‘ê´€ í”¼ë“œë°±</option>
                            <option value="ì˜¤ëŠ˜ ë©´ì ‘ì€ ì—¬ê¸°ê¹Œì§€ì…ë‹ˆë‹¤. ê²°ê³¼ëŠ” ì¶”í›„ ê°œë³„ ì—°ë½ ë“œë¦¬ê² ìŠµë‹ˆë‹¤. ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤.">ë©´ì ‘ ì¢…ë£Œ ë©˜íŠ¸</option>
                        </select>
                        <textarea id="scriptInput" placeholder="ì•„ë°”íƒ€ê°€ ë§í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                        <div class="char-count" id="charCount">0 / 1000ì</div>
                    </div>

                    <button class="primary" id="generateBtn" onclick="generateVideo()">
                        ğŸ¬ ì˜ìƒ ìƒì„±
                    </button>

                    <div class="progress-container" id="progressContainer">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="status-text">
                            <span id="statusText">ì¤€ë¹„ ì¤‘...</span>
                            <span id="elapsedTime"></span>
                        </div>
                    </div>

                    <div class="queue-status" id="queueStatus">
                        <div class="queue-spinner"></div>
                        <div class="queue-message" id="queueMessage">ëŒ€ê¸° ì¤‘...</div>
                    </div>
                </div>

                <!-- ì˜¤ë¥¸ìª½: ë¯¸ë¦¬ë³´ê¸° -->
                <div class="panel">
                    <h2>ë¯¸ë¦¬ë³´ê¸°</h2>
                    <div class="video-container">
                        <video id="previewVideo" controls></video>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-download secondary" id="downloadBtn" onclick="downloadVideo()" disabled>
                            ğŸ“¥ ë‹¤ìš´ë¡œë“œ
                        </button>
                        <button class="secondary" onclick="copyVideoUrl()" id="copyUrlBtn" disabled>
                            ğŸ”— URL ë³µì‚¬
                        </button>
                        <button class="secondary" id="loopBtn" onclick="toggleLoop()" disabled>
                            ğŸ” ë°˜ë³µ ì¬ìƒ
                        </button>
                    </div>

                    <h2 style="margin-top: 20px;">ìƒì„±ëœ ì˜ìƒ</h2>
                    <div class="video-list" id="videoList">
                        <p style="color: #888; text-align: center; padding: 15px;">
                            ì•„ì§ ìƒì„±ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤
                        </p>
                    </div>

                    <!-- ìºì‹œ ì—…ë¡œë“œ ì„¹ì…˜ -->
                    <h2 style="margin-top: 20px;">ğŸ“¤ ìºì‹œì— ì—…ë¡œë“œ</h2>
                    <div class="tips" style="margin-bottom: 15px; background: rgba(0, 210, 255, 0.05); border-color: rgba(0, 210, 255, 0.2);">
                        <p style="color: #aaa; font-size: 0.9em; margin: 0;">
                            ìƒì„±ëœ ì˜ìƒì„ ì„œë²„ ìºì‹œì— ì—…ë¡œë“œí•˜ì—¬ ë¹ ë¥´ê²Œ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </p>
                    </div>

                    <div class="form-group">
                        <label>ìºì‹œí•  í…ìŠ¤íŠ¸</label>
                        <input type="text" id="uploadText" placeholder="ì´ ì˜ìƒì— í•´ë‹¹í•˜ëŠ” ëŒ€ì‚¬ (ìºì‹œ í‚¤ ìƒì„±ìš©)">
                    </div>

                    <div class="form-group">
                        <label>ë¹„ë””ì˜¤ íŒŒì¼</label>
                        <div class="file-upload-area" id="fileUploadArea">
                            <input type="file" id="uploadVideoFile" accept="video/mp4,video/webm" style="display: none;" onchange="handleFileSelect(event)">
                            <div class="file-drop-zone" id="fileDropZone" onclick="document.getElementById('uploadVideoFile').click()" style="padding: 20px 15px;">
                                <div class="file-text" style="font-size: 0.95em;">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ ë“œë˜ê·¸</div>
                                <div class="file-info" style="font-size: 0.8em;">MP4/WebM (ìµœëŒ€ 100MB)</div>
                            </div>
                            <div class="selected-file" id="selectedFile" style="display: none;">
                                <span class="file-name" id="selectedFileName"></span>
                                <span class="file-size" id="selectedFileSize"></span>
                                <button class="file-remove" onclick="clearFileSelection()">âœ•</button>
                            </div>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="form-group">
                            <label>ì†ŒìŠ¤ ìœ í˜•</label>
                            <select id="uploadSource">
                                <option value="lipsync" selected>Lipsync</option>
                                <option value="heygen">HeyGen</option>
                            </select>
                        </div>
                        <button class="primary" id="uploadBtn" onclick="uploadVideoToCache()" style="margin-top: 22px;">
                            ğŸ“¤ ì—…ë¡œë“œ
                        </button>
                    </div>

                    <div class="progress-container" id="uploadProgressContainer">
                        <div class="progress-bar">
                            <div class="progress-fill" id="uploadProgressFill"></div>
                        </div>
                        <div class="status-text">
                            <span id="uploadStatusText">ì¤€ë¹„ ì¤‘...</span>
                            <span id="uploadProgressPercent"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë¯¸ìºì‹œ í•­ëª© íƒ­ -->
        <div id="uncachedTab" class="tab-content">
            <div class="main-content">
                <!-- ì™¼ìª½: í•„í„° ë° ì¡°íšŒ -->
                <div class="panel">
                    <h2>ë¯¸ìºì‹œ í•­ëª© ì¡°íšŒ</h2>
                    <p style="color: #888; margin-bottom: 15px;">ì•„ì§ ìºì‹œë˜ì§€ ì•Šì€ í…ìŠ¤íŠ¸ í•­ëª©ì„ ì¡°íšŒí•˜ê³  ë…¹í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

                    <div class="settings-row">
                        <div class="form-group">
                            <label>ì†ŒìŠ¤ ìœ í˜•</label>
                            <select id="uncachedSource">
                                <option value="lipsync" selected>Lipsync</option>
                                <option value="heygen">HeyGen</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ê¸°ê´€ ìœ í˜•</label>
                            <select id="uncachedOrgType">
                                <option value="">ì „ì²´</option>
                                <option value="company">ê¸°ì—…</option>
                                <option value="public">ê³µê³µê¸°ê´€</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-row">
                        <div class="form-group">
                            <label>ì§ë¬´ëª…</label>
                            <input type="text" id="uncachedJobName" placeholder="ì˜ˆ: ê°œë°œì, ë§ˆì¼€íŒ…">
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end; padding-bottom: 4px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="uncachedIncludeStandard" checked style="width: auto; margin-right: 8px;">
                                í‘œì¤€ ì§ˆë¬¸ í¬í•¨
                            </label>
                        </div>
                    </div>

                    <button class="primary" id="queryUncachedBtn" onclick="queryUncachedItems()">
                        ğŸ” ë¯¸ìºì‹œ í•­ëª© ì¡°íšŒ
                    </button>

                    <div class="tips" style="margin-top: 15px;">
                        <h3>ğŸ’¡ ë…¹í™” ì„¤ì •</h3>
                    </div>

                    <div class="settings-row-3" style="margin-top: 10px;">
                        <div class="form-group">
                            <label>TTS ì—”ì§„</label>
                            <select id="uncachedTtsEngine" onchange="updateUncachedVoiceOptions()">
                                <option value="">ë¡œë”© ì¤‘...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ìŒì„±</label>
                            <select id="uncachedTtsVoice">
                                <option value="">ì—”ì§„ ì„ íƒ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>í•´ìƒë„</label>
                            <select id="uncachedResolution">
                                <option value="720p" selected>720p</option>
                                <option value="480p">480p</option>
                                <option value="360p">360p</option>
                            </select>
                        </div>
                    </div>

                    <div class="batch-progress" id="uncachedBatchProgress">
                        <div class="batch-progress-header">
                            <span class="batch-progress-title">ë…¹í™” ì§„í–‰ ì¤‘</span>
                            <span class="batch-progress-count" id="uncachedProgressCount">0 / 0</span>
                        </div>
                        <div class="batch-progress-bar">
                            <div class="batch-progress-fill" id="uncachedProgressFill"></div>
                        </div>
                        <div class="batch-progress-status" id="uncachedProgressStatus">ì¤€ë¹„ ì¤‘...</div>
                    </div>
                </div>

                <!-- ì˜¤ë¥¸ìª½: ë¯¸ìºì‹œ í•­ëª© ëª©ë¡ -->
                <div class="panel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 style="margin: 0;">ë¯¸ìºì‹œ í•­ëª© ëª©ë¡</h2>
                        <span id="uncachedCount" style="color: #888; font-size: 0.9em;">0ê°œ</span>
                    </div>

                    <div id="uncachedListEmpty" style="color: #888; text-align: center; padding: 40px;">
                        ì¡°íšŒ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¯¸ìºì‹œ í•­ëª©ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”
                    </div>

                    <div class="batch-list" id="uncachedList" style="max-height: 500px; display: none;">
                    </div>

                    <div id="uncachedActions" style="display: none; margin-top: 15px;">
                        <div class="settings-row">
                            <button class="primary" id="recordAllBtn" onclick="recordAllUncached()">
                                ğŸš€ ì „ì²´ ë…¹í™” ì‹œì‘
                            </button>
                            <button class="danger secondary" id="stopRecordingBtn" onclick="stopUncachedRecording()" disabled>
                                â¹ ì¤‘ì§€
                            </button>
                        </div>
                    </div>

                    <div class="tips" style="margin-top: 15px; background: rgba(17, 153, 142, 0.1); border-color: rgba(17, 153, 142, 0.3);">
                        <h3 style="color: #11998e;">ğŸ“ ìë™ ìºì‹œ ì—…ë¡œë“œ</h3>
                        <ul>
                            <li>ë…¹í™” ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ ìºì‹œ ì„œë²„ì— ì—…ë¡œë“œë©ë‹ˆë‹¤</li>
                            <li>ê°œë³„ í•­ëª©ì˜ "ë…¹í™”" ë²„íŠ¼ìœ¼ë¡œ ë‹¨ê±´ ë…¹í™” ê°€ëŠ¥</li>
                            <li>"ì „ì²´ ë…¹í™”"ë¡œ ëª¨ë“  ë¯¸ìºì‹œ í•­ëª© ì¼ê´„ ì²˜ë¦¬</li>
                            <li>ì¤‘ì§€ ë²„íŠ¼ í´ë¦­ ì‹œ í˜„ì¬ ì‘ì—… ì™„ë£Œ í›„ ì¤‘ì§€</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- ìŒì„± ë¯¸ìºì‹œ íƒ­ -->
        <div id="audioUncachedTab" class="tab-content">
            <div class="main-content">
                <!-- ì™¼ìª½: í•„í„° ë° ì¡°íšŒ -->
                <div class="panel">
                    <h2>ğŸ¤ ìŒì„± ë¯¸ìºì‹œ í•­ëª© ì¡°íšŒ</h2>
                    <p style="color: #888; margin-bottom: 15px;">ì•„ì§ ìŒì„±ì´ ìºì‹œë˜ì§€ ì•Šì€ í‘œì¤€ë©˜íŠ¸ë¥¼ ì¡°íšŒí•˜ê³  TTSë¡œ ë…¹ìŒí•©ë‹ˆë‹¤.</p>

                    <div class="form-group">
                        <label>ì¹´í…Œê³ ë¦¬ í•„í„° (ì„ íƒ)</label>
                        <select id="audioUncachedCategory">
                            <option value="">ì „ì²´</option>
                            <option value="greeting">ì¸ì‚¬ë§ (greeting)</option>
                            <option value="selfIntro">ìê¸°ì†Œê°œ (selfIntro)</option>
                            <option value="transition">ì „í™˜ (transition)</option>
                            <option value="transition_silent">ë¬´ìŒ ì „í™˜ (transition_silent)</option>
                            <option value="transition_followup">ê¼¬ë¦¬ì§ˆë¬¸ ì „í™˜ (transition_followup)</option>
                            <option value="transition_timeout">ì‹œê°„ì´ˆê³¼ ì „í™˜ (transition_timeout)</option>
                            <option value="ending">ì¢…ë£Œ (ending)</option>
                            <option value="followup_fallback">ê¼¬ë¦¬ì§ˆë¬¸ í´ë°± (followup_fallback)</option>
                        </select>
                    </div>

                    <button class="primary" id="queryAudioUncachedBtn" onclick="queryAudioUncachedItems()">
                        ğŸ” ìŒì„± ë¯¸ìºì‹œ í•­ëª© ì¡°íšŒ
                    </button>

                    <div class="tips" style="margin-top: 15px;">
                        <h3>ğŸ’¡ TTS ë…¹ìŒ ì„¤ì •</h3>
                    </div>

                    <div class="settings-row" style="margin-top: 10px;">
                        <div class="form-group">
                            <label>TTS ì—”ì§„</label>
                            <select id="audioUncachedTtsEngine" onchange="updateAudioUncachedVoiceOptions()">
                                <option value="">ë¡œë”© ì¤‘...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ìŒì„±</label>
                            <select id="audioUncachedTtsVoice">
                                <option value="">ì—”ì§„ ì„ íƒ</option>
                            </select>
                        </div>
                    </div>

                    <div class="batch-progress" id="audioUncachedBatchProgress">
                        <div class="batch-progress-header">
                            <span class="batch-progress-title">ğŸ¤ TTS ë…¹ìŒ ì§„í–‰ ì¤‘</span>
                            <span class="batch-progress-count" id="audioUncachedProgressCount">0 / 0</span>
                        </div>
                        <div class="batch-progress-bar">
                            <div class="batch-progress-fill" id="audioUncachedProgressFill"></div>
                        </div>
                        <div class="batch-progress-status" id="audioUncachedProgressStatus">ì¤€ë¹„ ì¤‘...</div>
                    </div>

                    <!-- ì˜¤ë””ì˜¤ ë¯¸ë¦¬ë“£ê¸° -->
                    <div style="margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <h3 style="color: #feca57; margin-bottom: 10px; font-size: 1em;">ğŸ”Š ë¯¸ë¦¬ë“£ê¸°</h3>
                        <audio id="audioPreview" controls style="width: 100%;"></audio>
                    </div>
                </div>

                <!-- ì˜¤ë¥¸ìª½: ìŒì„± ë¯¸ìºì‹œ í•­ëª© ëª©ë¡ -->
                <div class="panel">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h2 style="margin: 0;">ğŸ¤ ìŒì„± ë¯¸ìºì‹œ ëª©ë¡</h2>
                        <span id="audioUncachedCount" style="color: #888; font-size: 0.9em;">0ê°œ</span>
                    </div>

                    <div id="audioUncachedListEmpty" style="color: #888; text-align: center; padding: 40px;">
                        ì¡°íšŒ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìŒì„± ë¯¸ìºì‹œ í•­ëª©ì„ ë¶ˆëŸ¬ì˜¤ì„¸ìš”
                    </div>

                    <div class="batch-list" id="audioUncachedList" style="max-height: 500px; display: none;">
                    </div>

                    <div id="audioUncachedActions" style="display: none; margin-top: 15px;">
                        <div class="settings-row">
                            <button class="primary" id="recordAllAudioBtn" onclick="recordAllAudioUncached()">
                                ğŸš€ ì „ì²´ TTS ë…¹ìŒ ì‹œì‘
                            </button>
                            <button class="danger secondary" id="stopAudioRecordingBtn" onclick="stopAudioUncachedRecording()" disabled>
                                â¹ ì¤‘ì§€
                            </button>
                        </div>
                    </div>

                    <div class="tips" style="margin-top: 15px; background: rgba(17, 153, 142, 0.1); border-color: rgba(17, 153, 142, 0.3);">
                        <h3 style="color: #11998e;">ğŸ“ ìë™ ìºì‹œ ì—…ë¡œë“œ</h3>
                        <ul>
                            <li>TTSë¡œ ìŒì„± ìƒì„± í›„ ìë™ìœ¼ë¡œ ìºì‹œ ì„œë²„ì— ì—…ë¡œë“œë©ë‹ˆë‹¤</li>
                            <li>ê°œë³„ í•­ëª©ì˜ "ë…¹ìŒ" ë²„íŠ¼ìœ¼ë¡œ ë‹¨ê±´ ë…¹ìŒ ê°€ëŠ¥</li>
                            <li>"ì „ì²´ ë…¹ìŒ"ìœ¼ë¡œ ëª¨ë“  ë¯¸ìºì‹œ í•­ëª© ì¼ê´„ ì²˜ë¦¬</li>
                            <li>ì˜¤ë¥˜ ë°œìƒ ì‹œ ë°°ì¹˜ ìë™ ì¤‘ì§€</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let socket = null;
        let clientSid = null;
        let ttsEngines = {};
        let currentVideoUrl = null;
        let generatedVideos = [];
        let isLooping = false;  // ë°˜ë³µ ì¬ìƒ ìƒíƒœ

        // ë¯¸ìºì‹œ ë…¹í™” ê´€ë ¨ ë³€ìˆ˜
        let uncachedItems = [];
        let uncachedCurrentIndex = 0;
        let uncachedRunning = false;
        let uncachedResults = [];
        let uncachedBatchMode = false;  // ë°°ì¹˜ ëª¨ë“œ ì—¬ë¶€ (ì¤‘ì§€ í›„ì—ë„ ìœ ì§€)

        // ìŒì„± ë¯¸ìºì‹œ ë…¹ìŒ ê´€ë ¨ ë³€ìˆ˜
        let audioUncachedItems = [];
        let audioUncachedCurrentIndex = 0;
        let audioUncachedRunning = false;
        let audioUncachedResults = [];
        let audioUncachedBatchMode = false;

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initSocket();
            loadOptions();
            setupTextareas();
            initUncachedTab();
            initUploadSection();
        });

        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            document.querySelector(`.tab-btn[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // WebSocket ì´ˆê¸°í™”
        function initSocket() {
            socket = io();

            socket.on('connect', () => {
                console.log('WebSocket ì—°ê²°ë¨');
            });

            socket.on('connected', (data) => {
                clientSid = data.sid;
                console.log('í´ë¼ì´ì–¸íŠ¸ SID:', clientSid);
            });

            socket.on('queue_update', (data) => {
                if (uncachedRunning) {
                    updateUncachedItemStatus(uncachedCurrentIndex, 'processing', data.message);
                } else {
                    document.getElementById('queueStatus').style.display = 'flex';
                    document.getElementById('queueMessage').textContent = data.message;
                }
            });

            socket.on('status', (data) => {
                if (uncachedRunning) {
                    updateUncachedItemStatus(uncachedCurrentIndex, 'processing', data.message);
                    document.getElementById('uncachedProgressStatus').textContent =
                        `[${uncachedCurrentIndex + 1}/${uncachedItems.length}] ${data.message}`;
                } else {
                    document.getElementById('progressContainer').style.display = 'block';
                    document.getElementById('queueStatus').style.display = 'none';
                    document.getElementById('statusText').textContent = data.message;
                    document.getElementById('progressFill').style.width = data.progress + '%';
                    if (data.elapsed) {
                        document.getElementById('elapsedTime').textContent = data.elapsed.toFixed(1) + 'ì´ˆ';
                    }
                }
            });

            socket.on('complete', async (data) => {
                console.log('ìƒì„± ì™„ë£Œ:', data);

                if (uncachedBatchMode) {
                    // ë¯¸ìºì‹œ ë…¹í™” ëª¨ë“œ (ë°°ì¹˜ ì§„í–‰ ì¤‘ì´ê±°ë‚˜ ì¤‘ì§€ëœ ìƒíƒœ)
                    uncachedResults[uncachedCurrentIndex] = {
                        url: data.video_url,
                        success: true
                    };
                    updateUncachedItemStatus(uncachedCurrentIndex, 'completed', 'ë…¹í™” ì™„ë£Œ, ì—…ë¡œë“œ ì¤‘...', data.video_url);
                    document.getElementById('uncachedProgressStatus').textContent =
                        `[${uncachedCurrentIndex + 1}/${uncachedItems.length}] ìºì‹œ ì—…ë¡œë“œ ì¤‘...`;

                    // ìºì‹œì— ì—…ë¡œë“œ (ì™„ë£Œ ëŒ€ê¸°)
                    const uploadResult = await uploadToCache(uncachedItems[uncachedCurrentIndex].text, data.video_url);

                    if (!uploadResult.success) {
                        // ì—…ë¡œë“œ ì‹¤íŒ¨ - ë°°ì¹˜ ì¤‘ì§€
                        uncachedResults[uncachedCurrentIndex].success = false;
                        uncachedResults[uncachedCurrentIndex].error = uploadResult.error;
                        updateUncachedItemStatus(uncachedCurrentIndex, 'error', 'ì—…ë¡œë“œ ì‹¤íŒ¨: ' + uploadResult.error);
                        document.getElementById('uncachedProgressStatus').textContent =
                            `ì—…ë¡œë“œ ì‹¤íŒ¨! ${uploadResult.error}`;
                        finishUncachedRecording();
                        return;
                    }

                    // ì—…ë¡œë“œ ì„±ê³µ - ìƒíƒœ ì—…ë°ì´íŠ¸
                    updateUncachedItemStatus(uncachedCurrentIndex, 'completed', 'ì™„ë£Œ (ìºì‹œë¨)', data.video_url);

                    // ë‹¤ìŒ í•­ëª© ì²˜ë¦¬
                    uncachedCurrentIndex++;
                    updateUncachedProgress();

                    if (uncachedCurrentIndex < uncachedItems.length && uncachedRunning) {
                        setTimeout(() => processNextUncachedItem(), 500);
                    } else {
                        finishUncachedRecording();
                    }
                } else {
                    // ë‹¨ì¼ ëª¨ë“œ
                    document.getElementById('progressFill').style.width = '100%';
                    document.getElementById('statusText').textContent = 'ì™„ë£Œ!';
                    document.getElementById('generateBtn').disabled = false;
                    document.getElementById('generateBtn').textContent = 'ğŸ¬ ì˜ìƒ ìƒì„±';

                    currentVideoUrl = data.video_url;
                    const previewVideo = document.getElementById('previewVideo');
                    previewVideo.src = currentVideoUrl + '?' + Date.now();
                    previewVideo.load();
                    previewVideo.play();

                    document.getElementById('downloadBtn').disabled = false;
                    document.getElementById('copyUrlBtn').disabled = false;

                    addVideoToList(data);

                    setTimeout(() => {
                        document.getElementById('progressContainer').style.display = 'none';
                    }, 3000);
                }
            });

            socket.on('error', (data) => {
                console.error('ì˜¤ë¥˜:', data);

                // ì˜¤ë¥˜ ë‹¨ê³„ íŒŒì•… (TTS ë˜ëŠ” ë¦½ì‹±í¬)
                const errorStage = data.stage || 'ì•Œ ìˆ˜ ì—†ìŒ';
                const errorMessage = data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
                const detailedError = `[${errorStage}] ${errorMessage}`;

                console.error(`[ë°°ì¹˜ ì˜¤ë¥˜] ë‹¨ê³„: ${errorStage}, ë©”ì‹œì§€: ${errorMessage}`);

                if (uncachedBatchMode) {
                    // ë¯¸ìºì‹œ ë…¹í™” ëª¨ë“œ - ì˜¤ë¥˜ ë°œìƒ ì‹œ ë°°ì¹˜ ì¤‘ì§€
                    uncachedResults[uncachedCurrentIndex] = {
                        success: false,
                        error: detailedError
                    };
                    updateUncachedItemStatus(uncachedCurrentIndex, 'error', detailedError);

                    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                    updateUncachedProgress();

                    // ë°°ì¹˜ ì¤‘ì§€ (ë‹¤ìŒ í•­ëª©ìœ¼ë¡œ ì§„í–‰í•˜ì§€ ì•ŠìŒ)
                    document.getElementById('uncachedProgressStatus').textContent =
                        `âŒ ì˜¤ë¥˜ë¡œ ì¤‘ì§€ë¨: ${detailedError}`;
                    console.error(`[ë°°ì¹˜ ì¤‘ì§€] í•­ëª© ${uncachedCurrentIndex + 1}ì—ì„œ ì˜¤ë¥˜ ë°œìƒ - ${detailedError}`);
                    finishUncachedRecording();
                } else {
                    document.getElementById('statusText').textContent = 'ì˜¤ë¥˜: ' + errorMessage;
                    document.getElementById('generateBtn').disabled = false;
                    document.getElementById('generateBtn').textContent = 'ğŸ¬ ì˜ìƒ ìƒì„±';
                    document.getElementById('queueStatus').style.display = 'none';
                }
            });
        }

        // CosyVoice ì—°ê²° í…ŒìŠ¤íŠ¸
        async function checkCosyVoiceConnection() {
            try {
                const response = await fetch('/api/check_cosyvoice', {
                    method: 'GET',
                    timeout: 5000
                });
                const result = await response.json();

                if (!result.connected) {
                    console.error('[CosyVoice] ì—°ê²° ì‹¤íŒ¨:', result.error || 'ì„œë²„ ì‘ë‹µ ì—†ìŒ');
                    console.warn('[CosyVoice] URL:', result.url || 'N/A');
                    return false;
                }
                console.log('[CosyVoice] ì—°ê²° ì„±ê³µ');
                return true;
            } catch (e) {
                console.error('[CosyVoice] ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', e.message);
                return false;
            }
        }

        // ì˜µì…˜ ë¡œë“œ
        async function loadOptions() {
            try {
                // TTS ì—”ì§„ ë¡œë“œ
                const enginesRes = await fetch('/api/tts_engines');
                const engines = await enginesRes.json();
                ttsEngines = {};
                engines.forEach(e => { ttsEngines[e.id] = e; });

                // CosyVoice ì—°ê²° í…ŒìŠ¤íŠ¸ (1íšŒ ì‹œë„)
                const cosyvoiceEngine = engines.find(e => e.id === 'cosyvoice');
                const elevenlabsEngine = engines.find(e => e.id === 'elevenlabs' && e.available);

                let selectedEngine = engines[0]?.id;

                if (cosyvoiceEngine && cosyvoiceEngine.available) {
                    const isConnected = await checkCosyVoiceConnection();
                    if (!isConnected && elevenlabsEngine) {
                        console.warn('[TTS] CosyVoice ì—°ê²° ì‹¤íŒ¨ â†’ ElevenLabsë¡œ ìë™ ì „í™˜');
                        selectedEngine = 'elevenlabs';
                    } else if (isConnected) {
                        selectedEngine = 'cosyvoice';
                    }
                } else if (elevenlabsEngine) {
                    selectedEngine = 'elevenlabs';
                }

                const engineOptions = engines.map(e =>
                    `<option value="${e.id}" ${e.id === selectedEngine ? 'selected' : ''}>${e.name}</option>`
                ).join('');

                document.getElementById('ttsEngineSelect').innerHTML = engineOptions;
                document.getElementById('uncachedTtsEngine').innerHTML = engineOptions;
                document.getElementById('audioUncachedTtsEngine').innerHTML = engineOptions;

                updateVoiceOptions();
                updateUncachedVoiceOptions();
                updateAudioUncachedVoiceOptions();

            } catch (error) {
                console.error('ì˜µì…˜ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ìŒì„± ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updateVoiceOptions() {
            const engineId = document.getElementById('ttsEngineSelect').value;
            const voiceSelect = document.getElementById('ttsVoiceSelect');
            updateVoiceSelect(engineId, voiceSelect);
        }

        function updateUncachedVoiceOptions() {
            const engineId = document.getElementById('uncachedTtsEngine').value;
            const voiceSelect = document.getElementById('uncachedTtsVoice');
            updateVoiceSelect(engineId, voiceSelect);
        }

        function updateVoiceSelect(engineId, voiceSelect) {
            if (!engineId || !ttsEngines[engineId]) {
                voiceSelect.innerHTML = '<option value="">ì—”ì§„ ì„ íƒ</option>';
                return;
            }

            const voices = ttsEngines[engineId].voices;
            if (Array.isArray(voices)) {
                voiceSelect.innerHTML = voices.map(voice =>
                    `<option value="${voice}">${voice}</option>`
                ).join('');
            } else {
                voiceSelect.innerHTML = Object.entries(voices).map(([id, name]) =>
                    `<option value="${id}">${name}</option>`
                ).join('');
            }
        }

        // í…ìŠ¤íŠ¸ ì˜ì—­ ì„¤ì •
        function setupTextareas() {
            const textarea = document.getElementById('scriptInput');
            const charCount = document.getElementById('charCount');

            textarea.addEventListener('input', () => {
                const len = textarea.value.length;
                charCount.textContent = `${len} / 1000ì`;
                charCount.className = len > 1000 ? 'char-count warning' : 'char-count';
            });
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== ë¯¸ìºì‹œ í•­ëª© ê¸°ëŠ¥ ==========

        // ë¯¸ìºì‹œ íƒ­ ì´ˆê¸°í™”
        function initUncachedTab() {
            // ì´ˆê¸°í™” (API í‚¤ëŠ” ì„œë²„ í”„ë¡ì‹œì—ì„œ ì²˜ë¦¬)
        }

        // ë¯¸ìºì‹œ í•­ëª© ì¡°íšŒ
        async function queryUncachedItems() {
            const source = document.getElementById('uncachedSource').value;
            const orgType = document.getElementById('uncachedOrgType').value;
            const jobName = document.getElementById('uncachedJobName').value.trim();
            const includeStandard = document.getElementById('uncachedIncludeStandard').checked;

            // URL íŒŒë¼ë¯¸í„° êµ¬ì„±
            const params = new URLSearchParams();
            params.append('source', source);
            if (orgType) params.append('org_type', orgType);
            if (jobName) params.append('job_name', jobName);
            params.append('include_standard', includeStandard);

            document.getElementById('queryUncachedBtn').disabled = true;
            document.getElementById('queryUncachedBtn').textContent = 'ì¡°íšŒ ì¤‘...';

            try {
                // ë¡œì»¬ í”„ë¡ì‹œ ì‚¬ìš© (CORS ìš°íšŒ)
                const response = await fetch(`/api/proxy/video-cache/uncached?${params.toString()}`);

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `HTTP ${response.status}`);
                }

                // API ì‘ë‹µ: { uncached: [...], uncached_count: N, cached_count: N }
                uncachedItems = result.uncached || [];
                console.log(`ë¯¸ìºì‹œ ${result.uncached_count || uncachedItems.length}ê°œ, ìºì‹œë¨ ${result.cached_count || 0}ê°œ`);
                renderUncachedList();

            } catch (error) {
                console.error('ë¯¸ìºì‹œ í•­ëª© ì¡°íšŒ ì˜¤ë¥˜:', error);
                alert('ì¡°íšŒ ì‹¤íŒ¨: ' + error.message);
            } finally {
                document.getElementById('queryUncachedBtn').disabled = false;
                document.getElementById('queryUncachedBtn').textContent = 'ğŸ” ë¯¸ìºì‹œ í•­ëª© ì¡°íšŒ';
            }
        }

        // ë¯¸ìºì‹œ í•­ëª© ëª©ë¡ ë Œë”ë§
        function renderUncachedList() {
            const listEl = document.getElementById('uncachedList');
            const emptyEl = document.getElementById('uncachedListEmpty');
            const actionsEl = document.getElementById('uncachedActions');
            const countEl = document.getElementById('uncachedCount');

            countEl.textContent = `${uncachedItems.length}ê°œ`;

            if (uncachedItems.length === 0) {
                listEl.style.display = 'none';
                emptyEl.style.display = 'block';
                emptyEl.innerHTML = '<p style="color: #4caf50; text-align: center; padding: 40px;">ğŸ‰ ëª¨ë“  í•­ëª©ì´ ìºì‹œë˜ì–´ ìˆìŠµë‹ˆë‹¤!</p>';
                actionsEl.style.display = 'none';
                return;
            }

            emptyEl.style.display = 'none';
            listEl.style.display = 'block';
            actionsEl.style.display = 'block';

            listEl.innerHTML = uncachedItems.map((item, index) => {
                const isIdle = item.text === 'IDLE_VIDEO_PLACEHOLDER_LOOP';
                return `
                <div class="batch-item" id="uncachedItem${index}" ${isIdle ? 'style="background:#2a2a3a;"' : ''}>
                    <div class="number">${index + 1}</div>
                    <div class="info">
                        <div class="text">${isIdle ? '<span style="color:#888;">IDLE (idle_short.mp4 ì—…ë¡œë“œ)</span>' : escapeHtml(item.text)}</div>
                        <div class="meta" id="uncachedMeta${index}">${item.category || ''} ${item.job_name ? 'â€¢ ' + item.job_name : ''}</div>
                    </div>
                    <div class="actions" id="uncachedActions${index}">
                        <button class="primary" style="width:auto;padding:6px 12px;font-size:0.8em;" onclick="recordSingleUncached(${index})">${isIdle ? 'ì—…ë¡œë“œ' : 'ë…¹í™”'}</button>
                    </div>
                </div>`;
            }).join('');
        }

        // ë‹¨ì¼ ë¯¸ìºì‹œ í•­ëª© ë…¹í™”
        async function recordSingleUncached(index) {
            const item = uncachedItems[index];
            if (!item) return;

            // í•´ë‹¹ í•­ëª©ë§Œ ë…¹í™” (ìë™ ì§„í–‰ ì—†ìŒ)
            uncachedRunning = false;  // ìë™ ì§„í–‰ ë¹„í™œì„±í™”
            uncachedBatchMode = true;  // ì—…ë¡œë“œ ë¡œì§ ì‚¬ìš©
            uncachedCurrentIndex = index;
            uncachedResults = new Array(uncachedItems.length).fill(null);

            updateUncachedItemStatus(index, 'processing', 'ë…¹í™” ì¤‘...');

            await processUncachedItem(index);
        }

        // ì „ì²´ ë¯¸ìºì‹œ í•­ëª© ë…¹í™” ì‹œì‘
        async function recordAllUncached() {
            if (uncachedItems.length === 0) {
                alert('ë…¹í™”í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            uncachedRunning = true;
            uncachedBatchMode = true;  // ë°°ì¹˜ ëª¨ë“œ í™œì„±í™”
            uncachedCurrentIndex = 0;
            uncachedResults = new Array(uncachedItems.length).fill(null);

            document.getElementById('recordAllBtn').disabled = true;
            document.getElementById('stopRecordingBtn').disabled = false;
            document.getElementById('uncachedBatchProgress').classList.add('active');

            // ëª¨ë“  í•­ëª© ëŒ€ê¸° ìƒíƒœë¡œ ì´ˆê¸°í™”
            uncachedItems.forEach((item, index) => {
                updateUncachedItemStatus(index, '', 'ëŒ€ê¸° ì¤‘');
            });

            updateUncachedProgress();
            processNextUncachedItem();
        }

        // ë¯¸ìºì‹œ ë…¹í™” ì¤‘ì§€
        function stopUncachedRecording() {
            uncachedRunning = false;
            document.getElementById('stopRecordingBtn').disabled = true;
            document.getElementById('uncachedProgressStatus').textContent = 'ì¤‘ì§€ ìš”ì²­ë¨... í˜„ì¬ ì‘ì—… ì™„ë£Œ í›„ ì¤‘ì§€ë©ë‹ˆë‹¤.';
        }

        // ë‹¤ìŒ ë¯¸ìºì‹œ í•­ëª© ì²˜ë¦¬
        async function processNextUncachedItem() {
            if (!uncachedRunning || uncachedCurrentIndex >= uncachedItems.length) {
                // ì¤‘ì§€ë˜ì—ˆê±°ë‚˜ ì™„ë£Œëœ ê²½ìš°
                if (uncachedBatchMode) {
                    finishUncachedRecording();
                }
                return;
            }
            await processUncachedItem(uncachedCurrentIndex);
        }

        // ë¯¸ìºì‹œ í•­ëª© ì²˜ë¦¬
        async function processUncachedItem(index) {
            const item = uncachedItems[index];
            const text = item.text;
            const isIdlePlaceholder = (text === 'IDLE_VIDEO_PLACEHOLDER_LOOP');

            updateUncachedItemStatus(index, 'processing', 'ìš”ì²­ ì¤‘...');

            try {
                if (isIdlePlaceholder) {
                    // IDLE_VIDEO_PLACEHOLDER_LOOP: idle_short.mp4ë¥¼ ì§ì ‘ ìºì‹œì— ì—…ë¡œë“œ (TTS/ë¦½ì‹±í¬ ë¶ˆí•„ìš”)
                    const resolution = document.getElementById('uncachedResolution').value;
                    const idleVideoUrl = `/assets/${resolution}/idle_short.mp4`;

                    updateUncachedItemStatus(index, 'processing', 'idle ì˜ìƒ ì—…ë¡œë“œ ì¤‘...');
                    document.getElementById('uncachedProgressStatus').textContent =
                        `[${index + 1}/${uncachedItems.length}] idle ì˜ìƒ ìºì‹œ ì—…ë¡œë“œ ì¤‘...`;

                    // idle_short.mp4 ë‹¤ìš´ë¡œë“œ
                    let videoBlob;
                    const videoResponse = await fetch(idleVideoUrl);
                    if (!videoResponse.ok) {
                        // í•´ìƒë„ë³„ ê²½ë¡œ ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ ê²½ë¡œ ì‹œë„
                        const fallbackResponse = await fetch('/assets/idle_short.mp4');
                        if (!fallbackResponse.ok) {
                            throw new Error('idle_short.mp4 íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                        }
                        videoBlob = await fallbackResponse.blob();
                    } else {
                        videoBlob = await videoResponse.blob();
                    }

                    // ìºì‹œ ì„œë²„ì— ì§ì ‘ ì—…ë¡œë“œ
                    const source = document.getElementById('uncachedSource').value;
                    const formData = new FormData();
                    formData.append('text', text);
                    formData.append('video', videoBlob, 'video.mp4');
                    formData.append('source', source);

                    const uploadResponse = await fetch('/api/proxy/video-cache/upload', {
                        method: 'POST',
                        body: formData
                    });

                    const uploadResult = await uploadResponse.json();

                    if (!uploadResult.success) {
                        throw new Error(uploadResult.error || 'ìºì‹œ ì—…ë¡œë“œ ì‹¤íŒ¨');
                    }

                    // ì„±ê³µ ì²˜ë¦¬
                    uncachedResults[index] = { success: true, url: idleVideoUrl };
                    updateUncachedItemStatus(index, 'completed', 'ì™„ë£Œ (idle ìºì‹œë¨)');

                    // ë‹¤ìŒ í•­ëª©ìœ¼ë¡œ ì§„í–‰
                    uncachedCurrentIndex++;
                    updateUncachedProgress();

                    if (uncachedCurrentIndex < uncachedItems.length && uncachedRunning) {
                        setTimeout(() => processNextUncachedItem(), 100);
                    } else {
                        finishUncachedRecording();
                    }
                } else {
                    // ì¼ë°˜ ë¯¸ìºì‹œ: TTS + ë¦½ì‹±í¬ ë…¹í™” í›„ ì—…ë¡œë“œ
                    const avatarPath = 'auto';
                    const ttsEngine = document.getElementById('uncachedTtsEngine').value;
                    const ttsVoice = document.getElementById('uncachedTtsVoice').value;
                    const resolution = document.getElementById('uncachedResolution').value;

                    const response = await fetch('/api/record', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            text: text,
                            avatar_path: avatarPath,
                            tts_engine: ttsEngine,
                            tts_voice: ttsVoice,
                            resolution: resolution,
                            output_format: 'mp4',
                            frame_skip: 1,
                            filename: `uncached_${String(index + 1).padStart(3, '0')}`,
                            sid: clientSid
                        })
                    });

                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.error || 'ìš”ì²­ ì‹¤íŒ¨');
                    }
                    // ë¦½ì‹±í¬ ëª¨ë“œëŠ” socket 'complete' ì´ë²¤íŠ¸ì—ì„œ ë‹¤ìŒ ì²˜ë¦¬
                }

            } catch (error) {
                const detailedError = `[API ìš”ì²­] ${error.message}`;
                console.error(`[ë°°ì¹˜ ì˜¤ë¥˜] í•­ëª© ${index + 1}: ${detailedError}`);

                uncachedResults[index] = {
                    success: false,
                    error: detailedError
                };
                updateUncachedItemStatus(index, 'error', detailedError);

                if (uncachedBatchMode) {
                    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                    updateUncachedProgress();

                    // ë°°ì¹˜ ì¤‘ì§€ (ë‹¤ìŒ í•­ëª©ìœ¼ë¡œ ì§„í–‰í•˜ì§€ ì•ŠìŒ)
                    document.getElementById('uncachedProgressStatus').textContent =
                        `âŒ ì˜¤ë¥˜ë¡œ ì¤‘ì§€ë¨: ${detailedError}`;
                    console.error(`[ë°°ì¹˜ ì¤‘ì§€] í•­ëª© ${index + 1}ì—ì„œ API ì˜¤ë¥˜ ë°œìƒ`);
                    finishUncachedRecording();
                }
            }
        }

        // ë¯¸ìºì‹œ í•­ëª© ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateUncachedItemStatus(index, status, message, videoUrl = null) {
            const item = document.getElementById(`uncachedItem${index}`);
            const meta = document.getElementById(`uncachedMeta${index}`);
            const actions = document.getElementById(`uncachedActions${index}`);

            if (!item) return;

            item.className = `batch-item ${status}`;
            if (message) {
                const originalMeta = uncachedItems[index];
                const categoryInfo = originalMeta.category || '';
                const jobInfo = originalMeta.job_name ? 'â€¢ ' + originalMeta.job_name : '';
                meta.textContent = status ? message : `${categoryInfo} ${jobInfo}`;
            }

            if (status === 'completed' && videoUrl) {
                actions.innerHTML = `
                    <button class="btn-play" onclick="playUncachedVideo('${videoUrl}')">â–¶</button>
                    <span style="color: #4caf50; font-size: 0.8em;">âœ“ ìºì‹œë¨</span>
                `;
            } else if (status === 'error') {
                actions.innerHTML = `
                    <button class="primary" style="width:auto;padding:6px 12px;font-size:0.8em;" onclick="recordSingleUncached(${index})">ì¬ì‹œë„</button>
                `;
            } else if (!status) {
                actions.innerHTML = `
                    <button class="primary" style="width:auto;padding:6px 12px;font-size:0.8em;" onclick="recordSingleUncached(${index})">ë…¹í™”</button>
                `;
            }
        }

        // ë¯¸ìºì‹œ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateUncachedProgress() {
            const completed = uncachedResults.filter(r => r !== null).length;
            const total = uncachedItems.length;
            const percent = total > 0 ? (completed / total * 100) : 0;

            document.getElementById('uncachedProgressCount').textContent = `${completed} / ${total}`;
            document.getElementById('uncachedProgressFill').style.width = `${percent}%`;
        }

        // ë¯¸ìºì‹œ ë…¹í™” ì™„ë£Œ
        function finishUncachedRecording() {
            uncachedRunning = false;
            uncachedBatchMode = false;  // ë°°ì¹˜ ëª¨ë“œ í•´ì œ

            document.getElementById('recordAllBtn').disabled = false;
            document.getElementById('stopRecordingBtn').disabled = true;

            const successCount = uncachedResults.filter(r => r && r.success).length;
            const errorCount = uncachedResults.filter(r => r && !r.success).length;

            document.getElementById('uncachedProgressStatus').textContent =
                `ì™„ë£Œ! ì„±ê³µ: ${successCount}ê°œ, ì‹¤íŒ¨: ${errorCount}ê°œ`;
        }

        // ë¯¸ìºì‹œ ë¹„ë””ì˜¤ ì¬ìƒ
        function playUncachedVideo(url) {
            // ì „ì²´ URLì¸ ê²½ìš° ìƒëŒ€ ê²½ë¡œë¡œ ë³€í™˜ (CORS ìš°íšŒ)
            let localUrl = url;
            if (url.includes('://')) {
                const urlObj = new URL(url);
                localUrl = urlObj.pathname;  // /video/xxx.mp4
            }

            const previewVideo = document.getElementById('previewVideo');
            previewVideo.src = localUrl + '?' + Date.now();
            previewVideo.load();
            previewVideo.play();

            // ë…¹í™” íƒ­ìœ¼ë¡œ ì „í™˜
            switchTab('single');
            currentVideoUrl = localUrl;
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('copyUrlBtn').disabled = false;
        }

        // ìºì‹œ ì„œë²„ì— ì—…ë¡œë“œ (ì„±ê³µ/ì‹¤íŒ¨ ë°˜í™˜)
        async function uploadToCache(text, videoUrl) {
            const source = document.getElementById('uncachedSource').value;

            try {
                // LIPSYNC_BASE_URLì´ ì„¤ì •ëœ ê²½ìš° ì „ì²´ URLì´ ë°˜í™˜ë¨
                // ë¡œì»¬ì—ì„œ fetchí•˜ë ¤ë©´ ìƒëŒ€ ê²½ë¡œë¡œ ë³€í™˜ í•„ìš”
                let localVideoUrl = videoUrl;
                if (videoUrl.includes('://')) {
                    // ì „ì²´ URLì¸ ê²½ìš° /video/... ë¶€ë¶„ë§Œ ì¶”ì¶œ
                    const urlObj = new URL(videoUrl);
                    localVideoUrl = urlObj.pathname;  // /video/xxx.mp4
                }

                console.log(`ìºì‹œ ì—…ë¡œë“œ ì‹œì‘: ${text.substring(0, 20)}... â†’ ${localVideoUrl}`);

                // ë¹„ë””ì˜¤ íŒŒì¼ ë‹¤ìš´ë¡œë“œ (ë¡œì»¬ ì„œë²„ì—ì„œ)
                const videoResponse = await fetch(localVideoUrl);
                if (!videoResponse.ok) {
                    throw new Error(`ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${videoResponse.status}`);
                }
                const videoBlob = await videoResponse.blob();
                console.log(`ë¹„ë””ì˜¤ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ${videoBlob.size} bytes`);

                // FormData ìƒì„±
                const formData = new FormData();
                formData.append('text', text);
                formData.append('video', videoBlob, 'video.mp4');
                formData.append('source', source);

                // ë¡œì»¬ í”„ë¡ì‹œ ì‚¬ìš© (CORS ìš°íšŒ)
                const response = await fetch('/api/proxy/video-cache/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    console.log('ìºì‹œ ì—…ë¡œë“œ ì„±ê³µ:', result.cache_key);
                    return { success: true, cache_key: result.cache_key };
                } else {
                    console.warn('ìºì‹œ ì—…ë¡œë“œ ì‹¤íŒ¨:', result.error);
                    return { success: false, error: result.error };
                }

            } catch (error) {
                console.error('ìºì‹œ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                return { success: false, error: error.message };
            }
        }

        // === ë‹¨ì¼ ë…¹í™” í•¨ìˆ˜ë“¤ ===

        // ì˜ˆì‹œ í…ìŠ¤íŠ¸ ì„ íƒ
        function selectExampleText() {
            const select = document.getElementById('exampleTextSelect');
            const textarea = document.getElementById('scriptInput');
            if (select.value) {
                textarea.value = select.value;
                textarea.focus();
                // ê¸€ì ìˆ˜ ì—…ë°ì´íŠ¸
                document.getElementById('charCount').textContent = `${select.value.length} / 1000ì`;
                // ì„ íƒ í›„ ë“œë¡­ë‹¤ìš´ ì´ˆê¸°í™”
                select.selectedIndex = 0;
            }
        }

        async function generateVideo() {
            const text = document.getElementById('scriptInput').value.trim();
            if (!text) {
                alert('ëŒ€ì‚¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (text.length > 1000) {
                alert('í…ìŠ¤íŠ¸ê°€ ë„ˆë¬´ ê¹ë‹ˆë‹¤. 1000ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const avatarPath = 'auto';  // ìë™ ì„ íƒ
            const ttsEngine = document.getElementById('ttsEngineSelect').value;
            const ttsVoice = document.getElementById('ttsVoiceSelect').value;
            const resolution = document.getElementById('resolutionSelect').value;
            const outputFormat = document.getElementById('formatSelect').value;
            const frameSkip = parseInt(document.getElementById('frameSkipSelect').value);
            const filename = document.getElementById('filenameInput').value.trim();

            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateBtn').textContent = 'ìƒì„± ì¤‘...';
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('statusText').textContent = 'ìš”ì²­ ì¤‘...';

            try {
                const response = await fetch('/api/record', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        avatar_path: avatarPath,
                        tts_engine: ttsEngine,
                        tts_voice: ttsVoice,
                        resolution: resolution,
                        output_format: outputFormat,
                        frame_skip: frameSkip,
                        filename: filename || null,
                        sid: clientSid
                    })
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'ìš”ì²­ ì‹¤íŒ¨');
                }

            } catch (error) {
                console.error('ìƒì„± ì˜¤ë¥˜:', error);
                document.getElementById('statusText').textContent = 'ì˜¤ë¥˜: ' + error.message;
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('generateBtn').textContent = 'ğŸ¬ ì˜ìƒ ìƒì„±';
            }
        }

        function addVideoToList(data) {
            const videoList = document.getElementById('videoList');

            if (generatedVideos.length === 0) {
                videoList.innerHTML = '';
            }

            const videoInfo = {
                url: data.video_url,
                time: new Date().toLocaleTimeString(),
                duration: data.elapsed ? data.elapsed.toFixed(1) + 'ì´ˆ' : '-'
            };
            generatedVideos.unshift(videoInfo);

            const item = document.createElement('div');
            item.className = 'video-item';
            item.innerHTML = `
                <div class="info">
                    <div class="name">ì˜ìƒ ${generatedVideos.length}</div>
                    <div class="meta">${videoInfo.time} â€¢ ${videoInfo.duration}</div>
                </div>
                <div class="actions">
                    <button class="btn-play" onclick="playVideo('${videoInfo.url}')">â–¶</button>
                    <button class="btn-download" onclick="downloadVideoUrl('${videoInfo.url}')">ğŸ“¥</button>
                </div>
            `;
            videoList.insertBefore(item, videoList.firstChild);
        }

        function playVideo(url) {
            const previewVideo = document.getElementById('previewVideo');
            previewVideo.src = url + '?' + Date.now();
            previewVideo.loop = false;  // ìƒˆ ì˜ìƒ ë¡œë“œì‹œ ë°˜ë³µ ì´ˆê¸°í™”
            isLooping = false;  // ë°˜ë³µ ìƒíƒœ ì´ˆê¸°í™”
            previewVideo.load();
            previewVideo.play();
            currentVideoUrl = url;
            document.getElementById('downloadBtn').disabled = false;
            document.getElementById('copyUrlBtn').disabled = false;
            document.getElementById('loopBtn').disabled = false;
            // ë°˜ë³µ ë²„íŠ¼ ìƒíƒœ ì´ˆê¸°í™”
            const loopBtn = document.getElementById('loopBtn');
            loopBtn.textContent = 'ğŸ” ë°˜ë³µ ì¬ìƒ';
            loopBtn.style.background = '';
            loopBtn.style.color = '';
        }

        function downloadVideo() {
            if (currentVideoUrl) {
                downloadVideoUrl(currentVideoUrl);
            }
        }

        async function downloadVideoUrl(url) {
            // ë‹¤ìš´ë¡œë“œ ì „ì— íŒŒì¼ì„ ì˜êµ¬ ì €ì¥ (ìë™ ì •ë¦¬ ë°©ì§€)
            try {
                await fetch('/api/video/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ video_url: url })
                });
            } catch (e) {
                console.warn('íŒŒì¼ ì €ì¥ ì‹¤íŒ¨ (ë‹¤ìš´ë¡œë“œëŠ” ê³„ì†):', e);
            }

            const ext = url.includes('.webm') ? '.webm' : '.mp4';
            const a = document.createElement('a');
            a.href = url;
            a.download = 'avatar_video_' + Date.now() + ext;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function copyVideoUrl() {
            if (currentVideoUrl) {
                const fullUrl = window.location.origin + currentVideoUrl;
                navigator.clipboard.writeText(fullUrl).then(() => {
                    const btn = document.getElementById('copyUrlBtn');
                    btn.textContent = 'âœ“ ë³µì‚¬ë¨';
                    setTimeout(() => {
                        btn.textContent = 'ğŸ”— URL ë³µì‚¬';
                    }, 2000);
                });
            }
        }

        function toggleLoop() {
            const video = document.getElementById('previewVideo');
            const btn = document.getElementById('loopBtn');
            isLooping = !isLooping;
            video.loop = isLooping;

            if (isLooping) {
                btn.textContent = 'ğŸ” ë°˜ë³µ ì¤‘';
                btn.style.background = '#4ecca3';
                btn.style.color = '#1a1a2e';
            } else {
                btn.textContent = 'ğŸ” ë°˜ë³µ ì¬ìƒ';
                btn.style.background = '';
                btn.style.color = '';
            }
            console.log('Loop toggled:', isLooping);
        }

        // ë¹„ë””ì˜¤ ì¢…ë£Œ ì‹œ ë°˜ë³µ ì¬ìƒ ì²˜ë¦¬ (video.loop ì†ì„± ë°±ì—…)
        document.addEventListener('DOMContentLoaded', function() {
            const video = document.getElementById('previewVideo');
            video.addEventListener('ended', function() {
                if (isLooping) {
                    video.currentTime = 0;
                    video.play();
                }
            });
        });

        // ========== ìºì‹œ ì—…ë¡œë“œ ê¸°ëŠ¥ (ë‹¨ì¼ ë…¹í™” íƒ­) ==========

        let selectedFile = null;

        // ì—…ë¡œë“œ ì„¹ì…˜ ì´ˆê¸°í™”
        function initUploadSection() {
            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì„¤ì •
            const dropZone = document.getElementById('fileDropZone');
            if (!dropZone) return;

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelection(files[0]);
                }
            });
        }

        // íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFileSelection(file);
            }
        }

        function handleFileSelection(file) {
            // íŒŒì¼ ìœ í˜• ê²€ì¦
            if (!file.type.match(/video\/(mp4|webm)/)) {
                alert('MP4 ë˜ëŠ” WebM íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            // íŒŒì¼ í¬ê¸° ê²€ì¦ (100MB)
            const maxSize = 100 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('íŒŒì¼ í¬ê¸°ê°€ 100MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.');
                return;
            }

            selectedFile = file;

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('fileDropZone').style.display = 'none';
            document.getElementById('selectedFile').style.display = 'flex';
            document.getElementById('selectedFileName').textContent = file.name;
            document.getElementById('selectedFileSize').textContent = formatFileSize(file.size);
        }

        function clearFileSelection() {
            selectedFile = null;
            document.getElementById('uploadVideoFile').value = '';
            document.getElementById('fileDropZone').style.display = 'block';
            document.getElementById('selectedFile').style.display = 'none';
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ìºì‹œì— ì—…ë¡œë“œ (ë‹¨ì¼ ë…¹í™” íƒ­)
        async function uploadVideoToCache() {
            const text = document.getElementById('uploadText').value.trim();
            const source = document.getElementById('uploadSource').value;

            // ê²€ì¦
            if (!text) {
                alert('ìºì‹œí•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                document.getElementById('uploadText').focus();
                return;
            }

            if (!selectedFile) {
                alert('ë¹„ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('uploadBtn').disabled = true;
            document.getElementById('uploadBtn').textContent = 'ì—…ë¡œë“œ ì¤‘...';
            document.getElementById('uploadProgressContainer').style.display = 'block';
            document.getElementById('uploadProgressFill').style.width = '0%';
            document.getElementById('uploadStatusText').textContent = 'ì—…ë¡œë“œ ì¤€ë¹„ ì¤‘...';

            try {
                // FormData ìƒì„±
                const formData = new FormData();
                formData.append('text', text);
                formData.append('video', selectedFile);
                formData.append('source', source);

                // XMLHttpRequestë¡œ ì—…ë¡œë“œ (ì§„í–‰ë¥  ì¶”ì )
                const xhr = new XMLHttpRequest();

                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 100);
                        document.getElementById('uploadProgressFill').style.width = percent + '%';
                        document.getElementById('uploadProgressPercent').textContent = percent + '%';
                        document.getElementById('uploadStatusText').textContent =
                            percent < 100 ? 'ì—…ë¡œë“œ ì¤‘...' : 'ì„œë²„ ì²˜ë¦¬ ì¤‘...';
                    }
                });

                const result = await new Promise((resolve, reject) => {
                    xhr.onload = () => {
                        if (xhr.status >= 200 && xhr.status < 300) {
                            try {
                                resolve(JSON.parse(xhr.responseText));
                            } catch (e) {
                                reject(new Error('ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜'));
                            }
                        } else {
                            try {
                                const err = JSON.parse(xhr.responseText);
                                reject(new Error(err.error || `HTTP ${xhr.status}`));
                            } catch (e) {
                                reject(new Error(`HTTP ${xhr.status}`));
                            }
                        }
                    };
                    xhr.onerror = () => reject(new Error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜'));
                    xhr.ontimeout = () => reject(new Error('ìš”ì²­ ì‹œê°„ ì´ˆê³¼'));

                    // ë¡œì»¬ í”„ë¡ì‹œ ì‚¬ìš© (CORS ìš°íšŒ)
                    xhr.open('POST', '/api/proxy/video-cache/upload');
                    xhr.timeout = 300000; // 5ë¶„
                    xhr.send(formData);
                });

                if (result.success) {
                    // ì„±ê³µ
                    document.getElementById('uploadProgressFill').style.width = '100%';
                    document.getElementById('uploadStatusText').textContent = `âœ… ìºì‹œ ì™„ë£Œ: ${result.cache_key || ''}`;

                    // ì…ë ¥ ì´ˆê¸°í™”
                    document.getElementById('uploadText').value = '';
                    clearFileSelection();

                    alert('ìºì‹œ ì—…ë¡œë“œ ì™„ë£Œ!\nìºì‹œ í‚¤: ' + (result.cache_key || '-'));

                } else {
                    throw new Error(result.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨');
                }

            } catch (error) {
                console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('uploadStatusText').textContent = 'ì˜¤ë¥˜: ' + error.message;
                document.getElementById('uploadProgressFill').style.width = '0%';
                alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);

            } finally {
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('uploadBtn').textContent = 'ğŸ“¤ ì—…ë¡œë“œ';

                setTimeout(() => {
                    document.getElementById('uploadProgressContainer').style.display = 'none';
                }, 3000);
            }
        }

        // í´ë¦½ë³´ë“œ ë³µì‚¬
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                console.log('í´ë¦½ë³´ë“œì— ë³µì‚¬ë¨:', text);
            }).catch(err => {
                console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
            });
        }

        // ========== ìŒì„± ë¯¸ìºì‹œ ê¸°ëŠ¥ ==========

        // ìŒì„± ë¯¸ìºì‹œìš© ìŒì„± ì˜µì…˜ ì—…ë°ì´íŠ¸
        function updateAudioUncachedVoiceOptions() {
            const engineId = document.getElementById('audioUncachedTtsEngine').value;
            const voiceSelect = document.getElementById('audioUncachedTtsVoice');
            updateVoiceSelect(engineId, voiceSelect);
        }

        // ìŒì„± ë¯¸ìºì‹œ í•­ëª© ì¡°íšŒ
        async function queryAudioUncachedItems() {
            const category = document.getElementById('audioUncachedCategory').value;

            // URL íŒŒë¼ë¯¸í„° êµ¬ì„±
            const params = new URLSearchParams();
            if (category) params.append('category', category);

            document.getElementById('queryAudioUncachedBtn').disabled = true;
            document.getElementById('queryAudioUncachedBtn').textContent = 'ì¡°íšŒ ì¤‘...';

            try {
                // ë¡œì»¬ í”„ë¡ì‹œ ì‚¬ìš© (CORS ìš°íšŒ)
                const response = await fetch(`/api/proxy/audio-cache/uncached?${params.toString()}`);

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `HTTP ${response.status}`);
                }

                // API ì‘ë‹µ: { uncached: [...], uncached_count: N, cached_count: N }
                audioUncachedItems = result.uncached || [];
                console.log(`ìŒì„± ë¯¸ìºì‹œ ${result.uncached_count || audioUncachedItems.length}ê°œ, ìºì‹œë¨ ${result.cached_count || 0}ê°œ`);
                renderAudioUncachedList();

            } catch (error) {
                console.error('ìŒì„± ë¯¸ìºì‹œ í•­ëª© ì¡°íšŒ ì˜¤ë¥˜:', error);
                alert('ì¡°íšŒ ì‹¤íŒ¨: ' + error.message);
            } finally {
                document.getElementById('queryAudioUncachedBtn').disabled = false;
                document.getElementById('queryAudioUncachedBtn').textContent = 'ğŸ” ìŒì„± ë¯¸ìºì‹œ í•­ëª© ì¡°íšŒ';
            }
        }

        // ìŒì„± ë¯¸ìºì‹œ í•­ëª© ëª©ë¡ ë Œë”ë§
        function renderAudioUncachedList() {
            const listEl = document.getElementById('audioUncachedList');
            const emptyEl = document.getElementById('audioUncachedListEmpty');
            const actionsEl = document.getElementById('audioUncachedActions');
            const countEl = document.getElementById('audioUncachedCount');

            countEl.textContent = `${audioUncachedItems.length}ê°œ`;

            if (audioUncachedItems.length === 0) {
                listEl.style.display = 'none';
                emptyEl.style.display = 'block';
                emptyEl.innerHTML = '<p style="color: #4caf50; text-align: center; padding: 40px;">ğŸ‰ ëª¨ë“  ìŒì„±ì´ ìºì‹œë˜ì–´ ìˆìŠµë‹ˆë‹¤!</p>';
                actionsEl.style.display = 'none';
                return;
            }

            emptyEl.style.display = 'none';
            listEl.style.display = 'block';
            actionsEl.style.display = 'block';

            listEl.innerHTML = audioUncachedItems.map((item, index) => {
                return `
                <div class="batch-item" id="audioUncachedItem${index}">
                    <div class="number">${index + 1}</div>
                    <div class="info">
                        <div class="text">${escapeHtml(item.text)}</div>
                        <div class="meta" id="audioUncachedMeta${index}">${item.category || ''}</div>
                    </div>
                    <div class="actions" id="audioUncachedActions${index}">
                        <button class="primary" style="width:auto;padding:6px 12px;font-size:0.8em;" onclick="recordSingleAudioUncached(${index})">ğŸ¤ ë…¹ìŒ</button>
                    </div>
                </div>`;
            }).join('');
        }

        // ë‹¨ì¼ ìŒì„± ë¯¸ìºì‹œ í•­ëª© ë…¹ìŒ
        async function recordSingleAudioUncached(index) {
            const item = audioUncachedItems[index];
            if (!item) return;

            // í•´ë‹¹ í•­ëª©ë§Œ ë…¹ìŒ (ìë™ ì§„í–‰ ì—†ìŒ)
            audioUncachedRunning = false;  // ìë™ ì§„í–‰ ë¹„í™œì„±í™”
            audioUncachedBatchMode = true;  // ì—…ë¡œë“œ ë¡œì§ ì‚¬ìš©
            audioUncachedCurrentIndex = index;
            audioUncachedResults = new Array(audioUncachedItems.length).fill(null);

            updateAudioUncachedItemStatus(index, 'processing', 'ë…¹ìŒ ì¤‘...');

            await processAudioUncachedItem(index);
        }

        // ì „ì²´ ìŒì„± ë¯¸ìºì‹œ í•­ëª© ë…¹ìŒ ì‹œì‘
        async function recordAllAudioUncached() {
            if (audioUncachedItems.length === 0) {
                alert('ë…¹ìŒí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            audioUncachedRunning = true;
            audioUncachedBatchMode = true;
            audioUncachedCurrentIndex = 0;
            audioUncachedResults = new Array(audioUncachedItems.length).fill(null);

            document.getElementById('recordAllAudioBtn').disabled = true;
            document.getElementById('stopAudioRecordingBtn').disabled = false;
            document.getElementById('audioUncachedBatchProgress').classList.add('active');

            // ëª¨ë“  í•­ëª© ëŒ€ê¸° ìƒíƒœë¡œ ì´ˆê¸°í™”
            audioUncachedItems.forEach((item, index) => {
                updateAudioUncachedItemStatus(index, '', 'ëŒ€ê¸° ì¤‘');
            });

            updateAudioUncachedProgress();
            processNextAudioUncachedItem();
        }

        // ìŒì„± ë¯¸ìºì‹œ ë…¹ìŒ ì¤‘ì§€
        function stopAudioUncachedRecording() {
            audioUncachedRunning = false;
            document.getElementById('stopAudioRecordingBtn').disabled = true;
            document.getElementById('audioUncachedProgressStatus').textContent = 'ì¤‘ì§€ ìš”ì²­ë¨... í˜„ì¬ ì‘ì—… ì™„ë£Œ í›„ ì¤‘ì§€ë©ë‹ˆë‹¤.';
        }

        // ë‹¤ìŒ ìŒì„± ë¯¸ìºì‹œ í•­ëª© ì²˜ë¦¬
        async function processNextAudioUncachedItem() {
            if (!audioUncachedRunning || audioUncachedCurrentIndex >= audioUncachedItems.length) {
                if (audioUncachedBatchMode) {
                    finishAudioUncachedRecording();
                }
                return;
            }
            await processAudioUncachedItem(audioUncachedCurrentIndex);
        }

        // ìŒì„± ë¯¸ìºì‹œ í•­ëª© ì²˜ë¦¬ (TTS ìƒì„± + ì—…ë¡œë“œ)
        async function processAudioUncachedItem(index) {
            const item = audioUncachedItems[index];
            const text = item.text;
            const category = item.category || '';

            updateAudioUncachedItemStatus(index, 'processing', 'TTS ìƒì„± ì¤‘...');
            document.getElementById('audioUncachedProgressStatus').textContent =
                `[${index + 1}/${audioUncachedItems.length}] TTS ìƒì„± ì¤‘...`;

            try {
                const ttsEngine = document.getElementById('audioUncachedTtsEngine').value;
                const ttsVoice = document.getElementById('audioUncachedTtsVoice').value;

                // TTS API í˜¸ì¶œ
                const ttsResponse = await fetch('/api/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        engine: ttsEngine,
                        voice: ttsVoice
                    })
                });

                if (!ttsResponse.ok) {
                    const error = await ttsResponse.json();
                    throw new Error(error.error || `TTS ì‹¤íŒ¨: HTTP ${ttsResponse.status}`);
                }

                const ttsResult = await ttsResponse.json();

                if (!ttsResult.success || !ttsResult.audio_url) {
                    throw new Error(ttsResult.error || 'TTS ì‘ë‹µì— audio_url ì—†ìŒ');
                }

                console.log(`[ìŒì„± ë…¹ìŒ] TTS ì„±ê³µ: ${ttsResult.audio_url}`);

                // ìŒì„± íŒŒì¼ ë‹¤ìš´ë¡œë“œ
                updateAudioUncachedItemStatus(index, 'processing', 'ìŒì„± ë‹¤ìš´ë¡œë“œ ì¤‘...');

                let audioUrl = ttsResult.audio_url;
                // ìƒëŒ€ ê²½ë¡œë¡œ ë³€í™˜
                if (audioUrl.includes('://')) {
                    const urlObj = new URL(audioUrl);
                    audioUrl = urlObj.pathname;
                }

                const audioResponse = await fetch(audioUrl);
                if (!audioResponse.ok) {
                    throw new Error(`ìŒì„± ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: ${audioResponse.status}`);
                }
                const audioBlob = await audioResponse.blob();
                console.log(`[ìŒì„± ë…¹ìŒ] ë‹¤ìš´ë¡œë“œ ì™„ë£Œ: ${audioBlob.size} bytes`);

                // ë¯¸ë¦¬ë“£ê¸° ì—…ë°ì´íŠ¸
                const audioPreview = document.getElementById('audioPreview');
                audioPreview.src = URL.createObjectURL(audioBlob);

                // ìºì‹œ ì„œë²„ì— ì—…ë¡œë“œ
                updateAudioUncachedItemStatus(index, 'processing', 'ìºì‹œ ì—…ë¡œë“œ ì¤‘...');
                document.getElementById('audioUncachedProgressStatus').textContent =
                    `[${index + 1}/${audioUncachedItems.length}] ìºì‹œ ì—…ë¡œë“œ ì¤‘...`;

                const formData = new FormData();
                formData.append('text', text);
                formData.append('audio', audioBlob, 'audio.mp3');
                if (category) formData.append('category', category);

                const uploadResponse = await fetch('/api/proxy/audio-cache/upload', {
                    method: 'POST',
                    body: formData
                });

                const uploadResult = await uploadResponse.json();

                if (!uploadResult.success) {
                    throw new Error(uploadResult.error || 'ìºì‹œ ì—…ë¡œë“œ ì‹¤íŒ¨');
                }

                // ì„±ê³µ ì²˜ë¦¬ - ì˜¤ë””ì˜¤ URL ì €ì¥
                audioUncachedResults[index] = { success: true, audioUrl: audioUrl };
                updateAudioUncachedItemStatus(index, 'completed', 'ì™„ë£Œ (ìºì‹œë¨)', audioUrl);

                // ë‹¤ìŒ í•­ëª©ìœ¼ë¡œ ì§„í–‰
                audioUncachedCurrentIndex++;
                updateAudioUncachedProgress();

                if (audioUncachedCurrentIndex < audioUncachedItems.length && audioUncachedRunning) {
                    setTimeout(() => processNextAudioUncachedItem(), 300);
                } else {
                    finishAudioUncachedRecording();
                }

            } catch (error) {
                const detailedError = error.message;
                console.error(`[ìŒì„± ë°°ì¹˜ ì˜¤ë¥˜] í•­ëª© ${index + 1}: ${detailedError}`);

                audioUncachedResults[index] = {
                    success: false,
                    error: detailedError
                };
                updateAudioUncachedItemStatus(index, 'error', detailedError);

                if (audioUncachedBatchMode) {
                    updateAudioUncachedProgress();

                    // ë°°ì¹˜ ì¤‘ì§€ (ë‹¤ìŒ í•­ëª©ìœ¼ë¡œ ì§„í–‰í•˜ì§€ ì•ŠìŒ)
                    document.getElementById('audioUncachedProgressStatus').textContent =
                        `âŒ ì˜¤ë¥˜ë¡œ ì¤‘ì§€ë¨: ${detailedError}`;
                    console.error(`[ìŒì„± ë°°ì¹˜ ì¤‘ì§€] í•­ëª© ${index + 1}ì—ì„œ ì˜¤ë¥˜ ë°œìƒ`);
                    finishAudioUncachedRecording();
                }
            }
        }

        // ìŒì„± ë¯¸ìºì‹œ í•­ëª© ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateAudioUncachedItemStatus(index, status, message, audioUrl = null) {
            const item = document.getElementById(`audioUncachedItem${index}`);
            const meta = document.getElementById(`audioUncachedMeta${index}`);
            const actions = document.getElementById(`audioUncachedActions${index}`);

            if (!item) return;

            item.className = `batch-item ${status}`;
            if (message) {
                const originalMeta = audioUncachedItems[index];
                const categoryInfo = originalMeta.category || '';
                meta.textContent = status ? message : categoryInfo;
            }

            if (status === 'completed') {
                // audioUrlì´ ìˆìœ¼ë©´ ì¬ìƒ ë²„íŠ¼ í‘œì‹œ
                if (audioUrl) {
                    actions.innerHTML = `
                        <button class="btn-play" style="width:auto;padding:6px 12px;font-size:0.8em;" onclick="playAudioUncached('${audioUrl}')">â–¶ï¸</button>
                        <span style="color: #4caf50; font-size: 0.8em;">âœ“ ìºì‹œë¨</span>
                    `;
                } else {
                    actions.innerHTML = `
                        <span style="color: #4caf50; font-size: 0.8em;">âœ“ ìºì‹œë¨</span>
                    `;
                }
            } else if (status === 'error') {
                actions.innerHTML = `
                    <button class="primary" style="width:auto;padding:6px 12px;font-size:0.8em;" onclick="recordSingleAudioUncached(${index})">ì¬ì‹œë„</button>
                `;
            } else if (!status) {
                actions.innerHTML = `
                    <button class="primary" style="width:auto;padding:6px 12px;font-size:0.8em;" onclick="recordSingleAudioUncached(${index})">ğŸ¤ ë…¹ìŒ</button>
                `;
            }
        }

        // ìŒì„± ë¯¸ìºì‹œ ì˜¤ë””ì˜¤ ì¬ìƒ
        function playAudioUncached(audioUrl) {
            // ìƒëŒ€ ê²½ë¡œë¡œ ë³€í™˜ (í•„ìš” ì‹œ)
            let localUrl = audioUrl;
            if (audioUrl.includes('://')) {
                const urlObj = new URL(audioUrl);
                localUrl = urlObj.pathname;
            }

            const audioPreview = document.getElementById('audioPreview');
            audioPreview.src = localUrl + '?' + Date.now();
            audioPreview.load();
            audioPreview.play();
        }

        // ìŒì„± ë¯¸ìºì‹œ ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateAudioUncachedProgress() {
            const completed = audioUncachedResults.filter(r => r !== null).length;
            const total = audioUncachedItems.length;
            const percent = total > 0 ? (completed / total * 100) : 0;

            document.getElementById('audioUncachedProgressCount').textContent = `${completed} / ${total}`;
            document.getElementById('audioUncachedProgressFill').style.width = `${percent}%`;
        }

        // ìŒì„± ë¯¸ìºì‹œ ë…¹ìŒ ì™„ë£Œ
        function finishAudioUncachedRecording() {
            audioUncachedRunning = false;
            audioUncachedBatchMode = false;

            document.getElementById('recordAllAudioBtn').disabled = false;
            document.getElementById('stopAudioRecordingBtn').disabled = true;

            const successCount = audioUncachedResults.filter(r => r && r.success).length;
            const errorCount = audioUncachedResults.filter(r => r && !r.success).length;

            document.getElementById('audioUncachedProgressStatus').textContent =
                `ì™„ë£Œ! ì„±ê³µ: ${successCount}ê°œ, ì‹¤íŒ¨: ${errorCount}ê°œ`;
        }
    </script>
</body>
</html>
